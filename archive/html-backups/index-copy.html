<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>RayOS V11.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Inter:wght@400;500;600&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-elevated: #0f0f0f;
            --bg-card: #141414;
            --bg-input: #1a1a1a;
            --text: #e8e8e8;
            --text-dim: #6b6b6b;
            --text-muted: #3a3a3a;
            --accent: #d4c5a9;
            --accent-dim: rgba(212, 197, 169, 0.15);
            --border: #1f1f1f;
            --success: #4a7c59;
            --danger: #e63946;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-tap-highlight-color: transparent; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.5s ease-out; }
        .sync-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle;}
        .sync-dot.on{background:var(--success);box-shadow:0 0 6px var(--success);}
        .sync-dot.off{background:var(--text-muted);}
        
        /* Sidebar */
        .sidebar { width: 200px; background: var(--bg); border-right: 1px solid var(--border); position: fixed; height: 100vh; padding: 32px 0; z-index: 100; }
        .logo { padding: 0 24px 32px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
        .logo-text { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 700; letter-spacing: 2px; color: var(--accent); }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 24px; cursor: pointer; transition: all 0.3s ease; color: var(--text-dim); font-size: 13px; font-weight: 500; }
        .nav-item:hover { color: var(--text); background: var(--bg-elevated); }
        .nav-item.active { color: var(--accent); background: var(--accent-dim); border-right: 2px solid var(--accent); }
        .nav-icon { font-size: 16px; width: 24px; text-align: center; }
        
        /* Main */
        .main { margin-left: 200px; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--bg); position: sticky; top: 0; z-index: 50; }
        .page-title { font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 700; letter-spacing: 4px; color: var(--text-dim); text-transform: uppercase; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease; font-family: inherit; }
        .btn:hover { border-color: var(--text-dim); color: var(--text); }
        .btn-accent { background: var(--accent); border-color: var(--accent); color: var(--bg); }
        .btn-accent:hover { background: #e0d4bc; }
        .btn-small { padding: 6px 12px; font-size: 11px; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        
        /* Sections */
        .section { display: none; }
        .section.active { display: block; }
        .content { padding: 24px 32px; }
        
        /* Moodboard */
        /* Moodboard - Creative Dynamic Grid */
        .moodboard { display: flex; flex-wrap: wrap; gap: 3px; overflow: hidden; }
        .mood-item { overflow: hidden; position: relative; flex-grow: 0; flex-shrink: 0; }
        .mood-item img { width: 100%; height: 100%; display: block; object-fit: cover; filter: brightness(0.6) saturate(0.85); transition: all 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .mood-item:hover img { filter: brightness(0.88) saturate(1.1); transform: scale(1.06); }
        @keyframes moodFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .mood-item { animation: moodFadeIn 0.8s ease-out both; }
        .mood-item:nth-child(2) { animation-delay: 0.08s; }
        .mood-item:nth-child(3) { animation-delay: 0.16s; }
        .mood-item:nth-child(4) { animation-delay: 0.24s; }
        .mood-item:nth-child(5) { animation-delay: 0.32s; }
        .mood-item:nth-child(6) { animation-delay: 0.4s; }
        .mood-item:nth-child(7) { animation-delay: 0.48s; }
        .mood-item:nth-child(8) { animation-delay: 0.56s; }
        .mood-item:nth-child(9) { animation-delay: 0.64s; }
        .mood-item:nth-child(10) { animation-delay: 0.72s; }
        .mood-item:nth-child(11) { animation-delay: 0.8s; }
        .mood-item:nth-child(12) { animation-delay: 0.88s; }
        .moodboard-wrapper { position: relative; }
        .moodboard-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; pointer-events: none; }
        .moodboard-title { font-family: 'Cormorant Garamond', serif; font-size: 56px; font-weight: 700; color: #fff; letter-spacing: 16px; text-shadow: 0 4px 60px rgba(0,0,0,0.9); }
        .moodboard-sub { font-size: 12px; color: rgba(255,255,255,0.6); letter-spacing: 6px; margin-top: 8px; text-transform: uppercase; }
        .moodboard-refresh { position: absolute; top: 12px; right: 12px; z-index: 15; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.6); padding: 6px 12px; font-size: 11px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(4px); font-family: inherit; }
        .moodboard-refresh:hover { background: rgba(0,0,0,0.7); color: #fff; border-color: rgba(255,255,255,0.3); }
        
        /* Stats Row */
        .stats-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; padding: 24px 32px; background: var(--bg-elevated); border-bottom: 1px solid var(--border); }
        .stat-box { text-align: center; padding: 16px; cursor: pointer; transition: all 0.3s; }
        .stat-box:hover { background: var(--bg-card); }
        .stat-value { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 10px; color: var(--text-dim); letter-spacing: 1px; margin-top: 4px; text-transform: uppercase; }
        
        /* Cards */
        .cards { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; cursor: pointer; transition: all 0.3s; }
        .card:hover { border-color: var(--text-muted); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-icon { font-size: 24px; }
        .card-badge { font-size: 9px; color: var(--accent); letter-spacing: 1px; padding: 4px 8px; border: 1px solid var(--accent); }
        .card-title { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 700; }
        .card-desc { font-size: 11px; color: var(--text-dim); margin-top: 6px; }
        .section-label { font-size: 10px; color: var(--text-dim); letter-spacing: 2px; margin-bottom: 16px; text-transform: uppercase; }
        
        /* Wealth Layout */
        .wealth-layout { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
        .wealth-main { display: flex; flex-direction: column; gap: 20px; }
        .wealth-sidebar { display: flex; flex-direction: column; gap: 16px; position: sticky; top: 80px; height: fit-content; }
        
        /* Quote */
        .quote-box { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%); border: 1px solid var(--border); padding: 20px 24px; position: relative; }
        .quote-box::before { content: '"'; position: absolute; top: -20px; left: 10px; font-size: 120px; color: var(--accent); opacity: 0.1; font-family: 'Cormorant Garamond', serif; }
        .quote-text { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-style: italic; color: var(--accent); line-height: 1.6; position: relative; z-index: 1; text-align: center; }
        .quote-author { font-size: 11px; color: var(--text-dim); margin-top: 10px; text-align: center; }
        
        /* Goal */
        .goal-card { background: var(--bg-card); border: 1px solid var(--accent); padding: 20px; }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .goal-label { font-size: 10px; font-weight: 700; color: var(--accent); letter-spacing: 2px; }
        .goal-value { font-family: 'Cormorant Garamond', serif; font-size: 26px; font-weight: 700; }
        .goal-progress { height: 4px; background: var(--border); margin-top: 12px; border-radius: 2px; overflow: hidden; }
        .goal-bar { height: 100%; background: linear-gradient(90deg, var(--accent), #e0d4bc); transition: width 0.8s ease; }
        .goal-info { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--text-dim); }
        
        /* AI Panel */
        .ai-panel { background: linear-gradient(180deg, var(--bg-card) 0%, rgba(20,20,20,0.95) 100%); border: 1px solid var(--accent); position: relative; }
        .ai-header { display: flex; align-items: center; gap: 10px; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .ai-icon { width: 28px; height: 28px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .ai-title { font-size: 13px; font-weight: 600; color: var(--accent); }
        .ai-content { padding: 16px 20px; max-height: 400px; overflow-y: auto; }
        .ai-suggestion { font-size: 13px; line-height: 1.7; color: var(--text-dim); }
        .ai-suggestion strong { color: var(--accent); }
        .ai-suggestion ul { margin: 12px 0; padding-left: 20px; }
        .ai-suggestion li { margin-bottom: 8px; }
        .ai-chat { padding: 12px 20px; border-top: 1px solid var(--border); }
        .ai-input-wrap { display: flex; gap: 8px; }
        .ai-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border); padding: 10px 14px; color: var(--text); font-size: 13px; font-family: inherit; }
        .ai-input:focus { outline: none; border-color: var(--accent); }
        .ai-send { width: 40px; background: var(--accent); border: none; color: var(--bg); cursor: pointer; font-size: 16px; }
        .ai-model-badge { margin-left: auto; font-size: 9px; color: var(--text-muted); letter-spacing: 0.5px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 2px; }
        .ai-msg { padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; line-height: 1.6; }
        .ai-msg.user { color: var(--accent); }
        .ai-msg.assistant { color: var(--text-dim); }
        .ai-msg .ai-role { font-size: 9px; font-weight: 700; letter-spacing: 1px; margin-bottom: 2px; text-transform: uppercase; }
        .ai-loading { display: inline-block; }
        .ai-loading::after { content: ''; animation: dotPulse 1.2s infinite; }
        @keyframes dotPulse { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
        
        /* Summary Grid */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .summary-item { background: var(--bg-card); border: 1px solid var(--border); padding: 16px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .summary-item:hover { border-color: var(--text-muted); }
        .summary-label { font-size: 10px; font-weight: 600; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 6px; text-transform: uppercase; }
        .summary-value { font-family: 'Cormorant Garamond', serif; font-size: 24px; font-weight: 700; }
        .summary-value.positive { color: var(--success); }
        .summary-value.negative { color: var(--danger); }
        .summary-value.accent { color: var(--accent); }
        
        /* Chart */
        .chart-container { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .chart-title { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 700; }
        .chart-tabs { display: flex; gap: 6px; flex-wrap: wrap; }
        .chart-tab { padding: 6px 12px; font-size: 10px; font-weight: 600; background: transparent; border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; transition: all 0.3s; font-family: inherit; }
        .chart-tab.active, .chart-tab:hover { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .chart-toggle { display: flex; background: var(--bg-input); border: 1px solid var(--border); overflow: hidden; }
        .chart-toggle-btn { padding: 6px 14px; font-size: 10px; font-weight: 600; background: transparent; border: none; color: var(--text-dim); cursor: pointer; transition: all 0.3s; }
        .chart-toggle-btn.active { background: var(--accent); color: var(--bg); }
        .chart-wrapper { height: 280px; position: relative; }
        
        /* Forms */
        .form-section { background: var(--bg-card); border: 1px solid var(--border); padding: 20px; margin-bottom: 16px; }
        .form-title { font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        .form-row { display: flex; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
        .form-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 140px; }
        .form-label { font-size: 10px; font-weight: 600; color: var(--text-dim); letter-spacing: 0.5px; }
        .form-input, .form-select { background: var(--bg-input); border: 1px solid var(--border); padding: 10px 12px; color: var(--text); font-size: 14px; font-family: inherit; }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .form-actions { display: flex; gap: 10px; margin-top: 16px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .tab { padding: 12px 20px; font-size: 12px; font-weight: 600; color: var(--text-dim); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        /* Business */
        .business-selector { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .business-chip { padding: 8px 16px; font-size: 11px; font-weight: 600; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .business-chip:hover { border-color: var(--text-dim); }
        .business-chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .business-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .business-stat { background: var(--bg-card); border: 1px solid var(--border); padding: 16px; text-align: center; }
        .business-stat-value { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 700; color: var(--accent); }
        .business-stat-label { font-size: 10px; color: var(--text-dim); margin-top: 6px; letter-spacing: 1px; }
        
        /* Account rows */
        .account-grid { display: flex; flex-direction: column; gap: 6px; }
        .account-row { display: grid; grid-template-columns: 160px 70px 1fr 32px; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .account-name { font-size: 13px; font-weight: 500; }
        .account-bank { font-size: 10px; color: var(--text-muted); }
        .account-row .form-input { text-align: right; font-family: 'Cormorant Garamond', serif; font-size: 15px; font-weight: 600; }
        .account-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; opacity: 0; transition: all 0.3s; }
        .account-row:hover .account-delete { opacity: 1; }
        .account-delete:hover { color: var(--danger); }
        .category-total { text-align: right; padding: 10px 0; font-size: 12px; color: var(--text-dim); }
        .category-total span { font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 700; color: var(--accent); margin-left: 8px; }
        .debt-section .form-input { color: var(--danger); }
        .debt-section .category-total span { color: var(--danger); }
        
        /* Toast & Modal */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--success); color: #fff; padding: 14px 24px; font-size: 13px; font-weight: 600; transform: translateY(100px); opacity: 0; transition: all 0.4s ease; z-index: 1000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); padding: 28px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s ease; }
        .modal-title { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        
        /* Habit Items */
        .habit-item { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: var(--bg-input); border: 1px solid var(--border); cursor: pointer; transition: all 0.3s; }
        .habit-item:hover { border-color: var(--text-muted); }
        .habit-item:has(input:checked) { background: var(--accent-dim); border-color: var(--accent); }
        .habit-item input { display: none; }
        .habit-icon { font-size: 28px; }
        .habit-name { font-size: 12px; font-weight: 600; }
        .habit-time { font-size: 10px; color: var(--text-muted); }
        .habit-item:has(input:checked) .habit-name { color: var(--accent); }
        
        /* Photo Gallery */
        .photo-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .photo-card { background: var(--bg-card); border: 1px solid var(--border); padding: 12px; text-align: center; }
        .photo-card img { width: 100%; height: 150px; object-fit: cover; margin-bottom: 8px; }
        .photo-date { font-size: 11px; color: var(--accent); margin-bottom: 4px; }
        .photo-stats { font-size: 10px; color: var(--text-dim); }
        .photo-upload { border: 2px dashed var(--border); padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .photo-upload:hover { border-color: var(--accent); }
        
        /* Monthly Table */
        .monthly-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .monthly-table th, .monthly-table td { padding: 8px 6px; text-align: center; border: 1px solid var(--border); }
        .monthly-table th { background: var(--bg-elevated); color: var(--text-dim); font-weight: 600; }
        .monthly-table .positive { color: var(--success); }
        .monthly-table .negative { color: var(--danger); }
        
        /* Daily Grid - Equal Width & Height Columns */
        .daily-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            align-items: stretch;
        }
        .daily-column {
            display: flex;
            flex-direction: column;
        }
        .daily-column > .goal-card,
        .daily-column > .form-section {
            flex: 1;
        }
        .daily-column:first-child {
            display: flex;
            flex-direction: column;
        }
        .daily-column:first-child > .goal-card {
            flex: 0 0 auto;
        }
        .daily-column:first-child > .form-section {
            flex: 1;
        }
        
        /* Sticky Table Header for Daily History */
        .daily-history-wrapper {
            max-height: 480px;
            overflow-y: auto;
            position: relative;
        }
        .daily-history-wrapper table {
            width: 100%;
            border-collapse: collapse;
        }
        .daily-history-wrapper thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .daily-history-wrapper thead th {
            background: var(--bg-card) !important;
            border-bottom: 2px solid var(--accent);
            padding: 12px 4px;
            font-size: 16px;
            text-align: center;
        }
        .daily-history-wrapper thead th:first-child {
            text-align: left;
            font-size: 11px;
            padding-left: 8px;
        }
        .daily-history-wrapper thead th:last-child {
            font-size: 11px;
        }
        .daily-history-wrapper tbody td {
            padding: 8px 4px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            text-align: center;
        }
        .daily-history-wrapper tbody td:first-child {
            text-align: left;
            white-space: nowrap;
            padding-left: 8px;
            font-size: 11px;
        }
        .daily-history-wrapper tbody tr:hover {
            background: var(--bg-elevated);
        }
        .daily-history-wrapper tbody tr.today-row {
            background: rgba(212,197,169,0.15);
            font-weight: 600;
        }
        
        /* Mobile */
        .mobile-menu-btn { display: none; position: fixed; top: 14px; left: 14px; z-index: 200; width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border); color: var(--accent); font-size: 18px; cursor: pointer; align-items: center; justify-content: center; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 90; }
        
        @media (max-width: 1200px) {
            .wealth-layout { grid-template-columns: 1fr; }
            .wealth-sidebar { position: relative; top: 0; }
            .cards { grid-template-columns: repeat(3, 1fr); }
            /* masonry handled by JS */
            .daily-grid { grid-template-columns: 1fr 1fr; }
            .daily-column:nth-child(3) { grid-column: span 2; }
        }
        /* ===== MOBILE (‚â§768px) ===== */
        @media (max-width: 768px) {
            /* --- Base Layout --- */
            .mobile-menu-btn { display: flex; }
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; width: 260px; z-index: 150; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.show { display: block; }
            .main { margin-left: 0; }
            
            /* --- Header: wrap buttons --- */
            .header { padding: 10px 12px; padding-left: 56px; flex-wrap: wrap; gap: 8px; }
            .header .page-title { font-size: 12px; letter-spacing: 2px; }
            .header-actions { gap: 4px; flex-wrap: wrap; }
            .header-actions .btn { padding: 5px 8px; font-size: 9px; }
            .header-actions .sync-dot { margin-right: 2px; }
            
            /* --- Content --- */
            .content { padding: 10px; }
            
            /* --- Dashboard Stats Row --- */
            .stats-row { grid-template-columns: repeat(3, 1fr) !important; padding: 10px; gap: 4px; }
            .stat-box { padding: 8px 2px; }
            .stat-value { font-size: 20px; }
            .stat-label { font-size: 7px; letter-spacing: 0.5px; }
            
            /* --- Dashboard Cards --- */
            .cards { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .card { padding: 12px; }
            .card-icon { font-size: 20px; }
            .card-title { font-size: 15px; }
            .card-desc { font-size: 10px; }
            .card-badge { font-size: 8px; padding: 2px 6px; }
            
            /* --- Moodboard --- */
            .moodboard-title { font-size: 28px; letter-spacing: 6px; }
            .moodboard-sub { font-size: 8px; letter-spacing: 2px; }
            .moodboard-refresh { top: 6px; right: 6px; padding: 3px 8px; font-size: 9px; }
            .moodboard-toolbar { top: 6px !important; left: 6px !important; gap: 3px !important; }
            .moodboard-toolbar span { padding: 2px 6px !important; font-size: 8px !important; }
            .moodboard-toolbar .moodboard-refresh { padding: 2px 6px; font-size: 8px; }
            
            /* --- Quote Box --- */
            .quote-box { padding: 14px 16px; }
            .quote-box .quote-text { font-size: 13px; line-height: 1.5; }
            .quote-box .quote-text strong { font-size: 15px !important; }
            .quote-box::before { font-size: 80px; top: -12px; }
            .quote-author { font-size: 10px; }
            
            /* --- Goal Card --- */
            .goal-card { padding: 12px; }
            .goal-value { font-size: 18px; }
            .goal-label { font-size: 9px; }
            .goal-info { font-size: 10px; }
            
            /* --- Forms --- */
            .form-section { padding: 12px; }
            .form-title { font-size: 13px; }
            .form-row { flex-direction: column; gap: 8px; }
            .form-group { min-width: 0; }
            .form-input, .form-select { padding: 8px 10px; font-size: 13px; }
            .form-label { font-size: 9px; }
            .form-actions { flex-wrap: wrap; }
            .section-label { font-size: 9px; margin-bottom: 10px; }
            
            /* --- Buttons --- */
            .btn { padding: 8px 14px; font-size: 11px; }
            .btn-small { padding: 4px 8px; font-size: 9px; }
            
            /* --- Summary Grid --- */
            .summary-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .summary-item { padding: 12px 8px; }
            .summary-value { font-size: 20px; }
            .summary-label { font-size: 9px; }
            
            /* --- Charts --- */
            .chart-container { padding: 12px; }
            .chart-wrapper { height: 200px; }
            .chart-header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .chart-title { font-size: 15px; }
            .chart-tabs { flex-wrap: wrap; gap: 4px; }
            .chart-tab { padding: 4px 8px; font-size: 9px; }
            .chart-toggle { flex-wrap: nowrap; }
            .chart-toggle-btn { padding: 4px 10px; font-size: 9px; }
            
            /* --- Tabs --- */
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tab { padding: 10px 12px; font-size: 11px; white-space: nowrap; }
            
            /* ===== WEALTH SECTION ===== */
            .wealth-layout { gap: 16px; }
            .wealth-quote-goal { grid-template-columns: 1fr !important; gap: 12px !important; }
            .account-row { grid-template-columns: 1fr 40px 100px 24px; font-size: 11px; gap: 6px; }
            .account-name { font-size: 12px; }
            .category-total { font-size: 11px; }
            
            /* ===== PHYSIC SECTION ===== */
            .physic-layout { grid-template-columns: 1fr !important; }
            .physic-stats-row { grid-template-columns: repeat(3, 1fr) !important; }
            
            /* ===== DAILY SECTION ===== */
            .daily-grid { grid-template-columns: 1fr; }
            .daily-column:nth-child(3) { grid-column: span 1; }
            .daily-column:nth-child(3) iframe { min-height: 300px !important; }
            .daily-history-wrapper { max-height: 350px; -webkit-overflow-scrolling: touch; }
            .daily-history-wrapper thead th { font-size: 14px; padding: 8px 2px; }
            .daily-history-wrapper thead th:first-child { font-size: 9px; }
            .daily-history-wrapper thead th:last-child { font-size: 9px; }
            .daily-history-wrapper tbody td { padding: 6px 2px; font-size: 11px; }
            #habits-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 6px !important; }
            .habit-item { padding: 8px !important; }
            .habit-icon { font-size: 20px !important; }
            .habit-name { font-size: 10px !important; }
            .habit-time { font-size: 8px; }
            
            /* ===== TRADING SECTION ===== */
            .monthly-table { font-size: 8px; }
            .monthly-table th, .monthly-table td { padding: 3px 1px; }
            #prop-challenges { grid-template-columns: 1fr !important; }
            
            /* ===== BUSINESS SECTION ===== */
            .business-stats { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .business-stat { padding: 12px 8px; }
            .business-stat-value { font-size: 22px; }
            .business-stat-label { font-size: 9px; }
            .business-selector { gap: 6px; }
            .business-chip { padding: 6px 10px; font-size: 10px; }
            
            /* ===== AI PANEL ===== */
            .ai-panel { margin-top: 8px; }
            .ai-content { max-height: 180px; }
            .ai-suggestion { font-size: 12px; line-height: 1.5; }
            .ai-input { font-size: 12px; padding: 8px 10px; }
            
            /* ===== MODALS ===== */
            .modal-overlay { padding: 12px; }
            .modal { padding: 16px; max-width: 100%; }
            .modal-title { font-size: 18px; margin-bottom: 14px; }
            
            /* ===== INFORMATION ===== */
            #information .content { height: calc(100vh - 60px); padding: 0; }
        }
        
        /* ===== SMALL PHONE (‚â§400px) ===== */
        @media (max-width: 400px) {
            .stats-row { grid-template-columns: repeat(2, 1fr) !important; }
            .cards { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
            #habits-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .header { padding-left: 48px; }
            .mobile-menu-btn { width: 34px; height: 34px; font-size: 16px; }
            .moodboard-title { font-size: 22px; letter-spacing: 4px; }
            .chart-wrapper { height: 160px; }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
    <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
    
    <nav class="sidebar">
        <div class="logo"><div class="logo-text">RayOS</div></div>
        <div class="nav-item active" data-section="dashboard"><span class="nav-icon">‚óâ</span><span>Dashboard</span></div>
        <div class="nav-item" data-section="daily"><span class="nav-icon">‚úì</span><span>Daily</span></div>
        <div class="nav-item" data-section="physic"><span class="nav-icon">ü•∑</span><span>Physic</span></div>
        <div class="nav-item" data-section="wealth"><span class="nav-icon">$</span><span>Wealth</span></div>
        <div class="nav-item" data-section="trading"><span class="nav-icon">üìà</span><span>Trading</span></div>
        <div class="nav-item" data-section="business"><span class="nav-icon">üìä</span><span>Business</span></div>
        <div class="nav-item" data-section="ideas"><span class="nav-icon">üí°</span><span>Ideas</span></div>
        <div class="nav-item" data-section="information"><span class="nav-icon">üìñ</span><span>Information</span></div>
    </nav>
    
    <main class="main">
        <!-- DASHBOARD -->
        <section class="section active" id="dashboard">
            <div class="header">
                <div class="page-title">Dashboard</div>
                <div class="header-actions">
                    <button class="btn" onclick="showModal('settings-modal')">‚öôÔ∏è Settings</button>
                </div>
            </div>

            <div class="moodboard-wrapper">
                <div class="moodboard" id="moodboard-grid"></div>
                <div class="moodboard-center">
                    <div class="moodboard-title">VISION</div>
                    <div class="moodboard-sub">Build The Life You Want</div>
                </div>
                <button class="moodboard-refresh" onclick="refreshMoodboard()" title="Shuffle images">üîÄ Shuffle</button>
                <div class="moodboard-toolbar" style="position:absolute;top:12px;left:12px;z-index:15;display:flex;gap:6px;align-items:center;">
                    <span id="moodboard-count" style="background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);padding:4px 10px;font-size:10px;backdrop-filter:blur(4px);">üñºÔ∏è --</span>
                    <button class="moodboard-refresh" style="position:static;" onclick="syncMoodboardFromDrive()" title="Sync from Google Drive">üì∑ Sync</button>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-box" onclick="go('daily')"><div class="stat-value" id="stat-streak">0</div><div class="stat-label">Streak</div></div>
                <div class="stat-box" onclick="go('physic')"><div class="stat-value" id="stat-bodyfat">--</div><div class="stat-label">Body Fat</div></div>
                <div class="stat-box" onclick="go('wealth')"><div class="stat-value" id="stat-wealth">--</div><div class="stat-label">Total Assets</div></div>
                <div class="stat-box" onclick="go('business')"><div class="stat-value" id="stat-mrr">$0</div><div class="stat-label">MRR</div></div>
                <div class="stat-box" onclick="go('ideas')"><div class="stat-value" id="stat-ideas">0</div><div class="stat-label">Ideas</div></div>
                <div class="stat-box" onclick="go('information')"><div class="stat-value" id="stat-learning">0</div><div class="stat-label">Learning</div></div>
            </div>

            <div class="content">
                <div class="section-label">Quick Access</div>
                <div class="cards">
                    <div class="card" onclick="go('physic')"><div class="card-header"><span class="card-icon">ü•∑</span><span class="card-badge">TRACK</span></div><div class="card-title">Physic</div><div class="card-desc">È´îÈáç„ÉªÈ´îËÑÇ„ÉªÈÄ≤Â∫¶</div></div>
                    <div class="card" onclick="go('wealth')"><div class="card-header"><span class="card-icon">$</span><span class="card-badge">TRACK</span></div><div class="card-title">Wealth</div><div class="card-desc">Ë≥áÁî¢„ÉªÊ∂àË≤ª„ÉªÁõÆÊ®ô</div></div>
                    <div class="card" onclick="go('business')"><div class="card-header"><span class="card-icon">üìä</span><span class="card-badge">GROW</span></div><div class="card-title">Business</div><div class="card-desc">Skool„ÉªMRR„ÉªMembers</div></div>
                    <div class="card" onclick="go('ideas')"><div class="card-header"><span class="card-icon">üí°</span><span class="card-badge">CAPTURE</span></div><div class="card-title">Ideas</div><div class="card-desc">ÈùàÊÑü„ÉªÈªûÂ≠ê„ÉªË®àÂäÉ</div></div>
                    <div class="card" onclick="go('information')"><div class="card-header"><span class="card-icon">üìñ</span><span class="card-badge">LEARN</span></div><div class="card-title">Information</div><div class="card-desc">YouTube Lab</div></div>
                </div>
            </div>
        </section>

        <!-- WEALTH -->
        <section class="section" id="wealth">
            <div class="header">
                <div class="page-title">Wealth</div>
                <div class="header-actions">
                    <span class="sync-dot off" id="wealth-sync-dot"></span>
                    <button class="btn" onclick="syncWealthFromNotion()">Sync Notion</button>
                    <button class="btn" onclick="go('dashboard')">‚Üê Back</button>
                    <button class="btn" onclick="showModal('account-modal')">Accounts</button>
                    <button class="btn btn-accent" onclick="window.open('https://www.notion.so/9b31234579244560bfaa6247bf71d462','_blank')">Notion</button>
                </div>
            </div>
            <div class="content">
                <div class="wealth-layout">
                    <div class="wealth-main">
                        <div class="wealth-quote-goal" style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">
                            <div class="quote-box animate-fade">
                                <div class="quote-text" id="wealth-quote-text">"Wealth is the ability to fully experience life."</div>
                                <div class="quote-author" id="wealth-quote-author">‚Äî Henry David Thoreau</div>
                                <button class="btn btn-small" style="position:absolute;top:12px;right:12px;opacity:0.5;" onclick="editQuote()">Edit</button>
                            </div>
                            <div class="goal-card animate-fade" style="animation-delay:0.1s;">
                                <div class="goal-header"><span class="goal-label">2026 TARGET</span><button class="btn btn-small" onclick="editGoal()">Edit</button></div>
                                <div class="goal-value"><span id="goal-current">--</span> / <span id="goal-target">6,500,000</span></div>
                                <div class="goal-progress"><div class="goal-bar" id="goal-bar" style="width:0%"></div></div>
                                <div class="goal-info"><span id="goal-pct">0%</span><span id="goal-remain">ÈÇÑÂ∑Æ --</span></div>
                            </div>
                        </div>
                        
                        <div class="summary-grid animate-fade" style="animation-delay:0.15s;">
                            <div class="summary-item"><div class="summary-label">Total Assets</div><div class="summary-value accent" id="display-total">--</div></div>
                            <div class="summary-item"><div class="summary-label">Monthly</div><div class="summary-value" id="display-monthly">--</div></div>
                            <div class="summary-item"><div class="summary-label">Yearly</div><div class="summary-value" id="display-yearly">--</div></div>
                            <div class="summary-item"><div class="summary-label">Last Update</div><div class="summary-value" id="display-lastdate" style="font-size:16px;">--</div></div>
                        </div>
                        
                        <div class="chart-container animate-fade" style="animation-delay:0.2s;">
                            <div class="chart-header">
                                <div class="chart-title">Trend</div>
                                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                                    <div class="chart-toggle">
                                        <button class="chart-toggle-btn active" onclick="setWealthMode('trend',this)">Trend</button>
                                        <button class="chart-toggle-btn" onclick="setWealthMode('growth',this)">Growth %</button>
                                    </div>
                                    <div class="chart-toggle">
                                        <button class="chart-toggle-btn" onclick="setWealthChartStyle('line',this)">üìà Line</button>
                                        <button class="chart-toggle-btn active" onclick="setWealthChartStyle('bar',this)">üìä Bar</button>
                                        <button class="chart-toggle-btn" onclick="setWealthChartStyle('both',this)">Both</button>
                                    </div>
                                    <div class="chart-tabs">
                                        <button class="chart-tab active" onclick="setWealthChart('total',this)">Total Assets</button>
                                        <button class="chart-tab" onclick="setWealthChart('savings',this)">Ê¥ªÊúüÂ≠òÊ¨æ</button>
                                        <button class="chart-tab" onclick="setWealthChart('stocks',this)">ËÇ°Á•®/ETF</button>
                                        <button class="chart-tab" onclick="setWealthChart('crypto',this)">Âä†ÂØÜË≤®Âπ£</button>
                                        <button class="chart-tab" onclick="setWealthChart('debt',this)">ÂÇµÂãô</button>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-wrapper"><canvas id="wealthChart"></canvas></div>
                        </div>
                        
                        <div class="tabs">
                            <div class="tab active" onclick="setWealthTab('snapshot',this)">üìä Monthly Snapshot</div>
                            <div class="tab" onclick="setWealthTab('expense',this)">üí≥ Expense Analysis</div>
                        </div>
                        <div id="tab-snapshot">
                            <div style="text-align:center;margin-bottom:20px;">
                                <button class="btn btn-accent" onclick="toggleWealthForm()" id="wealth-form-toggle">üìù New Snapshot</button>
                            </div>
                            <div id="wealth-form" style="display:none;"></div>
                        </div>
                        <div id="tab-expense" style="display:none;">
                            <div class="form-section">
                                <div class="form-title">üì§ Import Credit Card Statement</div>
                                <textarea class="form-input" id="expense-paste" rows="3" placeholder="Paste CSV: date,description,amount" style="width:100%;"></textarea>
                                <div class="form-actions"><button class="btn btn-accent" onclick="analyzeExpenses()">Analyze</button></div>
                            </div>
                            <div id="expense-result" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="wealth-sidebar">
                        <div class="ai-panel">
                            <div class="ai-header"><div class="ai-icon">üéØ</div><div class="ai-title">AI Wealth Coach</div><span class="ai-model-badge"></span></div>
                            <div class="ai-content"><div class="ai-suggestion" id="wealth-ai-suggestion">Loading...</div></div>
                            <div class="ai-chat">
                                <div class="ai-input-wrap">
                                    <input type="text" class="ai-input" id="wealth-ai-input" placeholder="Ask about your wealth...">
                                    <button class="ai-send" onclick="askWealthAI()">‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TRADING -->
        <section class="section" id="trading">
            <div class="header">
                <div class="page-title">Trading</div>
                <div class="header-actions"><button class="btn" onclick="go('dashboard')">‚Üê Back</button></div>
            </div>
            <div class="content">
                <div class="wealth-layout">
                    <div class="wealth-main">
                        <div class="tabs">
                            <div class="tab active" onclick="setTradingTab('algo',this)">ü§ñ Á®ãÂºè‰∫§Êòì</div>
                            <div class="tab" onclick="setTradingTab('propfirm',this)">üè¶ Prop Firm</div>
                        </div>
                        <div id="tab-algo">
                            <div class="summary-grid" style="margin-bottom:20px;">
                                <div class="summary-item"><div class="summary-label">Á¥ØÁ©çÂ†±ÈÖ¨Áéá</div><div class="summary-value accent" id="algo-cumret">43.16%</div></div>
                                <div class="summary-item"><div class="summary-label">Âπ¥ÂåñÂ†±ÈÖ¨Áéá</div><div class="summary-value" id="algo-annual">58.83%</div></div>
                                <div class="summary-item"><div class="summary-label">MDD</div><div class="summary-value negative" id="algo-mdd">26.01%</div></div>
                                <div class="summary-item"><div class="summary-label">Êó•ÂãùÁéá</div><div class="summary-value" id="algo-winrate">51.54%</div></div>
                            </div>
                            <div class="chart-container" style="margin-bottom:20px;">
                                <div class="chart-header"><div class="chart-title">Daily Cumulative Return (%)</div></div>
                                <div class="chart-wrapper"><canvas id="algoChart"></canvas></div>
                            </div>
                            <div class="form-section" style="margin-bottom:20px;">
                                <div class="form-title">üìä Monthly Returns</div>
                                <div style="overflow-x:auto;">
                                    <table class="monthly-table" id="monthly-returns-table">
                                        <thead><tr><th>Year</th><th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th><th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th><th>YTD</th></tr></thead>
                                        <tbody id="monthly-returns-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="form-section">
                                <div class="form-title">üìù Record Daily Equity</div>
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="algo-date"></div>
                                    <div class="form-group"><label class="form-label">Ê¨äÁõäÊï∏</label><input type="number" class="form-input" id="algo-equity" placeholder="1,435,231"></div>
                                    <div class="form-group"><label class="form-label">Êó•Â†±ÈÖ¨ %</label><input type="number" step="0.01" class="form-input" id="algo-daily-ret" placeholder="3.09"></div>
                                </div>
                                <div class="form-actions"><button class="btn btn-accent" onclick="saveAlgoEquity()">Save</button></div>
                            </div>
                        </div>
                        <div id="tab-propfirm" style="display:none;">
                            <div class="summary-grid" style="margin-bottom:20px;">
                                <div class="summary-item"><div class="summary-label">Total Challenge Fee</div><div class="summary-value negative" id="prop-fee">$38,918</div></div>
                                <div class="summary-item"><div class="summary-label">Total Payout</div><div class="summary-value positive" id="prop-payout">$64,043</div></div>
                                <div class="summary-item"><div class="summary-label">Net Profit</div><div class="summary-value accent" id="prop-net">$29,648</div></div>
                                <div class="summary-item"><div class="summary-label">Pass Rate</div><div class="summary-value" id="prop-passrate">25%</div></div>
                            </div>
                            <div style="display:flex;gap:8px;margin-bottom:20px;">
                                <button class="btn" onclick="window.open('https://www.canva.com','_blank')">üìù Canva Notes</button>
                                <button class="btn" onclick="window.open('https://app.tradezella.com','_blank')">üìà TradeZella</button>
                            </div>
                            <div class="section-label">Active Accounts</div>
                            <div id="prop-challenges" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;"></div>
                            <div class="form-section">
                                <div class="form-title">üìù Add Record</div>
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Firm</label><select class="form-input" id="prop-firm"><option value="FTMO">FTMO</option><option value="TopStep">TopStep</option><option value="Tradeify">Tradeify</option><option value="Other">Other</option></select></div>
                                    <div class="form-group"><label class="form-label">Challenge Fee</label><input type="number" class="form-input" id="prop-challenge-fee" placeholder="875"></div>
                                    <div class="form-group"><label class="form-label">Payout</label><input type="number" class="form-input" id="prop-payout-amount" placeholder="0"></div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="prop-record-date"></div>
                                    <div class="form-group"><label class="form-label">Status</label><select class="form-input" id="prop-status"><option value="Challenge">Challenge</option><option value="Funded">Funded</option><option value="Failed">Failed</option><option value="Payout">Payout</option></select></div>
                                </div>
                                <div class="form-actions"><button class="btn btn-accent" onclick="savePropRecord()">Add</button></div>
                            </div>
                        </div>
                    </div>
                    <div class="wealth-sidebar">
                        <div class="ai-panel">
                            <div class="ai-header"><div class="ai-icon">üìà</div><div class="ai-title">AI Trading Coach</div><span class="ai-model-badge"></span></div>
                            <div class="ai-content"><div class="ai-suggestion" id="trading-ai-suggestion">Loading...</div></div>
                            <div class="ai-chat">
                                <div class="ai-input-wrap">
                                    <input type="text" class="ai-input" id="trading-ai-input" placeholder="Ask about your trading...">
                                    <button class="ai-send" onclick="askTradingAI()">‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BUSINESS -->
        <section class="section" id="business">
            <div class="header">
                <div class="page-title">Business</div>
                <div class="header-actions">
                    <button class="btn" onclick="go('dashboard')">‚Üê Back</button>
                    <button class="btn" onclick="showModal('business-modal')">+ Add Business</button>
                </div>
            </div>
            <div class="content">
                <div class="business-selector" id="business-selector">
                    <div class="business-chip active" data-biz="skool-free" onclick="selectBusiness('skool-free',this)">üéì Skool Free</div>
                    <div class="business-chip" data-biz="skool-paid" onclick="selectBusiness('skool-paid',this)">üíé Skool Paid</div>
                    <div class="business-chip" data-biz="youtube" onclick="selectBusiness('youtube',this)">üì∫ YouTube</div>
                </div>
                <div class="wealth-layout">
                    <div class="wealth-main">
                        <div class="business-stats">
                            <div class="business-stat"><div class="business-stat-value" id="biz-members">0</div><div class="business-stat-label">Members</div></div>
                            <div class="business-stat"><div class="business-stat-value" id="biz-mrr">$0</div><div class="business-stat-label">MRR</div></div>
                            <div class="business-stat"><div class="business-stat-value" id="biz-growth">0%</div><div class="business-stat-label">Growth</div></div>
                            <div class="business-stat"><div class="business-stat-value" id="biz-ltv">$0</div><div class="business-stat-label">LTV</div></div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title" id="biz-chart-title">Growth</div>
                                <div class="chart-tabs">
                                    <button class="chart-tab active" onclick="setBizChart('members',this)">Members</button>
                                    <button class="chart-tab" onclick="setBizChart('revenue',this)">Revenue</button>
                                </div>
                            </div>
                            <div class="chart-wrapper"><canvas id="bizChart"></canvas></div>
                        </div>
                        <div class="form-section">
                            <div class="form-title">üìù Update Metrics</div>
                            <div class="form-row">
                                <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="biz-date"></div>
                                <div class="form-group"><label class="form-label">Members</label><input type="number" class="form-input" id="biz-members-input" placeholder="0"></div>
                                <div class="form-group"><label class="form-label">Revenue (USD)</label><input type="number" class="form-input" id="biz-revenue-input" placeholder="0"></div>
                            </div>
                            <div class="form-actions"><button class="btn btn-accent" onclick="saveBizMetrics()">Save</button></div>
                        </div>
                    </div>
                    <div class="wealth-sidebar">
                        <div class="ai-panel">
                            <div class="ai-header"><div class="ai-icon">üìà</div><div class="ai-title">AI Business Coach</div><span class="ai-model-badge"></span></div>
                            <div class="ai-content"><div class="ai-suggestion" id="biz-ai-suggestion">Select a business to see AI recommendations.</div></div>
                            <div class="ai-chat">
                                <div class="ai-input-wrap">
                                    <input type="text" class="ai-input" id="biz-ai-input" placeholder="Ask about your business...">
                                    <button class="ai-send" onclick="askBizAI()">‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PHYSIC -->
        <section class="section" id="physic">
            <div class="header">
                <div class="page-title">Physic</div>
                <div class="header-actions">
                    <button class="btn" onclick="go('dashboard')">&#8592; Back</button>
                    <span class="sync-dot off" id="body-sync-dot"></span>
                    <button class="btn" onclick="syncBodyFromNotion()">&#128260; Sync Notion</button>
                    <button class="btn btn-accent" onclick="window.open('https://www.notion.so/f481a3da00de4d9391d293a88cf1c9c1','_blank')">Notion</button>
                </div>
            </div>
            <!-- Stats Row -->
            <div class="stats-row physic-stats-row" style="grid-template-columns:repeat(5,1fr);">
                <div class="stat-box"><div class="stat-value" id="body-stat-weight">--</div><div class="stat-label">Weight (kg)</div></div>
                <div class="stat-box"><div class="stat-value" id="body-stat-fat">--</div><div class="stat-label">Body Fat %</div></div>
                <div class="stat-box"><div class="stat-value" id="body-stat-muscle">--</div><div class="stat-label">Muscle (kg)</div></div>
                <div class="stat-box"><div class="stat-value" id="body-stat-bmi">--</div><div class="stat-label">BMI</div></div>
                <div class="stat-box"><div class="stat-value" id="body-stat-change">--</div><div class="stat-label">Fat Change</div></div>
            </div>
            <div class="content">
                <div class="wealth-layout">
                    <div class="wealth-main">
                        <div class="physic-layout" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div class="goal-card">
                                <div class="goal-header"><span class="goal-label">Body Fat Target</span><button class="btn btn-small" onclick="editPhysicGoal()">Edit</button></div>
                                <div class="goal-value"><span id="physic-current">19.2</span>% &#8594; <span id="physic-target">15</span>%</div>
                                <div class="goal-progress"><div class="goal-bar" id="physic-bar" style="width:0%"></div></div>
                                <div class="goal-info"><span id="physic-pct">0%</span><span id="physic-remain"></span></div>
                            </div>
                            <div class="form-section" style="margin:0;">
                                <div class="form-title">&#128221; Record</div>
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="body-date"></div>
                                    <div class="form-group"><label class="form-label">Weight (kg)</label><input type="number" step="0.1" class="form-input" id="body-weight" placeholder="79.8"></div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group"><label class="form-label">Muscle (kg)</label><input type="number" step="0.1" class="form-input" id="body-muscle" placeholder="37.0"></div>
                                    <div class="form-group"><label class="form-label">Fat %</label><input type="number" step="0.1" class="form-input" id="body-fatpct" placeholder="19.2"></div>
                                </div>
                                <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="body-notes" placeholder="e.g. InBody test"></div>
                                <div class="form-actions" style="margin-top:8px;"><button class="btn btn-accent" onclick="saveBodyData()">Save &amp; Sync</button></div>
                            </div>
                        </div>
                        <!-- Before / After Photo -->
                        <div class="form-section">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <div class="form-title" style="margin:0;">&#128247; Before / After Comparison</div>
                                <div style="display:flex;gap:6px;align-items:center;">
                                    <span id="body-photo-count" style="font-size:10px;color:var(--text-dim);">--</span>
                                    <button class="btn btn-small" onclick="syncBodyPhotosFromDrive()">üì∑ Sync Drive</button>
                                </div>
                            </div>
                            <div class="physic-layout" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px;">
                                <div>
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                        <span style="font-size:10px;font-weight:700;color:var(--text-dim);letter-spacing:1px;">BEFORE</span>
                                        <select class="form-input" id="photo-before-select" onchange="photoIdx.before=0;updatePhotoComparison()" style="padding:4px 8px;font-size:11px;max-width:150px;"></select>
                                    </div>
                                    <div id="photo-before-frame" style="aspect-ratio:3/4;background:var(--bg-input);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;" onclick="cyclePhoto('before',1)">
                                        <span style="color:var(--text-muted);font-size:12px;">No photo</span>
                                    </div>
                                    <div id="photo-before-thumbs" style="display:flex;gap:4px;margin-top:6px;justify-content:center;"></div>
                                    <div id="photo-before-stats" style="text-align:center;margin-top:4px;font-size:11px;color:var(--text-dim);"></div>
                                </div>
                                <div>
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                        <span style="font-size:10px;font-weight:700;color:var(--text-dim);letter-spacing:1px;">AFTER</span>
                                        <select class="form-input" id="photo-after-select" onchange="photoIdx.after=0;updatePhotoComparison()" style="padding:4px 8px;font-size:11px;max-width:150px;"></select>
                                    </div>
                                    <div id="photo-after-frame" style="aspect-ratio:3/4;background:var(--bg-input);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;" onclick="cyclePhoto('after',1)">
                                        <span style="color:var(--text-muted);font-size:12px;">No photo</span>
                                    </div>
                                    <div id="photo-after-thumbs" style="display:flex;gap:4px;margin-top:6px;justify-content:center;"></div>
                                    <div id="photo-after-stats" style="text-align:center;margin-top:4px;font-size:11px;color:var(--text-dim);"></div>
                                </div>
                            </div>
                            <div id="photo-delta" style="display:none;background:var(--bg-input);border:1px solid var(--border);padding:12px;text-align:center;">
                                <div style="font-size:10px;color:var(--text-dim);letter-spacing:1px;margin-bottom:4px;">PROGRESS</div>
                                <div id="photo-delta-text" style="font-size:14px;font-weight:600;"></div>
                            </div>
                            <div style="margin-top:12px;padding:10px;background:var(--bg-input);border:1px solid var(--border);font-size:11px;color:var(--text-dim);text-align:center;">
                                üìÅ Google Drive ‚Üí RayOS Moodboard ‚Üí <strong>Body Progress</strong> ‚Üí <strong>YYYYMMDD</strong> Ë≥áÊñôÂ§æ
                            </div>
                        </div>
                        <!-- Chart -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">Trend</div>
                                <div class="chart-tabs">
                                    <button class="chart-tab active" onclick="setBodyChart('fat',this)">Body Fat</button>
                                    <button class="chart-tab" onclick="setBodyChart('weight',this)">Weight</button>
                                    <button class="chart-tab" onclick="setBodyChart('muscle',this)">Muscle</button>
                                </div>
                            </div>
                            <div class="chart-wrapper"><canvas id="bodyChart"></canvas></div>
                        </div>
                        <!-- History Table -->
                        <div class="form-section">
                            <div class="form-title">&#128202; History</div>
                            <div style="max-height:360px;overflow-y:auto;">
                                <table class="monthly-table">
                                    <thead><tr><th>Date</th><th>Weight</th><th>Fat %</th><th>Muscle</th><th>BMI</th><th>Notes</th><th></th></tr></thead>
                                    <tbody id="body-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- AI Coach Sidebar -->
                    <div class="wealth-sidebar">
                        <div class="ai-panel">
                            <div class="ai-header"><div class="ai-icon">&#127947;</div><div class="ai-title">AI Body Coach</div><span class="ai-model-badge"></span></div>
                            <div class="ai-content"><div class="ai-suggestion" id="body-ai-suggestion">Loading...</div></div>
                            <div class="ai-chat">
                                <div class="ai-input-wrap">
                                    <input type="text" class="ai-input" id="body-ai-input" placeholder="Ask about your physique...">
                                    <button class="ai-send" onclick="askBodyAI()">&#8594;</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-section" style="margin:0;">
                            <div class="form-title" style="font-size:13px;">&#128170; Summary</div>
                            <div style="display:grid;gap:8px;font-size:12px;">
                                <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-dim);">Total Records</span><span id="body-total-records">0</span></div>
                                <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-dim);">First Record</span><span id="body-first-date">--</span></div>
                                <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-dim);">Latest Record</span><span id="body-latest-date">--</span></div>
                                <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-dim);">Weight Change</span><span id="body-weight-change">--</span></div>
                                <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-dim);">Fat % Change</span><span id="body-fat-change">--</span></div>
                                <div style="display:flex;justify-content:space-between;"><span style="color:var(--text-dim);">Muscle Change</span><span id="body-muscle-change">--</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- DAILY -->
        <section class="section" id="daily">
            <div class="header">
                <div class="page-title">Daily</div>
                <div class="header-actions">
                    <button class="btn" onclick="go('dashboard')">‚Üê Back</button>
                    <span class="sync-dot off" id="sync-dot"></span><button class="btn" onclick="syncDailyFromNotionDirect()">üîÑ Sync Notion</button>
                    <button class="btn btn-accent" onclick="window.open('https://www.notion.so/58da82d689ed42029274234183f77bb6','_blank')">Notion</button>
                </div>
            </div>
            <div class="content">
                <div class="quote-box" style="margin-bottom:20px;text-align:center;">
                    <div class="quote-text">"If you're under $1,000,000 per year, basically everyone on earth doesn't know you exist.<br><br>4hrs Promotion„ÄÅ4hrs Delivery„ÄÅ4hrs Building.<br><strong style="font-size:20px;">Promote. Deliver. Build.</strong>"</div>
                    <div class="quote-author">‚Äî Alex Hormozi</div>
                </div>
                
                <!-- ‰∏âÊ¨ÑÁ≠âÂØ¨Á≠âÈ´ò -->
                <div class="daily-grid">
                    <!-- Â∑¶ÈÇä: Today's Progress + Daily Habits -->
                    <div class="daily-column">
                        <div class="goal-card" style="margin-bottom:12px;">
                            <div class="goal-header"><span class="goal-label">Today's Progress</span><span id="daily-date" style="color:var(--text-dim);font-size:11px;"></span></div>
                            <div class="goal-value"><span id="daily-done">0</span> / <span id="daily-total">6</span></div>
                            <div class="goal-progress"><div class="goal-bar" id="daily-bar" style="width:0%"></div></div>
                        </div>
                        <div class="form-section" style="padding:16px;flex:1;">
                            <div class="form-title" style="font-size:14px;">‚úì Daily Habits</div>
                            <div id="habits-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
                                <label class="habit-item" style="padding:12px;"><input type="checkbox" class="habit-check" data-habit="trading" onchange="updateDailyProgress()"><span class="habit-icon" style="font-size:24px;">üìà</span><span class="habit-name" style="font-size:12px;">Trading</span><span class="habit-time">4Â∞èÊôÇ</span></label>
                                <label class="habit-item" style="padding:12px;"><input type="checkbox" class="habit-check" data-habit="advertise" onchange="updateDailyProgress()"><span class="habit-icon" style="font-size:24px;">üì£</span><span class="habit-name" style="font-size:12px;">Advertise</span><span class="habit-time">2Â∞èÊôÇ</span></label>
                                <label class="habit-item" style="padding:12px;"><input type="checkbox" class="habit-check" data-habit="deliver" onchange="updateDailyProgress()"><span class="habit-icon" style="font-size:24px;">üì¶</span><span class="habit-name" style="font-size:12px;">Deliver</span><span class="habit-time">2Â∞èÊôÇ</span></label>
                                <label class="habit-item" style="padding:12px;"><input type="checkbox" class="habit-check" data-habit="gym" onchange="updateDailyProgress()"><span class="habit-icon" style="font-size:24px;">üí™</span><span class="habit-name" style="font-size:12px;">Gym</span><span class="habit-time">2Â∞èÊôÇ</span></label>
                                <label class="habit-item" style="padding:12px;"><input type="checkbox" class="habit-check" data-habit="fatloss" onchange="updateDailyProgress()"><span class="habit-icon" style="font-size:24px;">ü•ó</span><span class="habit-name" style="font-size:12px;">Fat Loss</span><span class="habit-time">2Â∞èÊôÇ</span></label>
                                <label class="habit-item" style="padding:12px;"><input type="checkbox" class="habit-check" data-habit="ai" onchange="updateDailyProgress()"><span class="habit-icon" style="font-size:24px;">ü§ñ</span><span class="habit-name" style="font-size:12px;">AI</span><span class="habit-time">2Â∞èÊôÇ</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‰∏≠Èñì: Recent Days (with sticky header) -->
                    <div class="daily-column">
                        <div class="form-section" style="padding:16px;height:100%;display:flex;flex-direction:column;">
                            <div class="form-title" style="font-size:14px;">üìä Recent Days</div>
                            <div class="daily-history-wrapper" style="flex:1;">
                                <table id="daily-history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>üìà</th>
                                            <th>üì£</th>
                                            <th>üì¶</th>
                                            <th>üí™</th>
                                            <th>ü•ó</th>
                                            <th>ü§ñ</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Âè≥ÈÇä: Google Calendar -->
                    <div class="daily-column">
                        <div class="form-section" style="padding:12px;height:100%;display:flex;flex-direction:column;">
                            <div class="form-title" style="font-size:14px;">üìÖ Calendar</div>
                            <iframe src="https://calendar.google.com/calendar/embed?src=david86726%40gmail.com&showTitle=0&showNav=0&showPrint=0&showTabs=0&showCalendars=0&showTz=0&bgcolor=%23000000&ctz=Asia%2FTaipei&mode=MONTH" style="border:none;width:100%;flex:1;min-height:400px;filter:invert(0.9) hue-rotate(180deg);"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- IDEAS -->
        <section class="section" id="ideas">
            <div class="header">
                <div class="page-title">Ideas</div>
                <div class="header-actions">
                    <span class="sync-dot off" id="ideas-sync-dot"></span>
                    <button class="btn" onclick="syncIdeasFromNotion()">Sync Notion</button>
                    <button class="btn" onclick="go('dashboard')">‚Üê Back</button>
                    <button class="btn btn-accent" onclick="window.open('https://www.notion.so/3d416eb92c484ad3bff54919c3ea43fd','_blank')">Notion</button>
                </div>
            </div>
            <div class="content">
                <div class="form-section">
                    <div class="form-title">Quick Capture</div>
                    <div class="form-row">
                        <div class="form-group" style="flex:2;"><label class="form-label">Idea</label><input type="text" class="form-input" id="idea-text" placeholder="Type your idea..." onkeypress="if(event.key==='Enter')saveIdea()"></div>
                        <div class="form-group"><label class="form-label">Type</label><select class="form-input" id="idea-type"><option value="üí∞ Ë≥£Èå¢ÈªûÂ≠ê">üí∞ Ë≥£Èå¢ÈªûÂ≠ê</option><option value="üìπ ÂΩ±ÁâáÈªûÂ≠ê">üìπ ÂΩ±ÁâáÈªûÂ≠ê</option><option value="üõ†Ô∏è Â∑•ÂÖ∑/Ëá™ÂãïÂåñ">üõ†Ô∏è Â∑•ÂÖ∑/Ëá™ÂãïÂåñ</option><option value="üìù ÂÖßÂÆπÈªûÂ≠ê">üìù ÂÖßÂÆπÈªûÂ≠ê</option><option value="üåü ‰∫∫ÁîüÁõÆÊ®ô">üåü ‰∫∫ÁîüÁõÆÊ®ô</option><option value="ü§î ÂÖ∂‰ªñ">ü§î ÂÖ∂‰ªñ</option></select></div>
                        <div class="form-group"><label class="form-label">Priority</label><select class="form-input" id="idea-priority"><option value="üî• È´ò">üî• È´ò</option><option value="‚≠ê ‰∏≠" selected>‚≠ê ‰∏≠</option><option value="üìå ‰Ωé">üìå ‰Ωé</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label class="form-label">Notes</label><input type="text" class="form-input" id="idea-notes" placeholder="Optional notes..."></div>
                    </div>
                    <div class="form-actions"><button class="btn btn-accent" onclick="saveIdea()">Save</button></div>
                </div>
                <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                    <button class="btn ideas-filter-btn active" data-filter="all" onclick="setIdeasFilter('all')">All</button>
                    <button class="btn ideas-filter-btn" data-filter="new" onclick="setIdeasFilter('new')">üí° New</button>
                    <button class="btn ideas-filter-btn" data-filter="research" onclick="setIdeasFilter('research')">üîç Research</button>
                    <button class="btn ideas-filter-btn" data-filter="active" onclick="setIdeasFilter('active')">üöÄ Active</button>
                    <button class="btn ideas-filter-btn" data-filter="done" onclick="setIdeasFilter('done')">‚úÖ Done</button>
                    <div id="ideas-stats" style="margin-left:auto;font-size:12px;color:var(--text-muted);display:flex;gap:12px;"></div>
                </div>
                <div id="ideas-list"></div>
            </div>
        </section>

        <!-- INFORMATION -->
        <section class="section" id="information">
            <div class="header">
                <div class="page-title">Information</div>
                <div class="header-actions">
                    <button class="btn" onclick="go('dashboard')">‚Üê Back</button>
                    <button class="btn" onclick="window.open('https://youtube-lab.vercel.app/','_blank')">Open in New Tab ‚Üó</button>
                    <button class="btn btn-accent" onclick="window.open('https://www.notion.so/76fb8600ae9649bcb6c475f75f0ec818','_blank')">Notion</button>
                </div>
            </div>
            <div class="content" style="padding:0;height:calc(100vh - 80px);">
                <iframe src="https://youtube-lab.vercel.app/" style="width:100%;height:100%;border:none;"></iframe>
            </div>
        </section>
    </main>

    <div class="toast" id="toast">Saved</div>

    <!-- MODALS -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-title">Settings</div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">Notion API TokenÔºàÁõ¥Êé•ÂêåÊ≠•ÔºåÊé®Ëñ¶Ôºâ</label>
                <input type="password" class="form-input" id="notion-token" placeholder="ntn_xxxxx...">
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">ÂèñÂæóÊñπÂºèÔºö<a href="https://www.notion.so/my-integrations" target="_blank" style="color:var(--accent);">notion.so/my-integrations</a> ‚Üí Âª∫Á´ã Integration ‚Üí Ë§áË£Ω Token ‚Üí Ë®òÂæóÂú®Ë≥áÊñôÂ∫´ÈÄ£Êé• Integration</div>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">Notion ÂêåÊ≠•ÁãÄÊÖã</label>
                <div id="notion-direct-status" style="font-size:12px;color:var(--text-dim);padding:8px 0;">Êú™Ë®≠ÂÆö</div>
                <button class="btn btn-small" onclick="testNotionDirect()" style="margin-top:4px;">üîç Ê∏¨Ë©¶ Notion ÈÄ£Á∑ö</button>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">n8n Webhook URLÔºàÈÄ≤ÈöéÔºåÂèØÈÅ∏Ôºâ</label>
                <input type="text" class="form-input" id="n8n-webhook" placeholder="https://your-n8n.com/webhook/rayos-sync">
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Ëã•‰∏ç‰ΩøÁî® Notion TokenÔºåÂèØÁî® n8n ‰∏≠ËΩâ„ÄÇÊúâ Notion Token ÊôÇÊ≠§Ê¨ÑÂèØÁïôÁ©∫</div>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">n8n ÂêåÊ≠•ÁãÄÊÖã</label>
                <div id="worker-status" style="font-size:12px;color:var(--text-dim);padding:8px 0;">Êú™Ë®≠ÂÆö</div>
                <button class="btn btn-small" onclick="testN8nConnection()" style="margin-top:4px;">üîç Test n8n</button>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">Anthropic API Key (Claude AI Coach)</label>
                <input type="password" class="form-input" id="anthropic-key" placeholder="sk-ant-...">
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">ÂèñÂæóÊñπÂºèÔºö<a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent);">console.anthropic.com</a> ‚Üí API Keys</div>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">AI ModelÔºàÊ®°ÂûãÈÅ∏ÊìáÔºâ</label>
                <select class="form-input" id="ai-model">
                    <option value="claude-haiku-4-5-20251001">Haiku 4.5 ‚Äî ÊúÄÂø´„ÄÅÊúÄÁúÅ üí∞</option>
                    <option value="claude-sonnet-4-20250514" selected>Sonnet 4 ‚Äî ÂùáË°°Êé®Ëñ¶ ‚ö°</option>
                    <option value="claude-sonnet-4-5-20250514">Sonnet 4.5 ‚Äî Êõ¥Âº∑Êé®ÁêÜ üß†</option>
                </select>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Haiku ‚âà Sonnet ÁöÑ 1/10 ÂÉπÊ†ºÔºåÊó•Â∏∏ËøΩËπ§Âª∫Ë≠∞ÂæàÂ§†Áî®</div>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
                <label class="form-label">üéØ Personal Profile & GoalsÔºàAI ÊúÉËÆÄÂèñÈÄôÊÆµ‰æÜ‰∫ÜËß£‰Ω†Ôºâ</label>
                <textarea class="form-input" id="ai-profile" rows="6" placeholder="ÁØÑ‰æãÔºö
ÊàëÊòØ RayÔºå28Ê≠≤Ôºå‰ΩèÂú®Âè∞‰∏≠„ÄÇ
2026 ÁõÆÊ®ôÔºö
- Ë≥áÁî¢ÈÅîÂà∞ 650 Ëê¨ TWD
- È´îËÑÇÈôçÂà∞ 15% ‰ª•‰∏ãÔºåËÇåËÇâÈáèÁ∂≠ÊåÅ 37kg+
- Á®ãÂºè‰∫§ÊòìÂπ¥ÂåñÂ†±ÈÖ¨ > 50%
- Skool Á§æÁæ§‰ªòË≤ªÊúÉÂì°ÈÅî 100 ‰∫∫
- ÊØèÂ§©Â†ÖÊåÅ 6 ÂÄãÁøíÊÖ£

ÊàëÁöÑÊåëÊà∞ÔºöÂÆπÊòìÂú®ÈÄ±Êú´È¨ÜÊáàÔºå‰∫§ÊòìÂÆπÊòìËøΩÈ´ò
ÊàëÂ∏åÊúõ AIÔºöÁõ¥Êé•„ÄÅ‰∏çË¶ÅÂÆ¢Â•ó„ÄÅÁî®Êï∏ÊìöË™™Ë©±"></textarea>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">ÂØ´‰∏ã‰Ω†ÁöÑÁõÆÊ®ô„ÄÅÊåëÊà∞„ÄÅÂÅèÂ•Ω ‚Äî AI Coach ÊúÉÊ†πÊìöÈÄô‰∫õ + ‰Ω†ÁöÑÂØ¶ÈöõÊï∏ÊìöÁµ¶Âª∫Ë≠∞</div>
            </div>
            <div class="form-group" style="margin-bottom:16px;"><label class="form-label">Data</label><button class="btn btn-danger" onclick="resetData()" style="width:100%;margin-top:6px;">üîÑ Reset to Demo Data</button></div>
            <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:16px;">
                <div class="form-title" style="font-size:14px;">üñºÔ∏è Moodboard ‚Äî Google Drive</div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label class="form-label">Google Apps Script URL</label>
                    <input type="text" class="form-input" id="drive-script-url" placeholder="https://script.google.com/macros/s/xxx/exec">
                    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Ë≤º‰∏äÈÉ®ÁΩ≤Â•ΩÁöÑ Apps Script URLÔºåMoodboard ÊúÉËá™ÂãïÂæû Google Drive ÊäìÂúñ</div>
                </div>
                <details style="margin-bottom:12px;">
                    <summary style="font-size:11px;color:var(--accent);cursor:pointer;margin-bottom:8px;">üìñ Ë®≠ÂÆöÊïôÂ≠∏ÔºàÂè™ÈúÄÂÅö‰∏ÄÊ¨°Ôºâ</summary>
                    <div style="font-size:11px;color:var(--text-dim);line-height:1.8;padding:12px;background:var(--bg-input);border:1px solid var(--border);">
                        <strong>Step 1ÔºöÂª∫Á´ã Google Drive Ë≥áÊñôÂ§æ</strong><br>
                        Âª∫‰∏ÄÂÄãË≥áÊñôÂ§æÂè´ <code style="color:var(--accent);">RayOS Moodboard</code><br>
                        Ë£°Èù¢Âª∫Â≠êË≥áÊñôÂ§æÔºöCars, Fitness, Nature, Trading, Wealth, Food, Architecture, Lifestyle ...<br>
                        Áõ¥Êé•ÊääÊâãÊ©üÁÖßÁâá‰∏üÈÄ≤Â∞çÊáâË≥áÊñôÂ§æÂ∞±Â•ΩÔºÅ<br><br>
                        <strong>Step 2ÔºöÂàÜ‰∫´Ë≥áÊñôÂ§æ</strong><br>
                        Âè≥Èçµ‰∏ªË≥áÊñôÂ§æ ‚Üí ÂÖ±Áî® ‚Üí „ÄåÁü•ÈÅìÈÄ£ÁµêÁöÑ‰∫∫ÈÉΩËÉΩÊü•Áúã„Äç<br><br>
                        <strong>Step 3ÔºöÂª∫Á´ã Apps Script</strong><br>
                        Âéª <a href="https://script.google.com" target="_blank" style="color:var(--accent);">script.google.com</a> ‚Üí Êñ∞Âª∫Â∞àÊ°à<br>
                        Êää‰∏ãÈù¢ÁöÑÁ®ãÂºèÁ¢ºÂÖ®ÈÉ®Ë≤º‰∏äÂéªÔºàÂèñ‰ª£ÂéüÊú¨ÁöÑÔºâ<br><br>
                        <strong>Step 4ÔºöÈÉ®ÁΩ≤</strong><br>
                        ÈªûÂè≥‰∏ä„ÄåÈÉ®ÁΩ≤„Äç‚Üí„ÄåÊñ∞Â¢ûÈÉ®ÁΩ≤„Äç‚Üí È°ûÂûãÈÅ∏„ÄåÁ∂≤È†ÅÊáâÁî®Á®ãÂºè„Äç<br>
                        Âü∑Ë°åË∫´ÂàÜÔºö<code style="color:var(--accent);">Êàë</code>„ÄÄÂ≠òÂèñÊ¨äÈôêÔºö<code style="color:var(--accent);">ÊâÄÊúâ‰∫∫</code><br>
                        Ë§áË£ΩÁî¢ÁîüÁöÑ URL Ë≤ºÂà∞‰∏äÈù¢Ê¨Ñ‰Ωç<br><br>
                        <strong>Apps Script Á®ãÂºèÁ¢ºÔºö</strong><br>
                        <button class="btn btn-small" onclick="copyDriveScript()" style="margin:4px 0;">üìã Ë§áË£ΩÁ®ãÂºèÁ¢º</button>
                        <pre id="drive-script-code" style="font-size:10px;color:var(--text-dim);white-space:pre-wrap;margin-top:8px;padding:8px;background:var(--bg);border:1px solid var(--border);max-height:200px;overflow-y:auto;">function doGet(e) {
  var FOLDER_ID = 'YOUR_FOLDER_ID_HERE';
  var folder = DriveApp.getFolderById(FOLDER_ID);
  var images = [];
  var bodyProgress = {};  // { "2026-02-06": [url1, url2], ... }
  
  var subs = folder.getFolders();
  while (subs.hasNext()) {
    var sub = subs.next();
    var cat = sub.getName();
    
    // Body Progress: scan date subfolders
    if (cat === 'Body Progress') {
      var dateFolders = sub.getFolders();
      while (dateFolders.hasNext()) {
        var dateFolder = dateFolders.next();
        var dateKey = dateFolder.getName(); // e.g. "2026-02-06"
        bodyProgress[dateKey] = [];
        var bFiles = dateFolder.getFiles();
        while (bFiles.hasNext()) {
          var bf = bFiles.next();
          if (bf.getMimeType().indexOf('image') === 0) {
            bodyProgress[dateKey].push(
              'https://lh3.googleusercontent.com/d/' + bf.getId() + '=s1200'
            );
          }
        }
      }
      continue; // skip adding to moodboard
    }
    
    // Normal moodboard category
    var files = sub.getFiles();
    while (files.hasNext()) {
      var f = files.next();
      if (f.getMimeType().indexOf('image') === 0) {
        images.push({
          url: 'https://lh3.googleusercontent.com/d/' + f.getId() + '=s1200',
          category: cat,
          name: f.getName()
        });
      }
    }
  }
  
  var rootFiles = folder.getFiles();
  while (rootFiles.hasNext()) {
    var f = rootFiles.next();
    if (f.getMimeType().indexOf('image') === 0) {
      images.push({
        url: 'https://lh3.googleusercontent.com/d/' + f.getId() + '=s1200',
        category: 'Other',
        name: f.getName()
      });
    }
  }
  
  return ContentService
    .createTextOutput(JSON.stringify({
      images: images,
      bodyProgress: bodyProgress,
      count: images.length
    }))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
                    </div>
                </details>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-small" onclick="testDriveConnection()">üîç Ê∏¨Ë©¶ÈÄ£Á∑ö</button>
                    <button class="btn btn-small" onclick="syncMoodboardFromDrive()">üîÑ ÊâãÂãïÂêåÊ≠•</button>
                    <span id="drive-status" style="font-size:11px;color:var(--text-dim);">Êú™Ë®≠ÂÆö</span>
                </div>
            </div>
            <div class="form-actions"><button class="btn" onclick="hideModal('settings-modal')">Cancel</button><button class="btn btn-accent" onclick="saveSettings()">Save</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="account-modal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-title">Manage Accounts</div>
            <div id="account-manager-list" style="max-height:300px;overflow-y:auto;margin-bottom:16px;"></div>
            <div class="form-section" style="margin:0;">
                <div class="form-title">Add New Account</div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="new-account-name" placeholder="Account name"></div>
                    <div class="form-group"><label class="form-label">Platform</label><input type="text" class="form-input" id="new-account-platform" placeholder="Bank"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Category</label><select class="form-input" id="new-account-category"><option value="ÂÇôÁî®Èáë">üíµ ÂÇôÁî®Èáë</option><option value="Ê¥ªÊúüÂ≠òÊ¨æ">üè¶ Ê¥ªÊúüÂ≠òÊ¨æ</option><option value="ËÇ°Á•®ETF">üìà ËÇ°Á•®/ETF</option><option value="Âä†ÂØÜË≤®Âπ£">ü™ô Âä†ÂØÜË≤®Âπ£</option><option value="ÂÇµÂãô">üí≥ ÂÇµÂãô</option></select></div>
                    <div class="form-group"><label class="form-label">Currency</label><select class="form-input" id="new-account-currency"><option value="TWD">TWD</option><option value="USD">USD</option><option value="USDT">USDT</option></select></div>
                </div>
                <div class="form-actions"><button class="btn btn-accent" onclick="addAccount()">Add</button></div>
            </div>
            <div class="form-actions" style="margin-top:16px;"><button class="btn" onclick="hideModal('account-modal')">Close</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="quote-modal">
        <div class="modal">
            <div class="modal-title">Edit Quote</div>
            <div class="form-group" style="margin-bottom:12px;"><label class="form-label">Quote</label><textarea class="form-input" id="quote-text-input" rows="3"></textarea></div>
            <div class="form-group" style="margin-bottom:16px;"><label class="form-label">Author</label><input type="text" class="form-input" id="quote-author-input"></div>
            <div class="form-actions"><button class="btn" onclick="hideModal('quote-modal')">Cancel</button><button class="btn btn-accent" onclick="saveQuote()">Save</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="goal-modal">
        <div class="modal">
            <div class="modal-title">Edit Wealth Goal</div>
            <div class="form-group" style="margin-bottom:16px;"><label class="form-label">2026 Target (TWD)</label><input type="number" class="form-input" id="wealth-goal-input" placeholder="6500000"></div>
            <div class="form-actions"><button class="btn" onclick="hideModal('goal-modal')">Cancel</button><button class="btn btn-accent" onclick="saveGoal()">Save</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="physic-goal-modal">
        <div class="modal">
            <div class="modal-title">Edit Body Fat Goal</div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Start Fat %</label><input type="number" step="0.1" class="form-input" id="physic-start-input" placeholder="21"></div>
                <div class="form-group"><label class="form-label">Target Fat %</label><input type="number" step="0.1" class="form-input" id="physic-target-input" placeholder="15"></div>
            </div>
            <div class="form-group" style="margin-top:12px;"><label class="form-label">Height (cm) for BMI</label><input type="number" step="0.1" class="form-input" id="physic-height-input" placeholder="175"></div>
            <div class="form-actions" style="margin-top:16px;"><button class="btn" onclick="hideModal('physic-goal-modal')">Cancel</button><button class="btn btn-accent" onclick="savePhysicGoal()">Save</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="photo-manager-modal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-title">Manage Photos</div>
            <div id="photo-manager-list" style="max-height:400px;overflow-y:auto;"></div>
            <div class="form-actions" style="margin-top:16px;"><button class="btn" onclick="hideModal('photo-manager-modal')">Close</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="business-modal">
        <div class="modal">
            <div class="modal-title">Add Business</div>
            <div class="form-group" style="margin-bottom:12px;"><label class="form-label">Name</label><input type="text" class="form-input" id="new-biz-name" placeholder="Business name"></div>
            <div class="form-group" style="margin-bottom:12px;"><label class="form-label">Icon</label><input type="text" class="form-input" id="new-biz-icon" placeholder="üè¢"></div>
            <div class="form-actions"><button class="btn" onclick="hideModal('business-modal')">Cancel</button><button class="btn btn-accent" onclick="addBusiness()">Add</button></div>
        </div>
    </div>

    <script>
        // ==================== PRELOAD DATA ====================
        const PRELOAD_WEALTH_HISTORY = [
            { date: '2023-10-04', totalAssets: 193010, netWorth: -26980, monthlyGrowth: null, categories: { 'Ê¥ªÊúüÂ≠òÊ¨æ': 0, 'ËÇ°Á•®ETF': 0, 'Âä†ÂØÜË≤®Âπ£': 0, 'ÂÇµÂãô': 0 } },
            { date: '2024-09-30', totalAssets: 698106, netWorth: 396511, monthlyGrowth: 67.64, categories: { 'Ê¥ªÊúüÂ≠òÊ¨æ': 388871, 'ËÇ°Á•®ETF': 18193, 'Âä†ÂØÜË≤®Âπ£': 50763, 'ÂÇµÂãô': 301595 } },
            { date: '2024-12-31', totalAssets: 1485956, netWorth: 1194361, monthlyGrowth: 11.50, categories: { 'Ê¥ªÊúüÂ≠òÊ¨æ': 609953, 'ËÇ°Á•®ETF': 16955, 'Âä†ÂØÜË≤®Âπ£': 58548, 'ÂÇµÂãô': 291595 } },
            { date: '2025-06-30', totalAssets: 3753106, netWorth: 3567863, monthlyGrowth: 6.14, categories: { 'Ê¥ªÊúüÂ≠òÊ¨æ': 1250488, 'ËÇ°Á•®ETF': 1769422, 'Âä†ÂØÜË≤®Âπ£': 733196, 'ÂÇµÂãô': 185243 } },
            { date: '2025-12-31', totalAssets: 3398914, netWorth: 3233505, monthlyGrowth: -3.20, categories: { 'Ê¥ªÊúüÂ≠òÊ¨æ': 1466884, 'ËÇ°Á•®ETF': 1556503, 'Âä†ÂØÜË≤®Âπ£': 375527, 'ÂÇµÂãô': 165409 } },
            { date: '2026-01-31', totalAssets: 4113482, netWorth: 3950411, monthlyGrowth: 21.02, categories: { 'Ê¥ªÊúüÂ≠òÊ¨æ': 2088372, 'ËÇ°Á•®ETF': 1677624, 'Âä†ÂØÜË≤®Âπ£': 347486, 'ÂÇµÂãô': 163071 } }
        ];

        const PRELOAD_BODY_HISTORY = [
            // Verified from Notion Physic Tracker 2026-02-06 (fallback until n8n fetch_body is configured)
            { date: '2025-03-08', weight: 78.3, muscle: 35.4, fatpct: 21.0, notes: 'Starting point' },
            { date: '2025-08-11', weight: 80.3, muscle: 37.6, fatpct: 18.3, notes: '' },
            { date: '2026-01-02', weight: 79.8, muscle: 37.0, fatpct: 19.2, notes: '' }
        ];

        // Notion DB: 58da82d6-89ed-4202-9274-234183f77bb6
        // Fallback data ‚Äî È†ÅÈù¢ËºâÂÖ•ÊôÇËã•ÊúâË®≠ÂÆö n8n webhook ÊúÉËá™ÂãïË¶ÜËìã
        // Daily habits: no preload data, fetched from Notion on init

        const PRELOAD_ALGO_EQUITY = [
            { date: '2026-01-27', equity: 1372157, dailyRet: 2.04, cumRet: 47.02 },
            { date: '2026-01-28', equity: 1402547, dailyRet: 2.21, cumRet: 50.28 },
            { date: '2026-01-29', equity: 1390467, dailyRet: -0.86, cumRet: 48.99 },
            { date: '2026-01-30', equity: 1345533, dailyRet: -3.23, cumRet: 44.17 },
            { date: '2026-02-02', equity: 1295151, dailyRet: -3.74, cumRet: 38.77 },
            { date: '2026-02-03', equity: 1435231, dailyRet: 3.09, cumRet: 43.07 }
        ];

        const MONTHLY_RETURNS = {
            2025: { 1: -1.59, 2: -10.14, 3: 23.98, 4: 10.10, 5: 3.62, 6: -6.38, 7: 1.23, 8: -6.45, 9: 0.28, 10: 4.32, 11: 17.92, 12: -5.68, ytd: 31.32 },
            2026: { 1: 15.83, ytd: 15.83 }
        };

        // ==================== CONFIG ====================
        const USD_RATE = 32.5, USDT_RATE = 32.5;
        const CATEGORY_ICONS = {'ÂÇôÁî®Èáë':'üíµ','Ê¥ªÊúüÂ≠òÊ¨æ':'üè¶','ËÇ°Á•®ETF':'üìà','Âä†ÂØÜË≤®Âπ£':'ü™ô','ÂÇµÂãô':'üí≥'};
        const DEFAULT_ACCOUNTS = [
            {name:'Âè∞Êñ∞‰∏ªÂ∏≥Êà∂',platform:'Âè∞Êñ∞',category:'Ê¥ªÊúüÂ≠òÊ¨æ',currency:'TWD'},
            {name:'WISE',platform:'WISE',category:'Ê¥ªÊúüÂ≠òÊ¨æ',currency:'USD'},
            {name:'IB Èï∑ÊúüÊäïË≥á',platform:'IB',category:'ËÇ°Á•®ETF',currency:'USD'},
            {name:'Âπ£ÂÆâ',platform:'Binance',category:'Âä†ÂØÜË≤®Âπ£',currency:'USDT'},
            {name:'‰ø°Áî®Ë≤∏Ê¨æ_ÁéãÈÅì',platform:'ÁéãÈÅìÈäÄË°å',category:'ÂÇµÂãô',currency:'TWD'}
        ];

        // ==================== MOODBOARD SYSTEM ====================
        const DEFAULT_MOODBOARD_IMAGES = [
            'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=800&q=80',
            'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=800&q=80',
            'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=800&q=80',
            'https://images.unsplash.com/photo-1549719386-74dfcbf7dbed?w=800&q=80',
            'https://images.unsplash.com/photo-1544636331-e26879cd4d9b?w=800&q=80',
            'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&q=80',
            'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80',
            'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=800&q=80',
            'https://images.unsplash.com/photo-1514565131-fce0801e5785?w=800&q=80',
            'https://images.unsplash.com/photo-1523170335258-f5ed11844a49?w=800&q=80',
            'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800&q=80',
            'https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=800&q=80',
            'https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=800&q=80',
            'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800&q=80',
            'https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=800&q=80'
        ];

        // Seeded random for consistent daily results
        function seedHash(str) {
            let h = 0;
            for (let i = 0; i < str.length; i++) { h = ((h << 5) - h) + str.charCodeAt(i); h |= 0; }
            return Math.abs(h);
        }

        function seededShuffle(arr, seed) {
            const a = [...arr];
            let s = seedHash(seed);
            for (let i = a.length - 1; i > 0; i--) {
                s = (s * 1103515245 + 12345) & 0x7fffffff;
                const j = s % (i + 1);
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function getMoodboardImages() {
            try {
                const cached = JSON.parse(localStorage.getItem('moodboard_images') || '[]');
                if (cached.length > 0) return cached;
            } catch(e) {}
            return DEFAULT_MOODBOARD_IMAGES;
        }

        function renderMoodboard(forceSeed) {
            const allImages = getMoodboardImages();
            if (allImages.length < 4) return;

            const today = forceSeed || new Date().toISOString().split('T')[0];
            const shuffled = seededShuffle(allImages, today);
            const count = Math.min(shuffled.length, 8);
            const urls = shuffled.slice(0, count);

            const promises = urls.map(url => new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve({ url, ratio: img.naturalWidth / img.naturalHeight });
                img.onerror = () => resolve({ url, ratio: 4/3 });
                img.src = url;
            }));

            Promise.all(promises).then(photos => justifiedLayout(photos));

            const countEl = document.getElementById('moodboard-count');
            if (countEl) {
                const src = localStorage.getItem('drive_script_url') ? 'üì∑ Drive' : 'üñºÔ∏è Default';
                countEl.textContent = `${src} ¬∑ ${allImages.length} photos`;
            }
        }

        function justifiedLayout(photos) {
            const grid = document.getElementById('moodboard-grid');
            const containerWidth = grid.offsetWidth;
            const GAP = 3;

            // Force 2 rows: find best split point
            // Try every split and pick the one where both rows are closest in height
            const ROW_H = window.innerWidth <= 768 ? 180 : 280;
            let bestSplit = Math.floor(photos.length / 2);
            let bestDiff = Infinity;

            for (let s = 2; s <= photos.length - 2; s++) {
                const r1 = photos.slice(0, s);
                const r2 = photos.slice(s);
                const ratio1 = r1.reduce((sum, p) => sum + p.ratio, 0);
                const ratio2 = r2.reduce((sum, p) => sum + p.ratio, 0);
                const h1 = (containerWidth - GAP * (r1.length - 1)) / ratio1;
                const h2 = (containerWidth - GAP * (r2.length - 1)) / ratio2;
                const diff = Math.abs(h1 - h2);
                if (diff < bestDiff) { bestDiff = diff; bestSplit = s; }
            }

            const rows = [photos.slice(0, bestSplit), photos.slice(bestSplit)];
            let html = '';
            let idx = 0;

            rows.forEach(row => {
                const totalRatio = row.reduce((sum, p) => sum + p.ratio, 0);
                const totalGaps = GAP * (row.length - 1);
                const rowHeight = (containerWidth - totalGaps) / totalRatio;

                row.forEach(photo => {
                    const w = rowHeight * photo.ratio;
                    html += `<div class="mood-item" style="width:${w}px;height:${rowHeight}px;animation-delay:${idx * 0.06}s"><img src="${photo.url}" alt="" loading="lazy"></div>`;
                    idx++;
                });
            });

            grid.innerHTML = html;
        }

        let moodResizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(moodResizeTimer);
            moodResizeTimer = setTimeout(() => renderMoodboard(), 300);
        });

        function refreshMoodboard() {
            renderMoodboard(Date.now().toString());
        }

        function copyDriveScript() {
            const code = document.getElementById('drive-script-code').textContent;
            navigator.clipboard.writeText(code).then(() => showToast('Á®ãÂºèÁ¢ºÂ∑≤Ë§áË£ΩÔºÅ'));
        }

        async function syncMoodboardFromDrive() {
            const scriptUrl = localStorage.getItem('drive_script_url');
            if (!scriptUrl) { renderMoodboard(); return; }

            const statusEl = document.getElementById('drive-status');
            if (statusEl) statusEl.textContent = '‚è≥ ÂêåÊ≠•‰∏≠...';

            try {
                const response = await fetch(scriptUrl);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();

                if (data && data.images && data.images.length > 0) {
                    const urls = data.images.map(img => img.url);
                    localStorage.setItem('moodboard_images', JSON.stringify(urls));
                    localStorage.setItem('moodboard_drive_data', JSON.stringify(data.images));
                    localStorage.setItem('moodboard_sync_date', new Date().toISOString().split('T')[0]);
                    if (statusEl) statusEl.textContent = '‚úÖ ' + data.images.length + ' ÂºµÂúñÁâá';
                    showToast('üñºÔ∏è Moodboard Â∑≤ÂêåÊ≠• ' + data.images.length + ' ÂºµÂúñÁâá');
                } else {
                    if (statusEl) statusEl.textContent = '‚ö†Ô∏è Ë≥áÊñôÂ§æÊ≤íÊúâÂúñÁâá';
                }

                // Body Progress photos
                if (data && data.bodyProgress) {
                    const normalized = {};
                    Object.keys(data.bodyProgress).forEach(k => { normalized[normDate(k)] = data.bodyProgress[k]; });
                    const dates = Object.keys(normalized).filter(d => normalized[d].length > 0);
                    if (dates.length > 0) {
                        bodyProgressDates = normalized;
                        localStorage.setItem('body_progress_drive', JSON.stringify(data.bodyProgress));
                        loadBodyProgressFromDrive();
                        showToast('üì∑ Body Progress: ' + dates.length + ' dates synced');
                    }
                }
            } catch(e) {
                console.error('Drive sync error:', e);
                if (statusEl) statusEl.textContent = '‚ùå ÈÄ£Á∑öÂ§±Êïó';
                showToast('Drive ÂêåÊ≠•Â§±Êïó: ' + e.message, true);
            }
            renderMoodboard();
        }

        async function testDriveConnection() {
            const url = document.getElementById('drive-script-url').value.replace(/\/+$/, '');
            if (!url) { showToast('Ë´ãÂÖàË≤º‰∏ä Apps Script URL', true); return; }
            localStorage.setItem('drive_script_url', url);
            await syncMoodboardFromDrive();
        }

        // ==================== STATE ====================
        let accounts = JSON.parse(localStorage.getItem('accounts')) || DEFAULT_ACCOUNTS;
        let wealthGoal = parseInt(localStorage.getItem('wealth_goal')) || 6500000;
        let quote = JSON.parse(localStorage.getItem('wealth_quote')) || {text:"Wealth is the ability to fully experience life.",author:"Henry David Thoreau"};
        let wealthChartMode = 'trend';
        let wealthChartType = 'total';
        let wealthChartStyle = 'bar';
        let currentBusiness = 'skool-free';
        let wealthHistory = JSON.parse(JSON.stringify(PRELOAD_WEALTH_HISTORY));
        let bodyHistory = JSON.parse(JSON.stringify(PRELOAD_BODY_HISTORY));
        let bodyPhotos = [];
        let physicGoal = JSON.parse(localStorage.getItem('physic_goal') || '{"start":21,"target":15,"height":175}');
        let bodyNotionIndex = JSON.parse(localStorage.getItem('body_notion_index') || '{}');
        let wealthNotionIndex = JSON.parse(localStorage.getItem('wealth_notion_index') || '{}');
        let algoEquity = JSON.parse(JSON.stringify(PRELOAD_ALGO_EQUITY));
        let propRecords = [];
        let dailyHabitsData = {};

        // Load from localStorage
        try {
            const stored = localStorage.getItem('wealth_history');
            if (stored) { const parsed = JSON.parse(stored); if (parsed.length > 0) wealthHistory = parsed; }
            const storedBody = localStorage.getItem('body_history');
            if (storedBody) { const parsed = JSON.parse(storedBody); if (parsed.length > 0) bodyHistory = parsed; }
            const storedPhotos = localStorage.getItem('body_photos');
            if (storedPhotos) bodyPhotos = JSON.parse(storedPhotos);
            const storedAlgo = localStorage.getItem('algo_equity');
            if (storedAlgo) { const parsed = JSON.parse(storedAlgo); if (parsed.length > 0) algoEquity = parsed; }
            const storedProp = localStorage.getItem('prop_records');
            if (storedProp) propRecords = JSON.parse(storedProp);
            const storedDaily = localStorage.getItem('daily_habits');
            if (storedDaily) { 
                dailyHabitsData = JSON.parse(storedDaily);
            }
        } catch(e) { console.log('localStorage error:', e); }

        // ==================== NAVIGATION ====================
        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
            document.querySelector('.mobile-menu-btn').innerHTML = document.querySelector('.sidebar').classList.contains('open') ? '‚úï' : '‚ò∞';
        }

        function go(section) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`.nav-item[data-section="${section}"]`)?.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section)?.classList.add('active');
            window.scrollTo(0, 0);
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('open');
                document.querySelector('.sidebar-overlay').classList.remove('show');
                document.querySelector('.mobile-menu-btn').innerHTML = '‚ò∞';
            }
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => go(item.dataset.section));
        });

        // ==================== UTILS ====================
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function showModal(id) { document.getElementById(id).classList.add('show'); }
        function hideModal(id) { document.getElementById(id).classList.remove('show'); }
        function formatNumber(n) { return new Intl.NumberFormat('zh-TW').format(Math.round(n)); }
        function formatMoney(n) { if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M'; if (n >= 1000) return Math.round(n / 1000) + 'K'; return formatNumber(n); }
        function toTWD(a, c) { if (c === 'USD') return a * USD_RATE; if (c === 'USDT') return a * USDT_RATE; return a; }

        // ==================== NOTION SYNC SYSTEM ====================
        const NOTION_DB_ID = '58da82d689ed42029274234183f77bb6';
        const BODY_DB_ID = 'f481a3da00de4d9391d293a88cf1c9c1';
        const WEALTH_DB_ID = '127c65e93b7c4008b34c86c285295387';
        const IDEAS_DB_ID = '3d416eb92c484ad3bff54919c3ea43fd';
        const BODY_DS_ID = '6b8fea6a-9249-4a7b-a36e-5cd7f6ceb61f';
        const H2N = {trading:'Trading', advertise:'Advertise', deliver:'Deliver', gym:'Gym', fatloss:'FatLoss', ai:'AI'};
        const NOTION_API = 'https://api.notion.com/v1';
        let notionPageIndex = JSON.parse(localStorage.getItem('notion_page_index') || '{}');
        let syncInProgress = false;

        function getN8nUrl() { return localStorage.getItem('n8n_webhook') || ''; }
        function getNotionToken() { return localStorage.getItem('notion_token') || ''; }
        function hasNotionDirect() { return !!getNotionToken(); }
        function updateSyncDot() {
            const d = document.getElementById('sync-dot');
            if (d) d.className = 'sync-dot ' + ((hasNotionDirect() || getN8nUrl()) ? 'on' : 'off');
        }

        // === Notion API helper (via Vercel serverless proxy to avoid CORS) ===
        async function notionFetch(path, method, body) {
            const token = getNotionToken();
            if (!token) throw new Error('No Notion token');
            const proxyUrl = location.origin + '/api/notion';
            console.log('[RayOS Proxy]', (method || 'POST'), path);
            try {
                const res = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path, method: method || 'POST', body, token })
                });
                if (!res.ok) {
                    const errText = await res.text().catch(() => '');
                    console.error('[RayOS Proxy] Error:', res.status, errText.substring(0, 200));
                    throw new Error('Notion ' + res.status + ': ' + errText.substring(0, 200));
                }
                return res.json();
            } catch (e) {
                if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError') || e.message.includes('Load failed')) {
                    console.error('[RayOS Proxy] Proxy unreachable ‚Äî check Vercel deployment');
                    throw new Error('Proxy \u4e0d\u53ef\u7528 \u2014 \u78ba\u8a8d Vercel \u90e8\u7f72\u6210\u529f');
                }
                throw e;
            }
        }

        // ============ DIRECT NOTION API (Êé®Ëñ¶) ============

        // === Áõ¥Êé•Âæû Notion ÊãâÂèñÂÖ®ÈÉ® Habits ===
        async function syncDailyFromNotionDirect(silent = false) {
            if (!hasNotionDirect()) {
                // Fallback to n8n
                return syncDailyFromNotion(silent);
            }
            if (syncInProgress) return false;
            syncInProgress = true;
            if (!silent) showToast('Ê≠£Âú®Âæû Notion ÂêåÊ≠•...');
            try {
                const data = await notionFetch('/databases/' + NOTION_DB_ID + '/query', 'POST', {
                    page_size: 100,
                    sorts: [{ property: 'Date', direction: 'descending' }]
                });
                const newPageIndex = {};
                let count = 0;
                for (const page of data.results) {
                    const props = page.properties;
                    const titleArr = props['Date']?.title;
                    if (!titleArr || !titleArr[0]) continue;
                    const dateStr = titleArr[0].plain_text;
                    if (!dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) continue;
                    newPageIndex[dateStr] = page.id;
                    dailyHabitsData[dateStr] = {
                        trading: props['Trading']?.checkbox || false,
                        advertise: props['Advertise']?.checkbox || false,
                        deliver: props['Deliver']?.checkbox || props['Deliever']?.checkbox || false,
                        gym: props['Gym']?.checkbox || false,
                        fatloss: props['FatLoss']?.checkbox || props['Fat Loss']?.checkbox || false,
                        ai: props['AI']?.checkbox || false
                    };
                    count++;
                }
                notionPageIndex = newPageIndex;
                localStorage.setItem('notion_page_index', JSON.stringify(notionPageIndex));
                localStorage.setItem('daily_habits', JSON.stringify(dailyHabitsData));
                console.log('[RayOS Direct] Synced', count, 'days, pageIndex:', Object.keys(notionPageIndex).length);
                loadDailyHabits(true); // skipNotionCreate ‚Äî we'll handle it below
                updateSyncDot();
                if (!silent) showToast('‚úì Â∑≤ÂêåÊ≠• ' + count + ' Â§©');
                syncInProgress = false;
                // Auto-create today if not in Notion yet
                const today = new Date().toISOString().split('T')[0];
                if (!notionPageIndex[today]) {
                    console.log('[RayOS Direct] Today', today, 'not in Notion ‚Äî creating');
                    if (!dailyHabitsData[today]) {
                        dailyHabitsData[today] = {trading:false,advertise:false,deliver:false,gym:false,fatloss:false,ai:false};
                        localStorage.setItem('daily_habits', JSON.stringify(dailyHabitsData));
                    }
                    await createDayInNotionDirect(today);
                    loadDailyHabits(true);
                }
                return true;
            } catch (e) {
                console.error('[RayOS Direct] Sync error:', e);
                if (!silent) showToast('Notion ÂêåÊ≠•Â§±Êïó: ' + e.message, true);
                syncInProgress = false;
                return false;
            }
        }

        // === Áõ¥Êé•ÂØ´ÂÖ• Notion checkbox ===
        // NOTE: This function THROWS on error (not catch) so writeHabitToNotion can fallback to N8N
        async function writeHabitToNotionDirect(dateStr, habit, value) {
            const field = H2N[habit];
            if (!field) throw new Error('Unknown habit: ' + habit);
            let pageId = notionPageIndex[dateStr];
            if (!pageId) {
                console.log('[RayOS Direct] No pageId for', dateStr, '‚Äî creating day first');
                await createDayInNotionDirect(dateStr);
                pageId = notionPageIndex[dateStr];
                if (!pageId) throw new Error('Failed to create day ' + dateStr);
            }
            await notionFetch('/pages/' + pageId, 'PATCH', {
                properties: { [field]: { checkbox: !!value } }
            });
            console.log('[RayOS Direct] Updated', dateStr, field, '=', !!value);
        }

        // === Áõ¥Êé•Âú® Notion Âª∫Á´ãÊñ∞ÁöÑ‰∏ÄÂ§© ===
        async function createDayInNotionDirect(dateStr) {
            const habits = dailyHabitsData[dateStr] || {};
            try {
                const props = {
                    'Date': { title: [{ text: { content: dateStr } }] },
                    'Trading': { checkbox: !!habits.trading },
                    'Advertise': { checkbox: !!habits.advertise },
                    'Deliver': { checkbox: !!habits.deliver },
                    'Gym': { checkbox: !!habits.gym },
                    'FatLoss': { checkbox: !!habits.fatloss },
                    'AI': { checkbox: !!habits.ai }
                };
                // Add date property
                props['\u65e5\u671f'] = { date: { start: dateStr } };
                const page = await notionFetch('/pages', 'POST', {
                    parent: { database_id: NOTION_DB_ID },
                    properties: props
                });
                notionPageIndex[dateStr] = page.id;
                localStorage.setItem('notion_page_index', JSON.stringify(notionPageIndex));
                console.log('[RayOS Direct] Created day:', dateStr, '‚Üí', page.id);
            } catch (e) {
                console.error('[RayOS Direct] Create error:', e);
                showToast('Notion Âª∫Á´ãÂ§±Êïó: ' + e.message, true);
            }
        }

        // === Ê∏¨Ë©¶ Notion Áõ¥Êé•ÈÄ£Á∑ö ===
        async function testNotionDirect() {
            const token = document.getElementById('notion-token').value;
            const statusEl = document.getElementById('notion-direct-status');
            if (!token) { statusEl.innerHTML = '‚ùå Ë´ãÂ°´ÂÖ• Notion API Token'; return; }
            statusEl.textContent = '‚è≥ Ê∏¨Ë©¶‰∏≠...';
            try {
                // Temporarily save token so notionFetch can use it
                const oldToken = localStorage.getItem('notion_token');
                localStorage.setItem('notion_token', token);
                const data = await notionFetch('/databases/' + NOTION_DB_ID + '/query', 'POST', { page_size: 1 });
                if (!oldToken) localStorage.removeItem('notion_token'); else localStorage.setItem('notion_token', oldToken);
                statusEl.innerHTML = '‚úÖ <span style="color:var(--success);">Notion ÈÄ£Á∑öÊàêÂäüÔºÅDaily Habits DB ÂèØÂ≠òÂèñ</span>';
            } catch (e) {
                statusEl.innerHTML = '‚ùå ÈÄ£Á∑öÂ§±Êïó: ' + e.message + '<br><small>Á¢∫Ë™ç Token Ê≠£Á¢∫Ôºå‰∏î Integration Â∑≤ÈÄ£Êé•Âà∞Ë≥áÊñôÂ∫´</small>';
            }
        }

        // ============ N8N FALLBACK (ÈÄ≤Èöé) ============

        // === Âæû Notion ÊãâÂèñÂÖ®ÈÉ® HabitsÔºàÁ∂ì n8nÔºâ===
        async function syncDailyFromNotion(silent = false) {
            const url = getN8nUrl();
            if (!url) { if (!silent) showToast('Ë´ãÂÖàÂú® Settings Ë®≠ÂÆö Notion Token Êàñ n8n URL', true); return false; }
            if (syncInProgress) return false;
            syncInProgress = true;
            if (!silent) showToast('Ê≠£Âú®Âæû Notion ÂêåÊ≠•...');
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'fetch_habits' })
                });
                if (!res.ok) throw new Error('n8n returned ' + res.status);
                const data = await res.json();
                if (data.habits) {
                    notionPageIndex = data.pageIndex || {};
                    localStorage.setItem('notion_page_index', JSON.stringify(notionPageIndex));
                    console.log('[RayOS n8n] Synced pageIndex:', Object.keys(notionPageIndex).length, 'entries');
                    if (!data.pageIndex) console.warn('[RayOS n8n] Response missing pageIndex ‚Äî update_habit will fail');
                    Object.keys(data.habits).forEach(dateStr => {
                        const nd = data.habits[dateStr];
                        dailyHabitsData[dateStr] = {
                            trading: nd.Trading || nd.trading || false,
                            advertise: nd.Advertise || nd.advertise || false,
                            deliver: nd.Deliver || nd.Deliever || nd.deliver || false,
                            gym: nd.Gym || nd.gym || false,
                            fatloss: nd.FatLoss || nd['Fat Loss'] || nd.fatloss || false,
                            ai: nd.AI || nd.ai || false
                        };
                    });
                    localStorage.setItem('daily_habits', JSON.stringify(dailyHabitsData));
                    loadDailyHabits();
                    updateSyncDot();
                    if (!silent) showToast('‚úì Â∑≤ÂêåÊ≠• ' + data.count + ' Â§©');
                    syncInProgress = false;
                    return true;
                }
                throw new Error('ÁÑ°ÊïàÂõûÊáâ');
            } catch (e) {
                console.error('[RayOS n8n] Sync error:', e);
                if (!silent) showToast('n8n ÂêåÊ≠•Â§±Êïó: ' + e.message, true);
                syncInProgress = false;
                return false;
            }
        }

        // === ÂãæÈÅ∏ÂæåÂç≥ÊôÇÂØ´Âõû NotionÔºàDirect ÂÑ™ÂÖàÔºåÂ§±Êïó fallback N8NÔºâ===
        async function writeHabitToNotion(dateStr, habit, value) {
            const field = H2N[habit];
            if (!field) return;

            // 1. ÂÑ™ÂÖàÂòóË©¶ Notion Direct API
            if (hasNotionDirect()) {
                try {
                    console.log('[RayOS] Trying Notion Direct for', habit, '=', value);
                    await writeHabitToNotionDirect(dateStr, habit, value);
                    return; // ÊàêÂäüÂ∞±ÁµêÊùü
                } catch (e) {
                    console.warn('[RayOS] Notion Direct failed, trying N8N fallback:', e.message);
                }
            }

            // 2. Fallback: N8N
            const url = getN8nUrl();
            if (!url) {
                showToast('Notion ÂêåÊ≠•Â§±ÊïóÔºöÁÑ°ÂèØÁî®ÈÄ£Á∑ö', true);
                return;
            }
            console.log('[RayOS] Using N8N for', habit, '=', value);
            let pageId = notionPageIndex[dateStr];
            if (!pageId) {
                console.log('[RayOS n8n] No pageId for', dateStr, '‚Äî creating day first');
                await createDayInNotionN8N(dateStr);
                pageId = notionPageIndex[dateStr];
                if (!pageId) {
                    showToast('Notion ÂêåÊ≠•Â§±ÊïóÔºöÁÑ°Ê≥ïÂèñÂæó pageId', true);
                    return;
                }
            }
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'update_habit', pageId, field, value: !!value })
                });
                if (!res.ok) {
                    console.warn('[RayOS n8n] update_habit failed:', res.status);
                    showToast('Notion Êõ¥Êñ∞Â§±Êïó: ' + res.status, true);
                } else {
                    console.log('[RayOS n8n] Updated', dateStr, field, '=', !!value);
                }
            } catch (e) {
                console.error('[RayOS n8n] Write error:', e);
                showToast('Notion ÂØ´ÂÖ•ÈåØË™§', true);
            }
        }

        // === Âú® Notion Âª∫Á´ãÊñ∞ÁöÑ‰∏ÄÂ§©ÔºàDirect ÂÑ™ÂÖàÔºåÂ§±Êïó fallback N8NÔºâ===
        async function createDayInNotion(dateStr) {
            // 1. ÂÑ™ÂÖàÂòóË©¶ Notion Direct
            if (hasNotionDirect()) {
                try {
                    await createDayInNotionDirect(dateStr);
                    return;
                } catch (e) {
                    console.warn('[RayOS] Direct create failed, trying N8N:', e.message);
                }
            }
            // 2. Fallback: N8N
            await createDayInNotionN8N(dateStr);
        }

        // === N8N: Âª∫Á´ãÊñ∞ÁöÑ‰∏ÄÂ§© ===
        async function createDayInNotionN8N(dateStr) {
            const url = getN8nUrl();
            if (!url) return;
            const habits = {};
            Object.entries(dailyHabitsData[dateStr] || {}).forEach(([k, v]) => { habits[H2N[k] || k] = v; });
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'create_day', date: dateStr, habits, dateProperty: dateStr })
                });
                const data = await res.json();
                if (data.pageId) {
                    notionPageIndex[dateStr] = data.pageId;
                    localStorage.setItem('notion_page_index', JSON.stringify(notionPageIndex));
                    console.log('[RayOS n8n] Created day:', dateStr, '‚Üí', data.pageId);
                } else {
                    console.warn('[RayOS n8n] create_day response missing pageId:', data);
                }
            } catch (e) { console.error('[RayOS n8n] Create error:', e); }
        }

        // === Ê∏¨Ë©¶ n8n ÈÄ£Á∑ö ===
        async function testN8nConnection() {
            const url = document.getElementById('n8n-webhook').value.replace(/\/+$/, '');
            const statusEl = document.getElementById('worker-status');
            if (!url) { statusEl.innerHTML = '‚ùå Ë´ãÂ°´ÂÖ• n8n Webhook URL'; return; }
            statusEl.textContent = '‚è≥ Ê∏¨Ë©¶‰∏≠...';
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'fetch_habits' })
                });
                const data = await res.json();
                if (data.habits) {
                    const hasPageIndex = data.pageIndex && Object.keys(data.pageIndex).length > 0;
                    statusEl.innerHTML = '‚úÖ <span style="color:var(--success);">ÈÄ£Á∑öÊàêÂäüÔºÅÂèñÂæó ' + data.count + ' Á≠ÜË≥áÊñô</span>' +
                        (hasPageIndex ? ' (pageIndex ‚úì)' : ' <span style="color:var(--warning);">‚ö†Ô∏è Áº∫Â∞ë pageIndex ‚Äî ÂãæÈÅ∏Êõ¥Êñ∞ÂèØËÉΩÁÑ°Ê≥ïÈÅã‰Ωú</span>');
                } else if (data.status === 'ok') {
                    statusEl.innerHTML = '‚úÖ <span style="color:var(--success);">ÈÄ£Á∑öÊàêÂäüÔºÅ</span>';
                } else {
                    statusEl.innerHTML = '‚ö†Ô∏è Êî∂Âà∞ÂõûÊáâ‰ΩÜÊ†ºÂºè‰∏çÁ¨¶È†êÊúü ‚Äî Ë´ãÁ¢∫Ë™ç n8n workflow ‰ΩøÁî®Ê≠£Á¢∫Ê®°Êùø';
                }
            } catch (e) {
                statusEl.innerHTML = '‚ùå ÈÄ£Á∑öÂ§±Êïó: ' + e.message + '<br><small>Á¢∫Ë™ç workflow Â∑≤ Activate ‰∏î URL ÊòØ Production Webhook URL</small>';
            }
        }

        // === Ëá™ÂãïË∑®Êó• ===
        let curDay = new Date().toISOString().split('T')[0];
        function checkNewDay() {
            const now = new Date().toISOString().split('T')[0];
            if (now !== curDay) {
                curDay = now;
                if (!dailyHabitsData[now]) {
                    dailyHabitsData[now] = {trading:false,advertise:false,deliver:false,gym:false,fatloss:false,ai:false};
                    localStorage.setItem('daily_habits', JSON.stringify(dailyHabitsData));
                    createDayInNotion(now);
                }
                loadDailyHabits();
                showToast('üåÖ Êñ∞ÁöÑ‰∏ÄÂ§© ' + now);
            }
        }
        setInterval(checkNewDay, 30000);
        document.addEventListener('visibilitychange', () => { if (!document.hidden) checkNewDay(); });

        // ==================== SETTINGS ====================
        function saveSettings() {
            const notionToken = document.getElementById('notion-token').value;
            const webhook = document.getElementById('n8n-webhook').value.replace(/\/+$/, '');
            const apiKey = document.getElementById('anthropic-key').value;
            const aiModel = document.getElementById('ai-model').value;
            const aiProfile = document.getElementById('ai-profile').value;
            const driveUrl = document.getElementById('drive-script-url').value.replace(/\/+$/, '');
            if (notionToken) localStorage.setItem('notion_token', notionToken);
            if (webhook) localStorage.setItem('n8n_webhook', webhook);
            if (apiKey) localStorage.setItem('anthropic_key', apiKey);
            if (driveUrl) localStorage.setItem('drive_script_url', driveUrl);
            localStorage.setItem('ai_model', aiModel);
            localStorage.setItem('ai_profile', aiProfile);
            updateSyncDot();
            updateModelBadges();
            showToast('Settings saved');
            hideModal('settings-modal');
            // Prefer direct Notion sync, fallback to n8n
            if (notionToken) {
                syncDailyFromNotionDirect(true);
            } else if (webhook) {
                syncDailyFromNotion(true);
            }
            if (driveUrl) syncMoodboardFromDrive();
        }

        function resetData() {
            if (confirm('Reset all data? Daily habits will re-sync from Notion.')) {
                localStorage.setItem('wealth_history', JSON.stringify(PRELOAD_WEALTH_HISTORY));
                localStorage.removeItem('daily_habits');
                localStorage.removeItem('notion_page_index');
                wealthHistory = JSON.parse(JSON.stringify(PRELOAD_WEALTH_HISTORY));
                dailyHabitsData = {};
                notionPageIndex = {};
                updateSyncDot();
                updateWealthDisplay();
                loadDailyHabits();
                hideModal('settings-modal');
                showToast('Data reset ‚Äî syncing from Notion...');
                syncDailyFromNotionDirect(true);
            }
        }

        // ==================== CHARTS ====================
        Chart.register(ChartDataLabels);
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: { color: '#6b6b6b', font: { size: 9 }, anchor: 'end', align: 'top', formatter: (v) => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? Math.round(v/1000)+'K' : v }
            },
            scales: {
                x: { grid: { color: '#1f1f1f' }, ticks: { color: '#6b6b6b', font: { size: 10 } } },
                y: { grid: { color: '#1f1f1f' }, ticks: { color: '#6b6b6b', font: { size: 10 }, callback: v => formatMoney(v) } }
            }
        };

        const wealthCtx = document.getElementById('wealthChart').getContext('2d');
        let wealthChart = new Chart(wealthCtx, { type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: 'rgba(100,149,237,0.7)' }] }, options: chartOptions });

        const bodyCtx = document.getElementById('bodyChart').getContext('2d');
        const bodyChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: { 
                    color: '#d4c5a9', 
                    font: { size: 10, weight: 'bold' }, 
                    anchor: 'end', 
                    align: 'top', 
                    formatter: (v) => v != null ? v.toFixed(1) : '' 
                }
            },
            scales: {
                x: { grid: { color: '#1f1f1f' }, ticks: { color: '#6b6b6b', font: { size: 9 }, maxRotation: 45, minRotation: 30 } },
                y: { 
                    grid: { color: '#1f1f1f' }, 
                    ticks: { color: '#6b6b6b', font: { size: 10 } },
                    beginAtZero: false,
                    grace: '10%'
                }
            }
        };
        const bodyChart = new Chart(bodyCtx, { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#d4c5a9', tension: 0.4, fill: true, backgroundColor: 'rgba(212,197,169,0.1)', pointRadius: 5, pointBackgroundColor: '#d4c5a9', pointBorderColor: '#d4c5a9', borderWidth: 2 }] }, options: bodyChartOptions });

        const bizCtx = document.getElementById('bizChart').getContext('2d');
        const bizChart = new Chart(bizCtx, { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#d4c5a9', tension: 0.4, fill: true, backgroundColor: 'rgba(212,197,169,0.1)' }] }, options: chartOptions });

        const algoCtx = document.getElementById('algoChart').getContext('2d');
        const algoChart = new Chart(algoCtx, { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#d4c5a9', tension: 0.4, fill: true, backgroundColor: 'rgba(212,197,169,0.1)' }] }, options: { ...chartOptions, plugins: { ...chartOptions.plugins, datalabels: { display: false } } } });

        function setWealthMode(mode, btn) {
            btn.parentElement.querySelectorAll('.chart-toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            wealthChartMode = mode;
            updateWealthChart();
        }

        function setWealthChartStyle(style, btn) {
            btn.parentElement.querySelectorAll('.chart-toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            wealthChartStyle = style;
            updateWealthChart();
        }

        function setWealthChart(type, btn) {
            document.querySelectorAll('#wealth .chart-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            wealthChartType = type;
            updateWealthChart();
        }

        function updateWealthChart() {
            const hist = wealthHistory.slice(-24);
            if (!hist.length) return;
            const labels = hist.map(h => h.date ? h.date.slice(2,7).replace('-','/') : '');
            let data;
            switch (wealthChartType) {
                case 'total': data = hist.map(h => h.totalAssets || 0); break;
                case 'savings': data = hist.map(h => h.categories?.['Ê¥ªÊúüÂ≠òÊ¨æ'] || 0); break;
                case 'stocks': data = hist.map(h => h.categories?.['ËÇ°Á•®ETF'] || 0); break;
                case 'crypto': data = hist.map(h => h.categories?.['Âä†ÂØÜË≤®Âπ£'] || 0); break;
                case 'debt': data = hist.map(h => h.categories?.['ÂÇµÂãô'] || 0); break;
                default: data = hist.map(h => h.totalAssets || 0);
            }
            if (wealthChartMode === 'growth') {
                data = wealthChartType === 'total' ? hist.map(h => h.monthlyGrowth || 0) : data.map((v, i) => i === 0 ? 0 : parseFloat(((v - data[i-1]) / (data[i-1] || 1) * 100).toFixed(1)));
            }
            wealthChart.data.labels = labels;
            wealthChart.data.datasets[0].data = data;
            wealthChart.data.datasets[0].type = wealthChartStyle === 'line' ? 'line' : 'bar';
            wealthChart.update();
        }

        function setBodyChart(type, btn) {
            document.querySelectorAll('#physic .chart-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            currentBodyChartType = type;
            updateBodyChart(type);
        }

        // ==================== WEALTH ====================
        function setWealthTab(tab, btn) {
            document.querySelectorAll('#wealth .tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-snapshot').style.display = tab === 'snapshot' ? 'block' : 'none';
            document.getElementById('tab-expense').style.display = tab === 'expense' ? 'block' : 'none';
        }

        function editQuote() {
            document.getElementById('quote-text-input').value = quote.text;
            document.getElementById('quote-author-input').value = quote.author;
            showModal('quote-modal');
        }

        function saveQuote() {
            quote.text = document.getElementById('quote-text-input').value;
            quote.author = document.getElementById('quote-author-input').value;
            localStorage.setItem('wealth_quote', JSON.stringify(quote));
            document.getElementById('wealth-quote-text').textContent = '"' + quote.text + '"';
            document.getElementById('wealth-quote-author').textContent = '‚Äî ' + quote.author;
            hideModal('quote-modal');
            showToast('Quote saved');
        }

        function editGoal() {
            document.getElementById('wealth-goal-input').value = wealthGoal;
            showModal('goal-modal');
        }

        function saveGoal() {
            wealthGoal = parseInt(document.getElementById('wealth-goal-input').value) || 6500000;
            localStorage.setItem('wealth_goal', wealthGoal);
            document.getElementById('goal-target').textContent = formatNumber(wealthGoal);
            updateWealthDisplay();
            hideModal('goal-modal');
            showToast('Goal saved');
        }

        function renderAccountManager() {
            const c = document.getElementById('account-manager-list');
            const g = {};
            accounts.forEach((a, i) => { if (!g[a.category]) g[a.category] = []; g[a.category].push({ ...a, idx: i }); });
            let h = '';
            Object.keys(g).forEach(cat => {
                h += `<div style="margin-bottom:12px;"><div style="font-size:11px;color:var(--accent);margin-bottom:6px;">${CATEGORY_ICONS[cat] || ''} ${cat}</div>`;
                g[cat].forEach(a => {
                    h += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;"><span>${a.name} (${a.currency})</span><button class="btn btn-small btn-danger" onclick="deleteAccount(${a.idx})">Delete</button></div>`;
                });
                h += '</div>';
            });
            c.innerHTML = h;
        }

        function addAccount() {
            const n = document.getElementById('new-account-name').value;
            const p = document.getElementById('new-account-platform').value;
            const cat = document.getElementById('new-account-category').value;
            const cur = document.getElementById('new-account-currency').value;
            if (!n) return showToast('Enter name', true);
            accounts.push({ name: n, platform: p, category: cat, currency: cur });
            localStorage.setItem('accounts', JSON.stringify(accounts));
            renderAccountManager();
            document.getElementById('new-account-name').value = '';
            showToast('Account added');
        }

        function deleteAccount(idx) {
            if (confirm('Delete?')) {
                accounts.splice(idx, 1);
                localStorage.setItem('accounts', JSON.stringify(accounts));
                renderAccountManager();
                showToast('Deleted');
            }
        }

        function toggleWealthForm() {
            const f = document.getElementById('wealth-form');
            const b = document.getElementById('wealth-form-toggle');
            if (f.style.display === 'none') { f.style.display = 'block'; b.innerHTML = '‚úï Close'; renderWealthForm(); }
            else { f.style.display = 'none'; b.innerHTML = 'üìù New Snapshot'; }
        }

        function renderWealthForm() {
            const f = document.getElementById('wealth-form');
            const g = {};
            accounts.forEach(a => { if (!g[a.category]) g[a.category] = []; g[a.category].push(a); });
            let h = `<div class="form-section"><div class="form-title">üìÖ Date</div><input type="date" class="form-input" id="wealth-date" value="${new Date().toISOString().split('T')[0]}" style="max-width:180px;"></div>`;
            Object.keys(g).forEach(cat => {
                const isDebt = cat === 'ÂÇµÂãô';
                h += `<div class="form-section ${isDebt ? 'debt-section' : ''}"><div class="form-title">${CATEGORY_ICONS[cat] || ''} ${cat}</div><div class="account-grid">`;
                g[cat].forEach(a => {
                    h += `<div class="account-row"><div><div class="account-name">${a.name}</div><div class="account-bank">${a.platform}</div></div><span style="font-size:10px;color:var(--text-muted);">${a.currency}</span><input type="number" class="form-input account-input" data-account="${a.name}" data-category="${a.category}" data-currency="${a.currency}" ${isDebt ? 'data-debt="true"' : ''} placeholder=""><span></span></div>`;
                });
                h += `</div><div class="category-total">Subtotal: <span id="subtotal-${cat}">0</span></div></div>`;
            });
            h += `<div class="form-section" style="background:var(--bg-elevated);border-color:var(--accent);"><div class="summary-grid" style="margin-bottom:0;"><div class="summary-item" style="background:transparent;border:none;"><div class="summary-label">Total Assets</div><div class="summary-value" id="total-assets">0</div></div><div class="summary-item" style="background:transparent;border:none;"><div class="summary-label">Total Debt</div><div class="summary-value negative" id="total-debt">0</div></div><div class="summary-item" style="background:transparent;border:none;"><div class="summary-label">Net Worth</div><div class="summary-value accent" id="net-worth">0</div></div></div></div><div class="form-actions" style="justify-content:center;"><button class="btn" onclick="toggleWealthForm()">Cancel</button><button class="btn btn-accent" onclick="saveWealthSnapshot()">üíæ Save</button></div>`;
            f.innerHTML = h;
            document.querySelectorAll('.account-input').forEach(i => i.addEventListener('input', calculateWealth));
        }

        function calculateWealth() {
            const inputs = document.querySelectorAll('.account-input');
            const cats = {};
            let totalA = 0, totalD = 0;
            inputs.forEach(i => {
                const v = parseFloat(i.value) || 0;
                const cur = i.dataset.currency || 'TWD';
                const cat = i.dataset.category;
                const isDebt = i.dataset.debt === 'true';
                const twd = toTWD(v, cur);
                if (!cats[cat]) cats[cat] = 0;
                cats[cat] += twd;
                if (isDebt) totalD += twd; else totalA += twd;
            });
            Object.keys(cats).forEach(c => { const e = document.getElementById('subtotal-' + c); if (e) e.textContent = formatNumber(cats[c]); });
            document.getElementById('total-assets').textContent = formatNumber(totalA);
            document.getElementById('total-debt').textContent = formatNumber(totalD);
            document.getElementById('net-worth').textContent = formatNumber(totalA - totalD);
            return { totalAssets: totalA, totalDebt: totalD, netWorth: totalA - totalD, categories: cats };
        }

        async function saveWealthSnapshot() {
            const date = document.getElementById('wealth-date').value;
            const r = calculateWealth();
            const data = { date, ...r };
            // Calculate monthly growth
            if (wealthHistory.length > 0) {
                const prev = wealthHistory[wealthHistory.length - 1];
                if (prev.totalAssets > 0) {
                    data.monthlyGrowth = ((data.totalAssets - prev.totalAssets) / prev.totalAssets) * 100;
                }
            }
            wealthHistory.push(data);
            localStorage.setItem('wealth_history', JSON.stringify(wealthHistory));
            updateWealthDisplay();
            toggleWealthForm();
            // Sync to Notion via n8n
            const synced = await writeWealthToNotion(data);
            showToast(synced ? 'Saved & Synced' : 'Saved');
        }

        async function writeWealthToNotion(data) {
            const url = getN8nUrl();
            if (!url) return false;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'create_wealth',
                        data: {
                            Date: data.date,
                            TotalAssets: Math.round(data.totalAssets || 0),
                            MonthlyGrowth: data.monthlyGrowth ? data.monthlyGrowth / 100 : 0,
                            categories: data.categories || {}
                        }
                    })
                });
                const result = await res.json();
                if (result.pageId) {
                    wealthNotionIndex[data.date] = result.pageId;
                    localStorage.setItem('wealth_notion_index', JSON.stringify(wealthNotionIndex));
                }
                return result.ok;
            } catch(e) { console.error('[RayOS] Wealth sync error:', e); return false; }
        }

        async function syncWealthFromNotion(silent = false) {
            const url = getN8nUrl();
            if (!url) { if (!silent) showToast('Ë´ãÂÖàÂú® Settings Ë®≠ÂÆö n8n Webhook URL', true); return; }
            if (!silent) showToast('Ê≠£Âú®ÂêåÊ≠• Wealth Ë≥áÊñô...');
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'fetch_wealth' })
                });
                if (!res.ok) throw new Error('n8n returned ' + res.status);
                const data = await res.json();
                if (data.records && data.records.length > 0) {
                    wealthNotionIndex = data.pageIndex || {};
                    localStorage.setItem('wealth_notion_index', JSON.stringify(wealthNotionIndex));
                    wealthHistory = data.records.map(r => ({
                        date: r.Date || r.date || '',
                        totalAssets: r.TotalAssets || r.totalAssets || 0,
                        totalDebt: r.totalDebt || 0,
                        netWorth: r.netWorth || (r.TotalAssets || 0),
                        monthlyGrowth: r.MonthlyGrowth != null ? r.MonthlyGrowth * 100 : null,
                        categories: r.categories || {}
                    })).filter(r => r.date).sort((a,b) => a.date.localeCompare(b.date));
                    localStorage.setItem('wealth_history', JSON.stringify(wealthHistory));
                    updateWealthDisplay();
                    updateWealthSyncDot();
                    if (!silent) showToast('Synced ' + wealthHistory.length + ' wealth records');
                } else {
                    if (!silent) showToast('No wealth records found', true);
                }
            } catch(e) {
                console.error('[RayOS] Wealth sync error:', e);
                if (!silent) showToast('Wealth ÂêåÊ≠•Â§±Êïó: ' + e.message, true);
            }
        }

        function updateWealthSyncDot() {
            const d = document.getElementById('wealth-sync-dot');
            if (d) d.className = 'sync-dot ' + (getN8nUrl() ? 'on' : 'off');
        }

        function updateWealthDisplay() {
            if (wealthHistory.length > 0) {
                const lat = wealthHistory[wealthHistory.length - 1];
                const total = lat.totalAssets || 0;
                document.getElementById('display-total').textContent = formatMoney(total);
                document.getElementById('stat-wealth').textContent = formatMoney(total);
                document.getElementById('display-lastdate').textContent = lat.date || '--';
                document.getElementById('goal-current').textContent = formatNumber(total);
                const pct = Math.min(100, (total / wealthGoal) * 100);
                document.getElementById('goal-bar').style.width = pct + '%';
                document.getElementById('goal-pct').textContent = pct.toFixed(1) + '%';
                document.getElementById('goal-remain').textContent = 'ÈÇÑÂ∑Æ ' + formatMoney(Math.max(0, wealthGoal - total));
                if (lat.monthlyGrowth !== null && lat.monthlyGrowth !== undefined) {
                    const mg = lat.monthlyGrowth;
                    document.getElementById('display-monthly').textContent = (mg > 0 ? '+' : '') + mg.toFixed(2) + '%';
                    document.getElementById('display-monthly').className = 'summary-value ' + (mg >= 0 ? 'positive' : 'negative');
                }
                updateWealthChart();
            }
            document.getElementById('wealth-ai-suggestion').innerHTML = '<strong>ÁõÆÊ®ôÈÄ≤Â∫¶Ôºö</strong> ' + ((wealthHistory[wealthHistory.length-1]?.totalAssets || 0) / wealthGoal * 100).toFixed(1) + '%';
            // Auto-trigger AI analysis on wealth display update
            autoAnalyze('wealth');
        }

        // ==================== CLAUDE AI ENGINE ====================
        const aiChatHistory = { wealth: [], trading: [], business: [], physic: [] };
        let aiAutoAnalyzed = { wealth: false, trading: false, business: false, physic: false };

        const AI_SYSTEM_PROMPTS = {
            wealth: `You are Ray's personal wealth advisor embedded in his RayOS dashboard. Respond in Traditional Chinese (ÁπÅÈ´î‰∏≠Êñá) mixed with English terms where natural. Be concise, data-driven, and actionable. Use bullet points. Max 200 words.
Your role: Analyze Ray's asset allocation, growth trajectory, and provide strategic wealth advice based on his real data.`,
            trading: `You are Ray's algorithmic trading coach embedded in his RayOS dashboard. Respond in Traditional Chinese mixed with English trading terms. Be concise and analytical. Max 200 words.
Your role: Analyze Ray's trading performance metrics (cumulative return, MDD, win rate, monthly returns) and provide strategy insights. Ray runs algorithmic/systematic trading strategies and also does prop firm challenges.`,
            business: `You are Ray's business growth coach embedded in his RayOS dashboard. Respond in Traditional Chinese mixed with English business terms. Be concise and action-oriented. Max 200 words.
Your role: Analyze Ray's business metrics (Skool communities, YouTube, MRR, member growth) and provide growth strategies. Ray runs online education communities.`,
            physic: `You are Ray's body transformation coach embedded in his RayOS dashboard. Respond in Traditional Chinese mixed with English fitness terms. Be concise, scientific, and motivating. Max 200 words.
Your role: Analyze Ray's body composition data (weight, body fat %, muscle mass) and provide evidence-based advice for fat loss while preserving muscle.`
        };

        // Model display names
        function getModelDisplayName() {
            const m = localStorage.getItem('ai_model') || 'claude-haiku-4-5-20251001';
            if (m.includes('haiku')) return 'Haiku 4.5';
            if (m.includes('sonnet-4-5')) return 'Sonnet 4.5';
            if (m.includes('sonnet-4')) return 'Sonnet 4';
            return m.split('-').slice(1,3).join(' ');
        }
        function updateModelBadges() {
            const name = getModelDisplayName();
            document.querySelectorAll('.ai-model-badge').forEach(b => b.textContent = name);
        }

        // Build full system prompt with personal profile + cross-domain overview
        function buildSystemPrompt(domain) {
            let prompt = AI_SYSTEM_PROMPTS[domain];
            const profile = localStorage.getItem('ai_profile');
            if (profile) {
                prompt += `\n\n=== RAY'S PERSONAL PROFILE & GOALS ===\n${profile}`;
            }
            // Cross-domain snapshot so AI understands the full picture
            prompt += `\n\n=== CROSS-DOMAIN OVERVIEW ===`;
            const lat = wealthHistory[wealthHistory.length - 1] || {};
            prompt += `\n- Wealth: ${formatNumber(lat.totalAssets || 0)} TWD (Goal: ${formatNumber(wealthGoal)} TWD, ${((lat.totalAssets || 0) / wealthGoal * 100).toFixed(0)}%)`;
            const latBody = bodyHistory[bodyHistory.length - 1] || {};
            prompt += `\n- Body: ${latBody.fatpct || '?'}% fat, ${latBody.weight || '?'}kg (Goal: ${physicGoal.target}% fat)`;
            const latAlgo = algoEquity[algoEquity.length - 1] || {};
            prompt += `\n- Trading: ${latAlgo.cumRet?.toFixed(1) || '?'}% cumulative return`;
            // Daily habits recent streak
            const today = new Date().toISOString().split('T')[0];
            const todayH = dailyHabitsData[today] || {};
            const todayDone = Object.values(todayH).filter(v => v === true).length;
            // Last 7 days completion
            let last7done = 0, last7total = 0;
            for (let i = 0; i < 7; i++) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                const dh = dailyHabitsData[ds] || {};
                last7done += Object.values(dh).filter(v => v === true).length;
                last7total += 6;
            }
            prompt += `\n- Daily Habits: Today ${todayDone}/6, Last 7 days ${last7done}/${last7total} (${(last7done/last7total*100).toFixed(0)}%)`;
            prompt += `\n\nUse this context to give holistic advice. Reference goals from the profile when relevant. Be direct and data-driven.`;
            return prompt;
        }

        function getAIContext(domain) {
            switch (domain) {
                case 'wealth': {
                    const lat = wealthHistory[wealthHistory.length - 1] || {};
                    const prev = wealthHistory[wealthHistory.length - 2] || {};
                    return `Current Data (${lat.date || 'N/A'}):
- Total Assets: ${formatNumber(lat.totalAssets || 0)} TWD
- Net Worth: ${formatNumber(lat.netWorth || 0)} TWD
- Monthly Growth: ${lat.monthlyGrowth != null ? lat.monthlyGrowth.toFixed(2) + '%' : 'N/A'}
- Categories: Ê¥ªÊúüÂ≠òÊ¨æ ${formatNumber(lat.categories?.['Ê¥ªÊúüÂ≠òÊ¨æ'] || 0)}, ËÇ°Á•®ETF ${formatNumber(lat.categories?.['ËÇ°Á•®ETF'] || 0)}, Âä†ÂØÜË≤®Âπ£ ${formatNumber(lat.categories?.['Âä†ÂØÜË≤®Âπ£'] || 0)}, ÂÇµÂãô ${formatNumber(lat.categories?.['ÂÇµÂãô'] || 0)}
- 2026 Goal: ${formatNumber(wealthGoal)} TWD (Progress: ${((lat.totalAssets || 0) / wealthGoal * 100).toFixed(1)}%)
- Previous snapshot (${prev.date || 'N/A'}): ${formatNumber(prev.totalAssets || 0)} TWD
- History points: ${wealthHistory.length} records from ${wealthHistory[0]?.date || 'N/A'} to ${lat.date || 'N/A'}`;
                }
                case 'trading': {
                    const latAlgo = algoEquity[algoEquity.length - 1] || {};
                    const recent5 = algoEquity.slice(-5).map(e => `${e.date}: ${e.dailyRet > 0 ? '+' : ''}${e.dailyRet}% (cum: ${e.cumRet.toFixed(2)}%)`).join('\n');
                    const monthlyStr = Object.entries(MONTHLY_RETURNS).map(([yr, m]) => {
                        const months = Object.entries(m).filter(([k]) => k !== 'ytd').map(([k, v]) => `${k}Êúà:${v > 0 ? '+' : ''}${v}%`).join(', ');
                        return `${yr}: ${months} | YTD: ${m.ytd > 0 ? '+' : ''}${m.ytd}%`;
                    }).join('\n');
                    return `Algo Trading Performance:
- Cumulative Return: ${latAlgo.cumRet?.toFixed(2) || 0}%
- Latest Equity: ${formatNumber(latAlgo.equity || 0)} TWD (started at 1,000,000)
- Win Rate: ${((algoEquity.filter(e => e.dailyRet > 0).length / Math.max(1, algoEquity.length)) * 100).toFixed(1)}%
- MDD: 26.01%
- Recent 5 days:\n${recent5}
- Monthly Returns:\n${monthlyStr}
Prop Firm: Fee $38,918 / Payout $64,043 / Net $29,648 / Pass Rate 25%`;
                }
                case 'business': {
                    const bizData = JSON.parse(localStorage.getItem(`biz_${currentBusiness}`) || '[]');
                    const latBiz = bizData[bizData.length - 1] || {};
                    const prevBiz = bizData[bizData.length - 2] || {};
                    return `Business: ${currentBusiness}
- Current Members: ${latBiz.members || 0}
- Current Revenue: $${latBiz.revenue || 0}/mo
- Previous: ${prevBiz.members || 0} members, $${prevBiz.revenue || 0}/mo
- Data points: ${bizData.length}
- Business model: Skool free community, Skool paid community, YouTube channel`;
                }
                case 'physic': {
                    const sorted = bodyHistory.slice().sort((a, b) => a.date.localeCompare(b.date));
                    const lat = sorted[sorted.length - 1] || {};
                    const first = sorted[0] || {};
                    const prev = sorted[sorted.length - 2] || {};
                    return `Body Composition Data:
- Latest (${lat.date || 'N/A'}): Weight ${lat.weight}kg, Fat ${lat.fatpct}%, Muscle ${lat.muscle}kg
- First record (${first.date || 'N/A'}): Weight ${first.weight}kg, Fat ${first.fatpct}%, Muscle ${first.muscle}kg
- Previous (${prev.date || 'N/A'}): Weight ${prev.weight}kg, Fat ${prev.fatpct}%, Muscle ${prev.muscle}kg
- Goal: ${physicGoal.target}% body fat (from ${physicGoal.start}%)
- Height: ${physicGoal.height}cm
- Total records: ${sorted.length}
- Total fat change: ${(lat.fatpct - first.fatpct).toFixed(1)}%
- Total muscle change: ${((lat.muscle || 0) - (first.muscle || 0)).toFixed(1)}kg`;
                }
                default: return '';
            }
        }

        async function callClaudeAPI(domain, userMessage) {
            const apiKey = localStorage.getItem('anthropic_key');
            if (!apiKey) {
                return '‚ö†Ô∏è Ë´ãÂÖàÂà∞ Settings Ë®≠ÂÆö Anthropic API Key„ÄÇ\n\nÂèñÂæóÊñπÂºèÔºö[console.anthropic.com](https://console.anthropic.com/settings/keys) ‚Üí API Keys';
            }
            const systemPrompt = buildSystemPrompt(domain);
            const context = getAIContext(domain);
            const model = localStorage.getItem('ai_model') || 'claude-haiku-4-5-20251001';
            const maxTokens = model.includes('haiku') ? 600 : 1000;
            const messages = [];
            const history = aiChatHistory[domain].slice(-6);
            let userContent = `Here is my current ${domain} data:\n\n${context}\n\n`;
            if (history.length > 0) {
                userContent += `Previous conversation:\n${history.map(m => `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`).join('\n')}\n\n`;
            }
            userContent += `Current question: ${userMessage}`;
            messages.push({ role: 'user', content: userContent });
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: model,
                        max_tokens: maxTokens,
                        system: systemPrompt,
                        messages: messages
                    })
                });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    if (response.status === 401) return '‚ö†Ô∏è API Key ÁÑ°ÊïàÔºåË´ãÂà∞ Settings ÈáçÊñ∞Ë®≠ÂÆö„ÄÇ';
                    if (response.status === 429) return '‚ö†Ô∏è Ë´ãÊ±ÇÂ§™È†ªÁπÅÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ';
                    return '‚ö†Ô∏è API ÈåØË™§ (' + response.status + '): ' + (errData.error?.message || 'Unknown error');
                }
                const data = await response.json();
                const text = data.content?.map(b => b.type === 'text' ? b.text : '').join('') || 'No response';
                return text;
            } catch (err) {
                console.error('Claude API error:', err);
                return '‚ö†Ô∏è ÈÄ£Á∑öÂ§±ÊïóÔºö' + err.message;
            }
        }

        function renderAIResponse(text) {
            // Simple markdown-like rendering
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n- /g, '<br>‚Ä¢ ')
                .replace(/\n\d+\. /g, (m) => '<br>' + m.trim() + ' ')
                .replace(/\n/g, '<br>');
        }

        async function askAI(domain, inputId, suggestionId) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(suggestionId);
            const question = input.value.trim();
            if (!question) return;
            if (!localStorage.getItem('anthropic_key')) {
                showToast('Ë´ãÂÖàÂà∞ ‚öôÔ∏è Settings Ë®≠ÂÆö Anthropic API Key', true);
                return;
            }
            input.value = '';
            const safeQ = question.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Show user message
            aiChatHistory[domain].push({ role: 'user', content: question });
            container.innerHTML += `<div class="ai-msg user"><div class="ai-role">You</div>${safeQ}</div>`;
            container.innerHTML += `<div class="ai-msg assistant" id="ai-loading-${domain}"><div class="ai-role">Claude</div><span class="ai-loading">Thinking</span></div>`;
            container.scrollTop = container.scrollHeight;
            // Call Claude
            const response = await callClaudeAPI(domain, question);
            aiChatHistory[domain].push({ role: 'assistant', content: response });
            // Replace loading with response
            const loadingEl = document.getElementById(`ai-loading-${domain}`);
            if (loadingEl) loadingEl.outerHTML = `<div class="ai-msg assistant"><div class="ai-role">Claude</div>${renderAIResponse(response)}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        async function autoAnalyze(domain) {
            if (aiAutoAnalyzed[domain]) return;
            aiAutoAnalyzed[domain] = true;
            const suggestionIds = { wealth: 'wealth-ai-suggestion', trading: 'trading-ai-suggestion', business: 'biz-ai-suggestion', physic: 'body-ai-suggestion' };
            const container = document.getElementById(suggestionIds[domain]);
            if (!container) return;
            
            // Check if API key exists
            if (!localStorage.getItem('anthropic_key')) {
                container.innerHTML = getFallbackAnalysis(domain);
                return;
            }
            
            const prompts = {
                wealth: 'Ë´ãÂàÜÊûêÊàëÁõÆÂâçÁöÑË≥áÁî¢ÈÖçÁΩÆÂíåÊàêÈï∑Ë∂®Âã¢ÔºåÁµ¶Êàë 2-3 ÂÄãÂÖ∑È´îÁöÑË≤°ÂãôÂª∫Ë≠∞„ÄÇÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÁ≠î„ÄÇ',
                trading: 'Ë´ãÂàÜÊûêÊàëÁöÑ‰∫§ÊòìÁ∏æÊïàÔºåÂåÖÊã¨ÊúàÂ†±ÈÖ¨ÁéáË∂®Âã¢„ÄÅMDDÂíåÂãùÁéáÔºåÁµ¶Êàë 2-3 ÂÄãÊîπÂñÑÂª∫Ë≠∞„ÄÇÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÁ≠î„ÄÇ',
                business: 'Ë´ãÂàÜÊûêÊàëÁõÆÂâçÁöÑÁ§æÁæ§Á∂ìÁáüÊï∏ÊìöÔºåÁµ¶Êàë 2-3 ÂÄãÂ¢ûÈï∑Á≠ñÁï•„ÄÇÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÁ≠î„ÄÇ',
                physic: 'Ë´ãÂàÜÊûêÊàëÁöÑÈ´îÊÖãÊï∏ÊìöËÆäÂåñË∂®Âã¢ÔºåË©ï‰º∞Ê∏õËÑÇÈÄ≤Â∫¶ÔºåÁµ¶ÊàëÈ£≤È£üÂíåË®ìÁ∑¥Âª∫Ë≠∞„ÄÇÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÁ≠î„ÄÇ'
            };
            container.innerHTML = `<span class="ai-loading">Claude Ê≠£Âú®ÂàÜÊûê‰Ω†ÁöÑÊï∏Êìö</span>`;
            const response = await callClaudeAPI(domain, prompts[domain]);
            aiChatHistory[domain].push({ role: 'assistant', content: response });
            container.innerHTML = `<div class="ai-msg assistant">${renderAIResponse(response)}</div>`;
        }

        function getFallbackAnalysis(domain) {
            switch (domain) {
                case 'wealth': {
                    const lat = wealthHistory[wealthHistory.length - 1] || {};
                    const pct = ((lat.totalAssets || 0) / wealthGoal * 100).toFixed(1);
                    return `<strong>üìä ÁõÆÊ®ôÈÄ≤Â∫¶Ôºö${pct}%</strong><br><br>
                        Á∏ΩË≥áÁî¢: ${formatNumber(lat.totalAssets || 0)} TWD<br>
                        ÊúàÊàêÈï∑: ${lat.monthlyGrowth != null ? (lat.monthlyGrowth > 0 ? '+' : '') + lat.monthlyGrowth.toFixed(2) + '%' : 'N/A'}<br><br>
                        <span style="color:var(--text-muted);font-size:11px;">üí° Ë®≠ÂÆö Anthropic API Key ÂèØÁç≤Âæó Claude AI ÂÄã‰∫∫ÂåñÊ∑±Â∫¶ÂàÜÊûê</span>`;
                }
                case 'trading': {
                    const lat = algoEquity[algoEquity.length - 1] || {};
                    const wins = algoEquity.filter(e => e.dailyRet > 0).length;
                    const wr = algoEquity.length > 0 ? ((wins / algoEquity.length) * 100).toFixed(1) : '0';
                    return `<strong>üìà ‰∫§ÊòìÁ∏æÊïàÊ¶ÇË¶Ω</strong><br><br>
                        Á¥ØÁ©çÂ†±ÈÖ¨: ${lat.cumRet?.toFixed(2) || 0}%<br>
                        Êó•ÂãùÁéá: ${wr}%<br>
                        MDD: 26.01%<br><br>
                        <span style="color:var(--text-muted);font-size:11px;">üí° Ë®≠ÂÆö Anthropic API Key ÂèØÁç≤Âæó Claude AI ‰∫§ÊòìÁ≠ñÁï•ÂàÜÊûê</span>`;
                }
                case 'business': {
                    const bizData = JSON.parse(localStorage.getItem(`biz_${currentBusiness}`) || '[]');
                    const lat = bizData[bizData.length - 1] || {};
                    return `<strong>üè¢ ÂïÜÊ•≠Êï∏Êìö</strong><br><br>
                        ÊúÉÂì°: ${lat.members || 0}<br>
                        Êî∂ÂÖ•: $${lat.revenue || 0}/mo<br><br>
                        <span style="color:var(--text-muted);font-size:11px;">üí° Ë®≠ÂÆö Anthropic API Key ÂèØÁç≤Âæó Claude AI Â¢ûÈï∑Á≠ñÁï•Âª∫Ë≠∞</span>`;
                }
                case 'physic': {
                    const sorted = bodyHistory.slice().sort((a, b) => a.date.localeCompare(b.date));
                    const lat = sorted[sorted.length - 1] || {};
                    const first = sorted[0] || {};
                    const fatChange = lat.fatpct && first.fatpct ? (first.fatpct - lat.fatpct).toFixed(1) : '0';
                    return `<strong>üí™ È´îÊÖãÊï∏Êìö</strong><br><br>
                        È´îËÑÇ: ${lat.fatpct || '--'}% (Â∑≤Èôç ${fatChange}%)<br>
                        È´îÈáç: ${lat.weight || '--'} kg<br>
                        ËÇåËÇâ: ${lat.muscle || '--'} kg<br><br>
                        <span style="color:var(--text-muted);font-size:11px;">üí° Ë®≠ÂÆö Anthropic API Key ÂèØÁç≤Âæó Claude AI Â∞àÊ•≠È´îÊÖãÊïôÁ∑¥Âª∫Ë≠∞</span>`;
                }
                default: return '';
            }
        }

        function askWealthAI() { askAI('wealth', 'wealth-ai-input', 'wealth-ai-suggestion'); }
        function askBizAI() { askAI('business', 'biz-ai-input', 'biz-ai-suggestion'); }
        function askTradingAI() { askAI('trading', 'trading-ai-input', 'trading-ai-suggestion'); }
        async function analyzeExpenses() {
            const csvText = document.getElementById('expense-paste').value.trim();
            if (!csvText) { showToast('Please paste CSV data first', true); return; }
            const apiKey = localStorage.getItem('anthropic_key');
            if (!apiKey) { showToast('Please set API key in Settings first', true); return; }
            const resultEl = document.getElementById('expense-result');
            resultEl.style.display = 'block';
            resultEl.innerHTML = '<div style="text-align:center;padding:20px;">Analyzing expenses...</div>';
            try {
                const model = localStorage.getItem('ai_model') || 'claude-haiku-4-5-20251001';
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: model,
                        max_tokens: 1024,
                        system: 'You are an expense analyzer. Analyze the CSV data. Respond in Traditional Chinese mixed with English. Output: 1) Category breakdown table (category, count, total) 2) Top 3 spending categories 3) One actionable saving tip. Use simple HTML formatting with inline styles matching dark theme (color:#e0e0e0). Keep it concise.',
                        messages: [{ role: 'user', content: 'Analyze these expenses:\n' + csvText }]
                    })
                });
                if (!response.ok) throw new Error('API error: ' + response.status);
                const data = await response.json();
                const text = data.content?.[0]?.text || 'No response';
                resultEl.innerHTML = '<div class="form-section" style="margin-top:12px;">' + text + '</div>';
            } catch(e) {
                resultEl.innerHTML = '<div style="color:var(--danger);padding:12px;">Analysis failed: ' + e.message + '</div>';
            }
        }

        // ==================== BUSINESS ====================
        function selectBusiness(bizId, el) {
            document.querySelectorAll('.business-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            currentBusiness = bizId;
            updateBizDisplay();
        }

        function updateBizDisplay() {
            const data = JSON.parse(localStorage.getItem(`biz_${currentBusiness}`) || '[]');
            if (data.length > 0) {
                const lat = data[data.length - 1];
                document.getElementById('biz-members').textContent = formatNumber(lat.members || 0);
                document.getElementById('biz-mrr').textContent = '$' + formatNumber(lat.revenue || 0);
                document.getElementById('stat-mrr').textContent = '$' + formatNumber(lat.revenue || 0);
            } else {
                document.getElementById('biz-members').textContent = '0';
                document.getElementById('biz-mrr').textContent = '$0';
            }
            updateBizChart('members');
            autoAnalyze('business');
        }

        function setBizChart(type, btn) {
            document.querySelectorAll('#business .chart-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            updateBizChart(type);
        }

        function updateBizChart(type = 'members') {
            const data = JSON.parse(localStorage.getItem(`biz_${currentBusiness}`) || '[]').slice(-12);
            if (!data.length) { bizChart.data.labels = []; bizChart.data.datasets[0].data = []; bizChart.update(); return; }
            const labels = data.map(d => d.date?.slice(5) || '');
            const values = type === 'members' ? data.map(d => d.members || 0) : data.map(d => d.revenue || 0);
            bizChart.data.labels = labels;
            bizChart.data.datasets[0].data = values;
            bizChart.update();
        }

        async function saveBizMetrics() {
            const date = document.getElementById('biz-date').value;
            const members = parseInt(document.getElementById('biz-members-input').value) || 0;
            const revenue = parseFloat(document.getElementById('biz-revenue-input').value) || 0;
            const data = { date, members, revenue };
            let hist = JSON.parse(localStorage.getItem(`biz_${currentBusiness}`) || '[]');
            hist.push(data);
            localStorage.setItem(`biz_${currentBusiness}`, JSON.stringify(hist));
            updateBizDisplay();
            document.getElementById('biz-members-input').value = '';
            document.getElementById('biz-revenue-input').value = '';
            showToast('Saved');
        }

        function addBusiness() {
            const name = document.getElementById('new-biz-name').value;
            const icon = document.getElementById('new-biz-icon').value || 'üè¢';
            if (!name) return showToast('Enter name', true);
            const id = name.toLowerCase().replace(/\s+/g, '-');
            const selector = document.getElementById('business-selector');
            selector.innerHTML += `<div class="business-chip" data-biz="${id}" onclick="selectBusiness('${id}',this)">${icon} ${name}</div>`;
            hideModal('business-modal');
            document.getElementById('new-biz-name').value = '';
            showToast('Business added');
        }

        // ==================== TRADING ====================
        function setTradingTab(tab, btn) {
            document.querySelectorAll('#trading .tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-algo').style.display = tab === 'algo' ? 'block' : 'none';
            document.getElementById('tab-propfirm').style.display = tab === 'propfirm' ? 'block' : 'none';
        }

        function updateTradingDisplay() {
            if (algoEquity.length > 0) {
                const latest = algoEquity[algoEquity.length - 1];
                document.getElementById('algo-cumret').textContent = latest.cumRet.toFixed(2) + '%';
                const wins = algoEquity.filter(e => e.dailyRet > 0).length;
                document.getElementById('algo-winrate').textContent = ((wins / algoEquity.length) * 100).toFixed(2) + '%';
            }
            updateAlgoChart();
            updateMonthlyReturnsTable();
            renderPropChallenges();
            document.getElementById('algo-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('prop-record-date').value = new Date().toISOString().split('T')[0];
            autoAnalyze('trading');
        }

        function updateAlgoChart() {
            const data = algoEquity.slice(-30);
            if (data.length === 0) return;
            algoChart.data.labels = data.map(d => d.date.slice(5));
            algoChart.data.datasets[0].data = data.map(d => d.cumRet);
            algoChart.update();
        }

        function updateMonthlyReturnsTable() {
            const tbody = document.getElementById('monthly-returns-body');
            let html = '';
            for (const [year, months] of Object.entries(MONTHLY_RETURNS)) {
                html += '<tr>';
                html += `<td><strong>${year}</strong></td>`;
                for (let m = 1; m <= 12; m++) {
                    const val = months[m];
                    if (val !== undefined) {
                        const cls = val >= 0 ? 'positive' : 'negative';
                        html += `<td class="${cls}">${val >= 0 ? '+' : ''}${val.toFixed(2)}%</td>`;
                    } else { html += '<td>-</td>'; }
                }
                const ytdCls = months.ytd >= 0 ? 'positive' : 'negative';
                html += `<td class="${ytdCls}"><strong>${months.ytd >= 0 ? '+' : ''}${months.ytd.toFixed(2)}%</strong></td>`;
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }

        function saveAlgoEquity() {
            const date = document.getElementById('algo-date').value;
            const equity = parseFloat(document.getElementById('algo-equity').value) || 0;
            const dailyRet = parseFloat(document.getElementById('algo-daily-ret').value) || 0;
            const cumRet = ((equity - 1000000) / 1000000 * 100);
            algoEquity.push({ date, equity, dailyRet, cumRet });
            try { localStorage.setItem('algo_equity', JSON.stringify(algoEquity)); } catch(e) {}
            updateTradingDisplay();
            document.getElementById('algo-equity').value = '';
            document.getElementById('algo-daily-ret').value = '';
            showToast('Equity saved');
        }

        function renderPropChallenges() {
            const container = document.getElementById('prop-challenges');
            if (propRecords.length === 0) {
                container.innerHTML = '<div class="card" style="grid-column:span 2;text-align:center;cursor:default;"><div style="color:var(--text-dim);">No records yet</div></div>';
                return;
            }
            const byFirm = {};
            propRecords.forEach(r => {
                if (!byFirm[r.firm]) byFirm[r.firm] = { fee: 0, payout: 0, count: 0 };
                byFirm[r.firm].fee += r.fee || 0;
                byFirm[r.firm].payout += r.payout || 0;
                byFirm[r.firm].count++;
            });
            container.innerHTML = Object.entries(byFirm).map(([firm, data]) => {
                const net = data.payout - data.fee;
                const netCls = net >= 0 ? 'positive' : 'negative';
                return `<div class="card" style="cursor:default;"><div style="font-weight:600;margin-bottom:8px;">${firm}</div><div style="font-size:11px;">Fee: <span class="negative">$${formatNumber(data.fee)}</span></div><div style="font-size:11px;">Payout: <span class="positive">$${formatNumber(data.payout)}</span></div><div style="font-size:13px;margin-top:4px;">Net: <span class="${netCls}">$${formatNumber(net)}</span></div></div>`;
            }).join('');
        }

        function savePropRecord() {
            const firm = document.getElementById('prop-firm').value;
            const fee = parseFloat(document.getElementById('prop-challenge-fee').value) || 0;
            const payout = parseFloat(document.getElementById('prop-payout-amount').value) || 0;
            const date = document.getElementById('prop-record-date').value;
            const status = document.getElementById('prop-status').value;
            propRecords.push({ firm, fee, payout, date, status });
            try { localStorage.setItem('prop_records', JSON.stringify(propRecords)); } catch(e) {}
            updateTradingDisplay();
            document.getElementById('prop-challenge-fee').value = '';
            document.getElementById('prop-payout-amount').value = '';
            showToast('Record added');
        }

        // ==================== PHYSIC ====================
        async function saveBodyData() {
            const date = document.getElementById('body-date').value;
            const weight = parseFloat(document.getElementById('body-weight').value);
            const muscle = parseFloat(document.getElementById('body-muscle').value);
            const fatpct = parseFloat(document.getElementById('body-fatpct').value);
            const notes = document.getElementById('body-notes') ? document.getElementById('body-notes').value : '';
            if (!date || isNaN(weight) || isNaN(fatpct)) return showToast('Fill date, weight & fat%', true);
            const data = { date, weight, muscle: muscle || 0, fatpct, notes };
            const existIdx = bodyHistory.findIndex(h => h.date === date);
            if (existIdx >= 0) bodyHistory[existIdx] = data;
            else bodyHistory.push(data);
            bodyHistory.sort((a,b) => a.date.localeCompare(b.date));
            try { localStorage.setItem('body_history', JSON.stringify(bodyHistory)); } catch(e) {}
            updatePhysicDisplay();
            await writeBodyToNotion(data);
            document.getElementById('body-weight').value = '';
            document.getElementById('body-muscle').value = '';
            document.getElementById('body-fatpct').value = '';
            if (document.getElementById('body-notes')) document.getElementById('body-notes').value = '';
            showToast('Saved & synced');
        }

        async function writeBodyToNotion(data) {
            const url = getN8nUrl();
            if (!url) return;
            const pageId = bodyNotionIndex[data.date];
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: pageId ? 'update_body' : 'create_body',
                        pageId: pageId || null,
                        database_id: BODY_DS_ID,
                        data: { 
                            'Record ID': data.date,
                            Date: data.date, 
                            Weight: data.weight, 
                            Muscle: data.muscle, 
                            'Fat %': data.fatpct / 100, // Notion stores as decimal
                            Notes: data.notes || '' 
                        }
                    })
                });
            } catch(e) { console.error('Body sync error:', e); }
        }

        async function syncBodyFromNotion() {
            const url = getN8nUrl();
            if (!url) return showToast('Set n8n Webhook URL in Settings first', true);
            showToast('Syncing body data...');
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'fetch_body', database_id: BODY_DS_ID })
                });
                if (!res.ok) throw new Error('n8n returned ' + res.status);
                const data = await res.json();
                if (data.records && data.records.length > 0) {
                    bodyNotionIndex = data.pageIndex || {};
                    localStorage.setItem('body_notion_index', JSON.stringify(bodyNotionIndex));
                    bodyHistory = data.records.map(r => {
                        // Physic Tracker schema: Record ID(title), Date(date), Weight, Muscle, Fat %(decimal), Notes
                        var dateVal = r['date:Date:start'] || r.Date || r.date || r['Record ID'] || '';
                        var fatRaw = r['Fat %'] || r.BodyFat || r.fatpct || 0;
                        // Notion stores Fat % as decimal (0.192 = 19.2%), convert if < 1
                        var fatPct = fatRaw < 1 ? fatRaw * 100 : fatRaw;
                        return {
                            date: dateVal,
                            weight: r.Weight || r.weight || 0,
                            muscle: r.Muscle || r.MuscleMass || r.muscle || 0,
                            fatpct: parseFloat(fatPct.toFixed(1)),
                            notes: r.Notes || r.notes || ''
                        };
                    }).filter(r => r.date).sort((a,b) => a.date.localeCompare(b.date));
                    localStorage.setItem('body_history', JSON.stringify(bodyHistory));
                    updatePhysicDisplay();
                    showToast('‚úî Synced ' + bodyHistory.length + ' records from Physic Tracker');
                } else { showToast('No records found', true); }
            } catch(e) {
                console.error('Body sync error:', e);
                showToast('Sync failed: ' + e.message, true);
            }
        }

        function updateBodySyncDot() {
            const d = document.getElementById('body-sync-dot');
            if (d) d.className = 'sync-dot ' + (getN8nUrl() ? 'on' : 'off');
        }

        function updatePhysicDisplay() {
            const sorted = bodyHistory.slice().sort((a,b) => a.date.localeCompare(b.date));
            if (sorted.length > 0) {
                const latest = sorted[sorted.length - 1];
                const first = sorted[0];
                const el = function(id) { return document.getElementById(id); };
                // Stats row
                if (el('body-stat-weight')) el('body-stat-weight').textContent = latest.weight ? latest.weight.toFixed(1) : '--';
                if (el('body-stat-fat')) el('body-stat-fat').textContent = latest.fatpct ? latest.fatpct.toFixed(1) + '%' : '--';
                if (el('body-stat-muscle')) el('body-stat-muscle').textContent = latest.muscle ? latest.muscle.toFixed(1) : '--';
                // BMI
                var h = physicGoal.height / 100;
                if (h > 0 && latest.weight && el('body-stat-bmi')) {
                    el('body-stat-bmi').textContent = (latest.weight / (h * h)).toFixed(1);
                }
                // Fat change
                if (sorted.length >= 2 && el('body-stat-change')) {
                    var diff = (latest.fatpct - first.fatpct).toFixed(1);
                    el('body-stat-change').textContent = (diff > 0 ? '+' : '') + diff + '%';
                    el('body-stat-change').style.color = diff <= 0 ? 'var(--success)' : 'var(--danger)';
                }
                // Goal card
                if (el('physic-current')) el('physic-current').textContent = latest.fatpct ? latest.fatpct.toFixed(1) : '--';
                if (el('physic-target')) el('physic-target').textContent = physicGoal.target;
                if (el('stat-bodyfat')) el('stat-bodyfat').textContent = latest.fatpct ? latest.fatpct.toFixed(1) + '%' : '--';
                var start = physicGoal.start, target = physicGoal.target;
                var progress = Math.max(0, Math.min(100, ((start - latest.fatpct) / (start - target)) * 100));
                if (el('physic-bar')) el('physic-bar').style.width = progress + '%';
                if (el('physic-pct')) el('physic-pct').textContent = progress.toFixed(0) + '%';
                var remain = (latest.fatpct - target).toFixed(1);
                if (el('physic-remain')) el('physic-remain').textContent = remain > 0 ? remain + '% to go' : 'Target reached!';
                // Summary sidebar
                if (el('body-total-records')) el('body-total-records').textContent = sorted.length;
                if (el('body-first-date')) el('body-first-date').textContent = first.date;
                if (el('body-latest-date')) el('body-latest-date').textContent = latest.date;
                if (sorted.length >= 2) {
                    var wD = (latest.weight - first.weight).toFixed(1);
                    if (el('body-weight-change')) { el('body-weight-change').textContent = (wD > 0?'+':'') + wD + ' kg'; el('body-weight-change').style.color = wD <= 0 ? 'var(--success)' : 'var(--danger)'; }
                    var fD = (latest.fatpct - first.fatpct).toFixed(1);
                    if (el('body-fat-change')) { el('body-fat-change').textContent = (fD > 0?'+':'') + fD + '%'; el('body-fat-change').style.color = fD <= 0 ? 'var(--success)' : 'var(--danger)'; }
                    if (latest.muscle && first.muscle && el('body-muscle-change')) {
                        var mD = (latest.muscle - first.muscle).toFixed(1);
                        el('body-muscle-change').textContent = (mD > 0?'+':'') + mD + ' kg';
                        el('body-muscle-change').style.color = mD >= 0 ? 'var(--success)' : 'var(--danger)';
                    }
                }
            }
            updateBodyChart();
            renderBodyHistoryTable();
            renderPhotoSelects();
            updateBodyAI();
            updateBodySyncDot();
        }

        function updateBodyChart(type) {
            if (!bodyChart) return;
            var hist = bodyHistory.slice().sort(function(a,b){ return a.date.localeCompare(b.date); });
            if (!hist.length) {
                bodyChart.data.labels = [];
                bodyChart.data.datasets[0].data = [];
                bodyChart.update();
                return;
            }
            // Full date label: YYYY/MM/DD
            bodyChart.data.labels = hist.map(function(h){ 
                return h.date ? h.date.replace(/-/g, '/') : ''; 
            });
            var t = type || currentBodyChartType || 'fat';
            var data;
            switch (t) {
                case 'weight': data = hist.map(function(h){ return h.weight; }); break;
                case 'muscle': data = hist.map(function(h){ return h.muscle; }); break;
                default: data = hist.map(function(h){ return h.fatpct; }); break;
            }
            bodyChart.data.datasets[0].data = data;
            bodyChart.update();
        }
        var currentBodyChartType = 'fat';

        function renderBodyHistoryTable() {
            var tbody = document.getElementById('body-history-body');
            if (!tbody) return;
            var sorted = bodyHistory.slice().sort(function(a,b){ return b.date.localeCompare(a.date); });
            var h = physicGoal.height / 100;
            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:24px;">No data ‚Äî click "Sync Notion" to load</td></tr>';
                return;
            }
            var rows = '';
            for (var i = 0; i < sorted.length; i++) {
                var r = sorted[i];
                var bmi = (h > 0 && r.weight) ? (r.weight / (h * h)).toFixed(1) : '--';
                var dateDisplay = r.date ? r.date.replace(/-/g, '/') : '--';
                rows += '<tr><td style="text-align:left;">' + dateDisplay + '</td>' +
                    '<td>' + (r.weight || '--') + '</td>' +
                    '<td>' + (r.fatpct || '--') + '</td>' +
                    '<td>' + (r.muscle || '--') + '</td>' +
                    '<td>' + bmi + '</td>' +
                    '<td style="font-size:10px;color:var(--text-dim);">' + (r.notes || '') + '</td>' +
                    '<td><button onclick="deleteBodyRecord(' + i + ')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px;">&#10005;</button></td></tr>';
            }
            tbody.innerHTML = rows;
        }

        function deleteBodyRecord(sortedIdx) {
            var sorted = bodyHistory.slice().sort(function(a,b){ return b.date.localeCompare(a.date); });
            var record = sorted[sortedIdx];
            if (!record || !confirm('Delete record ' + record.date + '?')) return;
            var realIdx = bodyHistory.findIndex(function(h){ return h.date === record.date; });
            if (realIdx >= 0) bodyHistory.splice(realIdx, 1);
            try { localStorage.setItem('body_history', JSON.stringify(bodyHistory)); } catch(e) {}
            updatePhysicDisplay();
            showToast('Deleted');
        }

        // Physic Goal
        function editPhysicGoal() {
            document.getElementById('physic-start-input').value = physicGoal.start;
            document.getElementById('physic-target-input').value = physicGoal.target;
            document.getElementById('physic-height-input').value = physicGoal.height;
            showModal('physic-goal-modal');
        }
        function savePhysicGoal() {
            physicGoal.start = parseFloat(document.getElementById('physic-start-input').value) || 21;
            physicGoal.target = parseFloat(document.getElementById('physic-target-input').value) || 15;
            physicGoal.height = parseFloat(document.getElementById('physic-height-input').value) || 175;
            localStorage.setItem('physic_goal', JSON.stringify(physicGoal));
            updatePhysicDisplay();
            hideModal('physic-goal-modal');
            showToast('Goal saved');
        }

        // Photo Comparison
        // ==================== BODY PROGRESS PHOTOS (Google Drive) ====================
        let bodyProgressDates = {}; // { "2026-02-06": ["url1", "url2"], ... }

        // Normalize date: "20260206" ‚Üí "2026-02-06", "2026-02-06" stays same
        function normDate(d) {
            if (!d) return d;
            d = d.trim();
            if (/^\d{8}$/.test(d)) return d.slice(0,4) + '-' + d.slice(4,6) + '-' + d.slice(6,8);
            return d;
        }

        function loadBodyProgressFromDrive() {
            try {
                const stored = localStorage.getItem('body_progress_drive');
                if (stored) {
                    const raw = JSON.parse(stored);
                    bodyProgressDates = {};
                    Object.keys(raw).forEach(k => { bodyProgressDates[normDate(k)] = raw[k]; });
                }
            } catch(e) { console.log('body progress load error:', e); }
            renderPhotoSelects();
        }

        async function syncBodyPhotosFromDrive() {
            const scriptUrl = localStorage.getItem('drive_script_url');
            if (!scriptUrl) {
                showToast('Ë´ãÂÖàÂú® Settings Ë®≠ÂÆö Google Drive Script URL', true);
                return;
            }
            showToast('üì∑ ÂêåÊ≠• Body Progress...');
            try {
                const response = await fetch(scriptUrl);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                if (data && data.bodyProgress) {
                    // Normalize date keys (20260206 ‚Üí 2026-02-06)
                    const normalized = {};
                    Object.keys(data.bodyProgress).forEach(k => {
                        normalized[normDate(k)] = data.bodyProgress[k];
                    });
                    const dates = Object.keys(normalized).filter(d => normalized[d].length > 0);
                    if (dates.length > 0) {
                        bodyProgressDates = normalized;
                        localStorage.setItem('body_progress_drive', JSON.stringify(data.bodyProgress));
                        renderPhotoSelects();
                        showToast('‚úÖ Body Progress: ' + dates.length + ' ÂÄãÊó•ÊúüÂ∑≤ÂêåÊ≠•');
                    } else {
                        showToast('‚ö†Ô∏è Body Progress Ë≥áÊñôÂ§æÊ≤íÊúâÊâæÂà∞ÁÖßÁâá', true);
                    }
                } else {
                    showToast('‚ö†Ô∏è ÂõûÂÇ≥Ë≥áÊñô‰∏≠Ê≤íÊúâ bodyProgress', true);
                }
                // Also update moodboard if we got images
                if (data && data.images && data.images.length > 0) {
                    const urls = data.images.map(img => img.url);
                    localStorage.setItem('moodboard_images', JSON.stringify(urls));
                    localStorage.setItem('moodboard_drive_data', JSON.stringify(data.images));
                }
            } catch(e) {
                console.error('Body photo sync error:', e);
                showToast('ÂêåÊ≠•Â§±Êïó: ' + e.message, true);
            }
        }

        function renderPhotoSelects() {
            var beforeSel = document.getElementById('photo-before-select');
            var afterSel = document.getElementById('photo-after-select');
            if (!beforeSel || !afterSel) return;

            // Combine Drive photos and legacy localStorage photos
            var allDates = Object.keys(bodyProgressDates).filter(d => bodyProgressDates[d].length > 0);
            // Also include legacy bodyPhotos if any
            bodyPhotos.forEach(function(p) {
                if (allDates.indexOf(p.date) === -1) allDates.push(p.date);
            });
            allDates.sort();

            var countEl = document.getElementById('body-photo-count');
            if (countEl) countEl.textContent = allDates.length > 0 ? 'üì∑ ' + allDates.length + ' dates' : '--';

            var opts = '';
            for (var i = 0; i < allDates.length; i++) {
                var d = allDates[i];
                var photoCount = (bodyProgressDates[d] || []).length;
                var label = d + (photoCount > 1 ? ' (' + photoCount + ')' : '');
                opts += '<option value="' + d + '">' + label + '</option>';
            }
            var empty = '<option value="">-- Select Date --</option>';
            beforeSel.innerHTML = empty + opts;
            afterSel.innerHTML = empty + opts;
            if (allDates.length >= 2) {
                beforeSel.value = allDates[0];
                afterSel.value = allDates[allDates.length - 1];
                updatePhotoComparison();
            } else if (allDates.length === 1) {
                beforeSel.value = allDates[0];
                updatePhotoComparison();
            }
        }

        // Photo index state
        var photoIdx = { before: 0, after: 0 };

        function getPhotosForDate(dateStr) {
            var photos = [];
            if (bodyProgressDates[dateStr] && bodyProgressDates[dateStr].length > 0) {
                photos = bodyProgressDates[dateStr];
            }
            // Fallback to legacy
            if (photos.length === 0) {
                var legacy = bodyPhotos.find(function(p) { return p.date === dateStr; });
                if (legacy) photos = [legacy.src];
            }
            return photos;
        }

        function renderPhotoThumbs(side, photos, activeIdx) {
            var container = document.getElementById('photo-' + side + '-thumbs');
            if (!container) return;
            if (photos.length <= 1) { container.innerHTML = ''; return; }
            var html = '';
            for (var i = 0; i < photos.length; i++) {
                var isActive = i === activeIdx;
                var style = 'width:36px;height:36px;border-radius:4px;border:2px solid ' + 
                    (isActive ? 'var(--accent)' : 'var(--border)') + 
                    ';cursor:pointer;overflow:hidden;opacity:' + (isActive ? '1' : '0.5') + 
                    ';transition:all 0.2s;';
                html += '<div style="' + style + '" onclick="selectPhotoIdx(\'' + side + '\',' + i + ')" onmouseover="this.style.opacity=\'1\'" onmouseout="this.style.opacity=\'' + (isActive ? '1' : '0.5') + '\'">' +
                    '<img src="' + photos[i] + '" style="width:100%;height:100%;object-fit:cover;" loading="lazy">' +
                    '</div>';
            }
            container.innerHTML = html;
        }

        function selectPhotoIdx(side, idx) {
            photoIdx[side] = idx;
            updatePhotoComparison();
        }

        function cyclePhoto(side, dir) {
            var dateStr = document.getElementById('photo-' + side + '-select').value;
            if (!dateStr) return;
            var photos = getPhotosForDate(dateStr);
            if (photos.length <= 1) return;
            photoIdx[side] = (photoIdx[side] + dir + photos.length) % photos.length;
            updatePhotoComparison();
        }

        function updatePhotoComparison() {
            var bDate = document.getElementById('photo-before-select').value;
            var aDate = document.getElementById('photo-after-select').value;
            var bFrame = document.getElementById('photo-before-frame');
            var aFrame = document.getElementById('photo-after-frame');
            var delta = document.getElementById('photo-delta');

            // Before
            if (bDate) {
                var bPhotos = getPhotosForDate(bDate);
                if (bPhotos.length > 0) {
                    var bIdx = Math.min(photoIdx.before, bPhotos.length - 1);
                    photoIdx.before = bIdx;
                    bFrame.innerHTML = '<img src="' + bPhotos[bIdx] + '" style="width:100%;height:100%;object-fit:cover;" loading="lazy">';
                    renderPhotoThumbs('before', bPhotos, bIdx);
                } else {
                    bFrame.innerHTML = '<span style="color:var(--text-muted);font-size:12px;">No photo</span>';
                    renderPhotoThumbs('before', [], 0);
                }
                var bData = findBodyDataForDate(bDate);
                document.getElementById('photo-before-stats').textContent = bData ? bData.weight + 'kg / ' + bData.fatpct + '%' : bDate;
            } else {
                bFrame.innerHTML = '<span style="color:var(--text-muted);font-size:12px;">No photo</span>';
                document.getElementById('photo-before-stats').textContent = '';
                renderPhotoThumbs('before', [], 0);
            }

            // After
            if (aDate) {
                var aPhotos = getPhotosForDate(aDate);
                if (aPhotos.length > 0) {
                    var aIdx = Math.min(photoIdx.after, aPhotos.length - 1);
                    photoIdx.after = aIdx;
                    aFrame.innerHTML = '<img src="' + aPhotos[aIdx] + '" style="width:100%;height:100%;object-fit:cover;" loading="lazy">';
                    renderPhotoThumbs('after', aPhotos, aIdx);
                } else {
                    aFrame.innerHTML = '<span style="color:var(--text-muted);font-size:12px;">No photo</span>';
                    renderPhotoThumbs('after', [], 0);
                }
                var aData = findBodyDataForDate(aDate);
                document.getElementById('photo-after-stats').textContent = aData ? aData.weight + 'kg / ' + aData.fatpct + '%' : aDate;
            } else {
                aFrame.innerHTML = '<span style="color:var(--text-muted);font-size:12px;">No photo</span>';
                document.getElementById('photo-after-stats').textContent = '';
                renderPhotoThumbs('after', [], 0);
            }

            // Delta
            if (bDate && aDate) {
                var bD = findBodyDataForDate(bDate);
                var aD = findBodyDataForDate(aDate);
                if (bD && aD) {
                    var wDiff = (aD.weight - bD.weight).toFixed(1);
                    var fDiff = (aD.fatpct - bD.fatpct).toFixed(1);
                    delta.style.display = 'block';
                    document.getElementById('photo-delta-text').innerHTML =
                        'Weight: <span style="color:' + (wDiff <= 0 ? 'var(--success)' : 'var(--danger)') + ';">' + (wDiff > 0 ? '+' : '') + wDiff + ' kg</span>' +
                        ' &nbsp;|&nbsp; Fat: <span style="color:' + (fDiff <= 0 ? 'var(--success)' : 'var(--danger)') + ';">' + (fDiff > 0 ? '+' : '') + fDiff + '%</span>';
                } else { delta.style.display = 'none'; }
            } else { delta.style.display = 'none'; }
        }

        function findBodyDataForDate(dateStr) {
            var closest = null, minDiff = Infinity;
            for (var i = 0; i < bodyHistory.length; i++) {
                var diff = Math.abs(new Date(bodyHistory[i].date) - new Date(dateStr));
                if (diff < minDiff) { minDiff = diff; closest = bodyHistory[i]; }
            }
            return (minDiff < 15 * 86400000) ? closest : null;
        }

        // AI Body Coach - now uses Claude API
        function updateBodyAI() {
            autoAnalyze('physic');
        }

        function askBodyAI() {
            askAI('physic', 'body-ai-input', 'body-ai-suggestion');
        }

        // ==================== DAILY HABITS ====================

        function updateDailyProgress() {
            const checks = document.querySelectorAll('.habit-check');
            const done = Array.from(checks).filter(c => c.checked).length;
            const totalCount = checks.length;
            document.getElementById('daily-done').textContent = done;
            document.getElementById('daily-total').textContent = totalCount;
            document.getElementById('daily-bar').style.width = (done / totalCount * 100) + '%';
            const today = new Date().toISOString().split('T')[0];
            const oldH = dailyHabitsData[today] || {};
            const habits = {};
            checks.forEach(c => { habits[c.dataset.habit] = c.checked; });
            dailyHabitsData[today] = habits;
            try { localStorage.setItem('daily_habits', JSON.stringify(dailyHabitsData)); } catch(e) {}
            Object.keys(habits).forEach(h => { if(oldH[h]!==habits[h]) writeHabitToNotion(today,h,habits[h]); });
            updateDailyHistoryTable();
        }

        function loadDailyHabits(skipNotionCreate = false) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('daily-date').textContent = today;
            if (!dailyHabitsData[today]) {
                dailyHabitsData[today] = {trading:false,advertise:false,deliver:false,gym:false,fatloss:false,ai:false};
                localStorage.setItem('daily_habits', JSON.stringify(dailyHabitsData));
                // Only create in Notion if explicitly allowed (not during initial page load)
                if (!skipNotionCreate) createDayInNotion(today);
            }
            const todayHabits = dailyHabitsData[today] || {};
            document.querySelectorAll('.habit-check').forEach(c => { c.checked = todayHabits[c.dataset.habit] === true; });
            let streak=0;const d=new Date();
            while(true){const ds=d.toISOString().split('T')[0];const dh=dailyHabitsData[ds];if(!dh)break;if(Object.values(dh).some(v=>v===true)){streak++;d.setDate(d.getDate()-1);}else break;}
            document.getElementById('stat-streak').textContent = streak;
            updateDailyProgress();
            updateDailyHistoryTable();
        }

        function updateDailyHistoryTable() {
            const tbody = document.getElementById('daily-history-body');
            if (!tbody) return;
            
            const today = new Date();
            const habits = ['trading', 'advertise', 'deliver', 'gym', 'fatloss', 'ai'];
            const dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            
            // Check if we have meaningful data
            const dataKeys = Object.keys(dailyHabitsData).filter(k => {
                const dh = dailyHabitsData[k];
                return dh && Object.values(dh).some(v => v === true);
            });
            
            if (dataKeys.length === 0 && syncInProgress) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-dim);padding:40px;font-size:12px;">‚è≥ Ê≠£Âú®Âæû Notion ÂêåÊ≠•Ë≥áÊñô...</td></tr>';
                return;
            }
            
            let rows = [];
            
            // ÂæûÊúÄËøëÁöÑÊó•ÊúüÈñãÂßãÂæÄÂâçÈ°ØÁ§∫ 60 Â§©
            for (let i = 0; i < 60; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const dayHabits = dailyHabitsData[dateStr] || {};
                
                const dateLabel = `${d.getMonth() + 1}/${d.getDate()} ${dayNames[d.getDay()]}`;
                const isToday = i === 0;
                
                let completed = 0;
                let cells = '';
                habits.forEach(h => {
                    const done = dayHabits[h] === true;
                    if (done) completed++;
                    const checkStyle = done 
                        ? 'color:#4a7c59;font-weight:bold;font-size:14px;' 
                        : 'color:var(--text-muted);font-size:12px;';
                    cells += `<td style="text-align:center;cursor:pointer;${checkStyle}" onclick="toggleHistoryHabit('${dateStr}','${h}')">${done ? '‚úì' : '‚àí'}</td>`;
                });
                
                const rowClass = isToday ? 'today-row' : '';
                const totalStyle = completed > 0 ? 'color:var(--accent);font-weight:600;' : 'color:var(--text-muted);';
                rows.push(`<tr class="${rowClass}"><td>${dateLabel}</td>${cells}<td style="${totalStyle}">${completed}/6</td></tr>`);
            }
            
            tbody.innerHTML = rows.join('');
        }

        function toggleHistoryHabit(dateStr, habit) {
            if (!dailyHabitsData[dateStr]) dailyHabitsData[dateStr] = {};
            const nv = !dailyHabitsData[dateStr][habit];
            dailyHabitsData[dateStr][habit] = nv;
            localStorage.setItem('daily_habits', JSON.stringify(dailyHabitsData));
            updateDailyHistoryTable();
            const today = new Date().toISOString().split('T')[0];
            if (dateStr === today) {
                const cb = document.querySelector(`.habit-check[data-habit="${habit}"]`);
                if (cb) { cb.checked = nv; updateDailyProgress(); return; }
            }
            writeHabitToNotion(dateStr, habit, nv);
        }

        // ==================== IDEAS ====================
        let ideasData = JSON.parse(localStorage.getItem('ideas_data') || '[]');
        let ideasNotionIndex = JSON.parse(localStorage.getItem('ideas_notion_index') || '{}');
        let currentIdeasFilter = 'all';

        async function saveIdea() {
            const text = document.getElementById('idea-text').value;
            const type = document.getElementById('idea-type').value;
            const priority = document.getElementById('idea-priority') ? document.getElementById('idea-priority').value : '‚≠ê ‰∏≠';
            const notes = document.getElementById('idea-notes') ? document.getElementById('idea-notes').value : '';
            if (!text) return;
            const idea = {
                id: 'local-' + Date.now(),
                text, type, priority,
                status: 'üí° Êñ∞ÊÉ≥Ê≥ï',
                date: new Date().toISOString().split('T')[0],
                notes
            };
            ideasData.unshift(idea);
            localStorage.setItem('ideas_data', JSON.stringify(ideasData));
            document.getElementById('idea-text').value = '';
            if (document.getElementById('idea-notes')) document.getElementById('idea-notes').value = '';
            renderIdeasList();
            updateIdeasStats();
            // Sync to Notion
            const url = getN8nUrl();
            if (url) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'create_idea',
                            data: { text: idea.text, type: idea.type, status: idea.status, priority: idea.priority, date: idea.date, notes: idea.notes }
                        })
                    });
                    const data = await res.json();
                    if (data.pageId) {
                        idea.id = data.pageId;
                        ideasNotionIndex[data.pageId] = data.pageId;
                        localStorage.setItem('ideas_data', JSON.stringify(ideasData));
                        localStorage.setItem('ideas_notion_index', JSON.stringify(ideasNotionIndex));
                    }
                } catch(e) { console.error('[RayOS] Idea sync error:', e); }
            }
            showToast('Idea saved');
        }

        async function syncIdeasFromNotion(silent = false) {
            const url = getN8nUrl();
            if (!url) { if (!silent) showToast('Ë´ãÂÖàË®≠ÂÆö n8n Webhook URL', true); return; }
            if (!silent) showToast('Ê≠£Âú®ÂêåÊ≠• Ideas...');
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'fetch_ideas' })
                });
                if (!res.ok) throw new Error('n8n returned ' + res.status);
                const data = await res.json();
                if (data.records && data.records.length > 0) {
                    ideasNotionIndex = data.pageIndex || {};
                    localStorage.setItem('ideas_notion_index', JSON.stringify(ideasNotionIndex));
                    ideasData = data.records.map(r => ({
                        id: r.id || r.pageId || ('notion-' + Math.random()),
                        text: r.text || '',
                        type: r.type || 'ü§î ÂÖ∂‰ªñ',
                        status: r.status || 'üí° Êñ∞ÊÉ≥Ê≥ï',
                        priority: r.priority || '‚≠ê ‰∏≠',
                        date: r.date || '',
                        notes: r.notes || ''
                    })).sort((a,b) => (b.date || '').localeCompare(a.date || ''));
                    localStorage.setItem('ideas_data', JSON.stringify(ideasData));
                    renderIdeasList();
                    updateIdeasStats();
                    updateIdeasSyncDot();
                    if (!silent) showToast('Synced ' + ideasData.length + ' ideas');
                } else {
                    if (!silent) showToast('No ideas found in Notion');
                }
            } catch(e) {
                console.error('[RayOS] Ideas sync error:', e);
                if (!silent) showToast('Ideas ÂêåÊ≠•Â§±Êïó: ' + e.message, true);
            }
        }

        async function updateIdeaStatus(ideaId, newStatus) {
            const idea = ideasData.find(i => i.id === ideaId);
            if (!idea) return;
            idea.status = newStatus;
            localStorage.setItem('ideas_data', JSON.stringify(ideasData));
            renderIdeasList();
            updateIdeasStats();
            // Sync to Notion
            const url = getN8nUrl();
            if (url && ideasNotionIndex[ideaId]) {
                try {
                    await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'update_idea', pageId: ideaId, data: { status: newStatus } })
                    });
                } catch(e) { console.error('[RayOS] Idea update error:', e); }
            }
        }

        function setIdeasFilter(filter) {
            currentIdeasFilter = filter;
            document.querySelectorAll('.ideas-filter-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.ideas-filter-btn[data-filter="${filter}"]`);
            if (btn) btn.classList.add('active');
            renderIdeasList();
        }

        function renderIdeasList() {
            const container = document.getElementById('ideas-list');
            if (!container) return;
            const statusMap = {
                'all': null,
                'new': 'üí° Êñ∞ÊÉ≥Ê≥ï',
                'research': 'üîç Á†îÁ©∂‰∏≠',
                'active': 'üöÄ Âü∑Ë°å‰∏≠',
                'done': '‚úÖ Â∑≤ÂÆåÊàê'
            };
            const filterStatus = statusMap[currentIdeasFilter];
            const filtered = filterStatus ? ideasData.filter(i => i.status === filterStatus) : ideasData;

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No ideas yet. Start capturing!</div>';
                return;
            }

            container.innerHTML = filtered.map(idea => {
                const statusOptions = ['üí° Êñ∞ÊÉ≥Ê≥ï','üîç Á†îÁ©∂‰∏≠','üöÄ Âü∑Ë°å‰∏≠','‚úÖ Â∑≤ÂÆåÊàê','‚ùå ÊîæÊ£Ñ'].map(s =>
                    `<option value="${s}" ${s === idea.status ? 'selected' : ''}>${s}</option>`
                ).join('');
                return `<div class="idea-card" style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
                        <div style="flex:1;">
                            <div style="font-weight:600;margin-bottom:4px;">${idea.text}</div>
                            <div style="font-size:12px;color:var(--text-muted);">
                                <span style="margin-right:10px;">${idea.type}</span>
                                <span style="margin-right:10px;">${idea.priority}</span>
                                <span>${idea.date}</span>
                            </div>
                            ${idea.notes ? `<div style="font-size:12px;color:var(--text-muted);margin-top:4px;font-style:italic;">${idea.notes}</div>` : ''}
                        </div>
                        <select class="form-input" style="width:auto;font-size:12px;padding:4px 8px;" onchange="updateIdeaStatus('${idea.id}',this.value)">${statusOptions}</select>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('stat-ideas').textContent = ideasData.length;
        }

        function updateIdeasStats() {
            const total = ideasData.length;
            const newCount = ideasData.filter(i => i.status === 'üí° Êñ∞ÊÉ≥Ê≥ï').length;
            const activeCount = ideasData.filter(i => i.status === 'üöÄ Âü∑Ë°å‰∏≠').length;
            const doneCount = ideasData.filter(i => i.status === '‚úÖ Â∑≤ÂÆåÊàê').length;
            const el = document.getElementById('ideas-stats');
            if (el) el.innerHTML = `<span>Total: ${total}</span> <span>New: ${newCount}</span> <span>Active: ${activeCount}</span> <span>Done: ${doneCount}</span>`;
            document.getElementById('stat-ideas').textContent = total;
        }

        function updateIdeasSyncDot() {
            const d = document.getElementById('ideas-sync-dot');
            if (d) d.className = 'sync-dot ' + (getN8nUrl() ? 'on' : 'off');
        }

        // ==================== INIT ====================
        (function init() {
            // üîÑ Migration v2: clear old preloaded daily habits cache
            if (localStorage.getItem('daily_data_version') !== '2') {
                localStorage.removeItem('daily_habits');
                localStorage.removeItem('notion_page_index');
                dailyHabitsData = {};
                notionPageIndex = {};
                localStorage.setItem('daily_data_version', '2');
                console.log('[RayOS] Cleared old preload cache ‚Äî will sync from Notion');
            }
            // üîÑ Migration v4: update body data to verified Notion values (2025-03-08 start)
            if (localStorage.getItem('body_data_version') !== '4') {
                localStorage.removeItem('body_history');
                localStorage.removeItem('body_notion_index');
                bodyHistory = JSON.parse(JSON.stringify(PRELOAD_BODY_HISTORY));
                bodyNotionIndex = {};
                localStorage.setItem('body_data_version', '4');
                console.log('[RayOS] Reset body data to verified Notion values v4');
            }
            
            document.getElementById('wealth-quote-text').textContent = '"' + quote.text + '"';
            document.getElementById('wealth-quote-author').textContent = '‚Äî ' + quote.author;
            document.getElementById('goal-target').textContent = formatNumber(wealthGoal);
            
            if(localStorage.getItem('notion_token')) document.getElementById('notion-token').value = localStorage.getItem('notion_token');
            if(localStorage.getItem('n8n_webhook')) document.getElementById('n8n-webhook').value = localStorage.getItem('n8n_webhook');
            if(localStorage.getItem('anthropic_key')) document.getElementById('anthropic-key').value = localStorage.getItem('anthropic_key');
            if(localStorage.getItem('ai_model')) document.getElementById('ai-model').value = localStorage.getItem('ai_model');
            if(localStorage.getItem('ai_profile')) document.getElementById('ai-profile').value = localStorage.getItem('ai_profile');
            
            document.getElementById('body-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('biz-date').value = new Date().toISOString().split('T')[0];
            
            updateWealthDisplay();
            updateBizDisplay();
            updateTradingDisplay();
            loadBodyProgressFromDrive(); // Load cached body progress photos before physic display
            updatePhysicDisplay();
            loadDailyHabits(true); // skipNotionCreate on init ‚Äî wait for sync
            renderAccountManager();
            updateSyncDot();
            updateBodySyncDot();
            updateWealthSyncDot();
            updateIdeasSyncDot();
            renderIdeasList();
            updateIdeasStats();
            updateModelBadges();
            
            // üñºÔ∏è Moodboard: render immediately from cache/defaults, then sync from Drive
            renderMoodboard();
            if (localStorage.getItem('drive_script_url')) {
                document.getElementById('drive-script-url').value = localStorage.getItem('drive_script_url');
                const syncDate = localStorage.getItem('moodboard_sync_date');
                const todayStr = new Date().toISOString().split('T')[0];
                if (syncDate !== todayStr) {
                    setTimeout(() => syncMoodboardFromDrive(), 800);
                } else {
                    const driveData = localStorage.getItem('moodboard_drive_data');
                    if (driveData) {
                        const imgs = JSON.parse(driveData);
                        const statusEl = document.getElementById('drive-status');
                        if (statusEl) statusEl.textContent = '‚úÖ ' + imgs.length + ' ÂºµÂúñÁâá';
                    }
                }
            }
            
            // üîÑ È†ÅÈù¢ËºâÂÖ•Ëá™ÂãïÂæû Notion ÂêåÊ≠•ÊúÄÊñ∞Ë≥áÊñô
            if (hasNotionDirect() || getN8nUrl()) {
                // Daily Habits: ÂÑ™ÂÖàÁî® Notion DirectÔºåÂ§±ÊïóÊâç fallback n8n
                setTimeout(async () => {
                    const ok = await syncDailyFromNotionDirect(true);
                    if (!ok) {
                        loadDailyHabits(true);
                    }
                }, 500);
                // Body/Wealth/Ideas auto-sync: Âè™Âú®Êúâ N8N URL ‰∏î„ÄåÊ≤íÊúâ„ÄçNotion Token ÊôÇËß∏Áôº
                // Êúâ Notion Token ÊôÇË∑≥ÈÅé N8NÔºåÈÅøÂÖç N8N error
                if (getN8nUrl() && !hasNotionDirect()) {
                    if (bodyHistory.length <= 3) {
                        setTimeout(() => syncBodyFromNotion(), 1200);
                    }
                    setTimeout(() => syncWealthFromNotion(true), 1500);
                    setTimeout(() => syncIdeasFromNotion(true), 1800);
                }
            }
            
            document.getElementById('wealth-ai-input').addEventListener('keypress', e => { if (e.key === 'Enter') askWealthAI(); });
            document.getElementById('biz-ai-input').addEventListener('keypress', e => { if (e.key === 'Enter') askBizAI(); });
            document.getElementById('body-ai-input').addEventListener('keypress', e => { if (e.key === 'Enter') askBodyAI(); });
            document.getElementById('trading-ai-input').addEventListener('keypress', e => { if (e.key === 'Enter') askTradingAI(); });
        })();
    </script>
</body>
</html>
