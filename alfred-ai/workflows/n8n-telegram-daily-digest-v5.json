{
  "name": "Ray AI ç®¡å®¶ â€” æ¯æ—¥è³‡è¨Šæ•´ç† v5.1",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "schedule-001",
      "name": "Every Day 8AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        300
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 20 * * *"
            }
          ]
        }
      },
      "id": "schedule-002",
      "name": "Every Day 8PM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== v5.1: æ··åˆæ¨¡å¼ â€” RSS + YouTube Atom + Apify IG =====\n// RSS: AI/Tech æ–°èã€Trading æ–°è\n// YouTube: Atom Feedï¼ˆé »é“è¨‚é–± from Notionï¼‰\n// IG: Apifyï¼ˆå·²é©—è­‰å¯ç”¨ï¼‰\n// X/Twitter: æš«æ™‚è·³éï¼ˆç­‰ Apify actor å•Ÿç”¨å¾Œå†åŠ ï¼‰\n\nconst apifyCredentials = await this.helpers.getCredentials('httpHeaderAuth');\nconst APIFY_AUTH = apifyCredentials.value;\n\nconst notionCredentials = await this.helpers.getCredentials('notionApi');\nconst NOTION_TOKEN = notionCredentials.apiKey;\n\n// ===== è¨­å®šå€ =====\nconst IG_ACTOR = 'apify/instagram-scraper';\nconst APIFY_BASE = 'https://api.apify.com/v2';\n\nconst igAccounts = ['openai', 'anthropicai'];\n\nconst rssFeeds = [\n  { category: 'ğŸ¤– AI & Tech', url: 'https://hnrss.org/newest?q=AI+LLM+Claude&points=50' },\n  { category: 'ğŸ¤– AI & Tech', url: 'https://news.google.com/rss/search?q=AI%E4%BA%BA%E5%B7%A5%E6%99%BA%E6%85%A7+Claude+GPT&hl=zh-TW&gl=TW&ceid=TW:zh-Hant' },\n  { category: 'ğŸ“ˆ Trading & Prop Firm', url: 'https://news.google.com/rss/search?q=prop+firm+funded+trader+algorithmic+trading&hl=en&gl=US' },\n  { category: 'ğŸš€ å‰µæ¥­ & å•†æ¥­', url: 'https://news.google.com/rss/search?q=Skool+creator+economy+online+business&hl=en&gl=US' }\n];\n\n// ===== å·¥å…·å‡½å¼ =====\n\nfunction extractRssItems(xml, category, maxItems = 5) {\n  if (!xml || typeof xml !== 'string') return [];\n  const items = [];\n  const regex = /<item>(.*?)<\\/item>/gs;\n  let match;\n  while ((match = regex.exec(xml)) !== null && items.length < maxItems) {\n    const titleMatch = match[1].match(/<title>(?:<!\\[CDATA\\[)?(.*?)(?:\\]\\]>)?<\\/title>/);\n    const descMatch = match[1].match(/<description>(?:<!\\[CDATA\\[)?(.*?)(?:\\]\\]>)?<\\/description>/s);\n    if (titleMatch) {\n      items.push({\n        category,\n        title: titleMatch[1].replace(/<[^>]*>/g, '').trim(),\n        description: descMatch ? descMatch[1].replace(/<[^>]*>/g, '').substring(0, 200).trim() : ''\n      });\n    }\n  }\n  return items;\n}\n\nfunction extractAtomEntries(xml, sourceName, maxItems = 5, hoursAgo = 48) {\n  if (!xml || typeof xml !== 'string') return [];\n  const entries = [];\n  const cutoff = new Date(Date.now() - hoursAgo * 60 * 60 * 1000);\n  const regex = /<entry>(.*?)<\\/entry>/gs;\n  let match;\n  while ((match = regex.exec(xml)) !== null && entries.length < maxItems) {\n    const titleMatch = match[1].match(/<title>(.*?)<\\/title>/);\n    const pubMatch = match[1].match(/<published>(.*?)<\\/published>/);\n    const descMatch = match[1].match(/<media:description>(.*?)<\\/media:description>/s);\n    if (titleMatch) {\n      const pubDate = pubMatch ? new Date(pubMatch[1]) : new Date(0);\n      if (pubDate >= cutoff) {\n        entries.push({\n          source: sourceName,\n          title: titleMatch[1].trim(),\n          description: descMatch ? descMatch[1].replace(/<[^>]*>/g, '').substring(0, 200).trim() : '',\n          published: pubMatch ? pubMatch[1] : ''\n        });\n      }\n    }\n  }\n  return entries;\n}\n\n// ===== 1. æŠ“ RSS æ–°è =====\nlet allRssItems = [];\nfor (const feed of rssFeeds) {\n  try {\n    const res = await this.helpers.httpRequest({ method: 'GET', url: feed.url, timeout: 15000 });\n    allRssItems = allRssItems.concat(extractRssItems(String(res), feed.category));\n  } catch (e) {}\n}\n\n// ===== 2. å¾ Notion è¼‰å…¥ YouTube è¨‚é–± + æŠ“ Atom Feed =====\nlet channels = [];\ntry {\n  const DB_ID = 'b57a9c1760784b93b003f221262ff635';\n  const notionRes = await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://api.notion.com/v1/databases/${DB_ID}/query`,\n    headers: {\n      'Authorization': `Bearer ${NOTION_TOKEN}`,\n      'Notion-Version': '2022-06-28',\n      'Content-Type': 'application/json'\n    },\n    body: { filter: { property: 'ç‹€æ…‹', select: { equals: 'âœ… å•Ÿç”¨' } } },\n    json: true\n  });\n  for (const page of (notionRes.results || [])) {\n    const props = page.properties;\n    const type = props['é¡å‹']?.select?.name || '';\n    const name = props['Name']?.title?.[0]?.plain_text || '';\n    if (type === 'ğŸ“º é »é“') {\n      const channelId = props['Channel ID']?.rich_text?.[0]?.plain_text || '';\n      if (channelId && name) channels.push({ name, channelId });\n    }\n  }\n} catch (e) {}\n\nlet allYtEntries = [];\nfor (const ch of channels) {\n  try {\n    const url = `https://www.youtube.com/feeds/videos.xml?channel_id=${ch.channelId}`;\n    const res = await this.helpers.httpRequest({ method: 'GET', url, timeout: 10000 });\n    allYtEntries.push(...extractAtomEntries(String(res), ch.name));\n  } catch (e) {}\n}\n\n// ===== 3. Apify IG =====\nlet igPosts = [];\ntry {\n  const encodedActor = IG_ACTOR.replace('/', '~');\n  const igResult = await this.helpers.httpRequest({\n    method: 'POST',\n    url: `${APIFY_BASE}/acts/${encodedActor}/run-sync-get-dataset-items`,\n    headers: { 'Authorization': APIFY_AUTH, 'Content-Type': 'application/json' },\n    body: {\n      directUrls: igAccounts.map(acc => `https://www.instagram.com/${acc}/`),\n      resultsLimit: igAccounts.length * 3,\n      resultsType: 'posts'\n    },\n    json: true,\n    timeout: 120000\n  });\n  if (Array.isArray(igResult)) igPosts = igResult;\n} catch (e) {}\n\n// ===== 4. çµ„åˆæ‰€æœ‰è³‡æ–™ =====\nlet feedText = '';\n\n// RSS\nlet currentCat = '';\nfor (const item of allRssItems) {\n  if (item.category !== currentCat) {\n    currentCat = item.category;\n    feedText += `\\n\\n--- ${item.category} ---\\n`;\n  }\n  feedText += `- ${item.title}\\n  ${item.description}\\n`;\n}\n\n// YouTube\nif (allYtEntries.length > 0) {\n  feedText += '\\n\\n--- ğŸ¬ YouTube é »é“æ›´æ–°ï¼ˆ48hï¼‰ ---\\n';\n  for (const entry of allYtEntries) {\n    feedText += `- [${entry.source}] ${entry.title}\\n  ${entry.description}\\n`;\n  }\n}\n\n// IG\nif (igPosts.length > 0) {\n  feedText += '\\n\\n--- ğŸ“¸ Instagram ---\\n';\n  for (const post of igPosts.slice(0, 10)) {\n    const owner = post.ownerUsername || '?';\n    const caption = (post.caption || '').substring(0, 300);\n    const likes = post.likesCount || 0;\n    feedText += `- [@${owner}] ${caption}\\n  â¤ï¸ ${likes}\\n`;\n  }\n}\n\nconst rssCount = allRssItems.length;\nconst ytCount = allYtEntries.length;\nconst igCount = igPosts.length;\n\nif (rssCount === 0 && ytCount === 0 && igCount === 0) {\n  feedText = 'ï¼ˆä»Šæ—¥æ‰€æœ‰ä¾†æºéƒ½æŠ“å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥è¨­å®šï¼‰';\n}\n\nreturn [{ json: { feedText, rssCount, ytCount, igCount, xCount: 0, totalCount: rssCount + ytCount + igCount } }];"
      },
      "id": "code-fetch-all",
      "name": "Fetch All Sources",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "37nmRPEB7OfEE22B",
          "name": "Apify API Token"
        },
        "notionApi": {
          "id": "ixkhHExGT30Z2UWZ",
          "name": "Alfred AI"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $credentials.httpHeaderAuth.value }}"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'claude-sonnet-4-5-20250929', max_tokens: 3000, system: 'ä½ æ˜¯ Ray çš„å€‹äººè³‡è¨ŠåŠ©ç† Alfredã€‚\\n\\nRay æ˜¯ä¸€å€‹ YouTube å…§å®¹å‰µä½œè€…ï¼Œå°ˆæ³¨æ–¼ Prop Firm äº¤æ˜“æ•™å­¸ï¼ŒåŒæ™‚ä¹Ÿåœ¨é–‹ç™¼ AI è‡ªå‹•åŒ–å·¥å…·ï¼ˆRayOSï¼‰ã€‚\\n\\nä»¥ä¸‹æ˜¯éå» 24 å°æ™‚å¾ X/Twitterã€Instagramã€YouTube æ”¶é›†åˆ°çš„è³‡è¨Šã€‚è«‹å¹«æˆ‘ï¼š\\n\\n1. å¾æ‰€æœ‰ä¾†æºä¸­ï¼ŒæŒ‘å‡ºæœ€å€¼å¾—æˆ‘é—œæ³¨çš„ 8-10 å‰‡\\n2. åˆ†é¡ç‚ºï¼šğŸ¤– AI/Techã€ğŸ“ˆ Tradingã€ğŸ¬ Content Creation\\n3. æ¯å‰‡ç”¨ 2-3 å¥ç¹é«”ä¸­æ–‡æ‘˜è¦\\n4. æ¨™è¨»ä¾†æºå¹³å°ï¼ˆX/IG/YTï¼‰\\n5. æ¨™è¨»ã€Œâš¡ è¡Œå‹•å»ºè­°ã€ï¼šæˆ‘éœ€è¦é¦¬ä¸Šåšä»€éº¼å—ï¼Ÿ\\n\\néæ¿¾æ¨™æº–ï¼ˆå„ªå…ˆåº¦ç”±é«˜åˆ°ä½ï¼‰ï¼š\\n- å¯ä»¥ç›´æ¥ç”¨åœ¨æˆ‘å·¥ä½œæµç¨‹çš„å·¥å…·æˆ–æ–¹æ³•\\n- äº¤æ˜“ç”¢æ¥­çš„é‡å¤§è®ŠåŒ–æˆ–æ–°è¦å®š\\n- å€¼å¾—æˆ‘æ‹å½±ç‰‡è¬›çš„è©±é¡Œ\\n- å…§å®¹å‰µä½œçš„æ–°è¶¨å‹¢æˆ–å¹³å°è®ŠåŒ–\\n\\néæ¿¾æ‰ï¼š\\n- ç´”ç‚’ä½œã€æ²’æœ‰å¯¦è³ªå…§å®¹çš„æ¨æ–‡\\n- è·Ÿæˆ‘é ˜åŸŸå®Œå…¨ç„¡é—œçš„æŠ€è¡“æ–°è\\n- é‡è¤‡çš„è³‡è¨Šï¼ˆä¸åŒä¾†æºè¬›åŒä¸€ä»¶äº‹åªç•™ä¸€å‰‡ï¼‰\\n\\nè¼¸å‡ºæ ¼å¼ï¼ˆä½¿ç”¨ Telegram HTML æ¨™ç±¤ï¼‰ï¼š\\n\\n<b>ğŸ“Š Alfred æ¯æ—¥æƒ…å ±</b>\\n\\n<b>ğŸ¤– AI/Tech</b>\\n1. [X] æ¨™é¡Œ\\n   æ‘˜è¦å…§å®¹\\n   âš¡ è¡Œå‹•å»ºè­°ï¼ˆå¦‚æœæœ‰ï¼‰\\n\\n2. [YT] æ¨™é¡Œ\\n   æ‘˜è¦å…§å®¹\\n\\n<b>ğŸ“ˆ Trading</b>\\n1. [IG] æ¨™é¡Œ\\n   æ‘˜è¦å…§å®¹\\n\\n<b>ğŸ¬ Content Creation</b>\\n1. ...\\n\\n---\\nğŸ¯ ä»Šæ—¥æœ€é‡è¦çš„ä¸€ä»¶äº‹ï¼š{AI æŒ‘å‡ºæœ€å€¼å¾—é—œæ³¨çš„}\\nğŸ“Œ æœ¬é€±è¶¨å‹¢è§€å¯Ÿï¼š{å¦‚æœæœ‰æ˜é¡¯è¶¨å‹¢çš„è©±}\\n\\né‡è¦è¦å‰‡ï¼š\\n- ä½¿ç”¨ HTML æ¨™ç±¤æ ¼å¼åŒ–ï¼ˆ<b>ç²—é«”</b>ã€<i>æ–œé«”</i>ï¼‰\\n- çµ•å°ä¸è¦ç”¨ Markdown çš„ * æˆ– ** æˆ– ` æ ¼å¼\\n- å¦‚æœéœ€è¦é¡¯ç¤º < > ç¬¦è™Ÿï¼Œç”¨ &lt; &gt; æ›¿ä»£\\n- ä¿æŒè¨Šæ¯ä¹¾æ·¨ï¼Œä¸é™„é€£çµ', messages: [{ role: 'user', content: 'ä»¥ä¸‹æ˜¯ä»Šå¤©çš„è³‡è¨Š feedsï¼ˆRSS ' + $json.rssCount + ' å‰‡ + YouTube ' + $json.ytCount + ' æ”¯ + IG ' + $json.igCount + ' å‰‡ï¼‰ï¼š\\n' + $json.feedText + '\\n\\nè«‹æ•´ç†æˆæ¯æ—¥æ‘˜è¦ã€‚' }] }) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 60000
        }
      },
      "id": "claude-digest-001",
      "name": "Claude Curate Digest",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        580,
        400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "WWmI3Lnd1wXqanNm",
          "name": "Anthropic API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ ¼å¼åŒ–æ‘˜è¦ + åˆ†æ®µï¼ˆé¿å… Telegram 4096 å­—å…ƒé™åˆ¶ï¼‰\nconst content = $input.first().json;\nlet text = '';\n\nif (content.content && content.content[0] && content.content[0].text) {\n  text = content.content[0].text;\n} else {\n  text = 'âš ï¸ Claude API å›è¦†ç•°å¸¸ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ workflowã€‚';\n}\n\n// ç§»é™¤ Markdown æ ¼å¼ï¼Œä¿ç•™ HTML\ntext = text.replace(/\\*\\*/g, '');\ntext = text.replace(/\\*/g, '');\n\n// åŠ ä¸Šæ—¥æœŸå’Œç°½å\nconst now = new Date();\nconst taipeiOffset = 8 * 60;\nconst taipeiTime = new Date(now.getTime() + (taipeiOffset + now.getTimezoneOffset()) * 60000);\nconst today = taipeiTime.toISOString().split('T')[0];\nconst hour = taipeiTime.getHours();\nconst period = hour < 14 ? 'â˜€ï¸ æ—©å®‰' : 'ğŸŒ™ æ™šå®‰';\n\n// åŠ ä¸ŠæŠ“å–çµ±è¨ˆ\nconst fetchNode = $('Fetch All Sources').first().json;\nconst stats = `ğŸ“Š ä¾†æºï¼šRSS ${fetchNode.rssCount || 0} å‰‡ / YT ${fetchNode.ytCount || 0} æ”¯ / IG ${fetchNode.igCount || 0} å‰‡`;\n\ntext += `\\n\\n---\\nğŸ“… ${today} ${period} | ${stats}\\nğŸ¤– Ray AI ç®¡å®¶ Alfred v5`;\n\n// åˆ†æ®µè™•ç†ï¼ˆTelegram å–®å‰‡è¨Šæ¯ä¸Šé™ 4096 å­—å…ƒï¼‰\nconst MAX_LEN = 4000;\nif (text.length <= MAX_LEN) {\n  return [{ json: { digest: text, parseMode: 'HTML' } }];\n}\n\nconst sections = text.split('\\n\\n');\nconst messages = [];\nlet current = '';\nfor (const section of sections) {\n  if ((current + '\\n\\n' + section).length > MAX_LEN && current.length > 0) {\n    messages.push(current.trim());\n    current = section;\n  } else {\n    current = current ? current + '\\n\\n' + section : section;\n  }\n}\nif (current.trim()) messages.push(current.trim());\n\nreturn messages.map((msg) => ({ json: { digest: msg, parseMode: 'HTML' } }));"
      },
      "id": "code-format-001",
      "name": "Format Digest",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        860,
        400
      ]
    },
    {
      "parameters": {
        "chatId": "925855884",
        "text": "={{ $json.digest }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "tg-send-digest",
      "name": "Send Daily Digest",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1140,
        400
      ],
      "credentials": {
        "telegramApi": {
          "id": "BCP0r7DgDFjUN976",
          "name": "Alfred AI"
        }
      }
    },
    {
      "parameters": {
        "chatId": "925855884",
        "text": "={{ 'âš ï¸ Alfred Daily Digest åŸ·è¡Œå‡ºéŒ¯\\n\\néŒ¯èª¤ç¯€é»ï¼š' + $json.execution?.error?.node || 'æœªçŸ¥' + '\\néŒ¯èª¤è¨Šæ¯ï¼š' + $json.execution?.error?.message || 'æœªçŸ¥éŒ¯èª¤' + '\\n\\nè«‹åˆ° n8n æª¢æŸ¥ workflow åŸ·è¡Œç´€éŒ„ã€‚' }}",
        "additionalFields": {}
      },
      "id": "tg-send-error",
      "name": "Send Error Notification",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1140,
        600
      ],
      "credentials": {
        "telegramApi": {
          "id": "BCP0r7DgDFjUN976",
          "name": "Alfred AI"
        }
      }
    }
  ],
  "connections": {
    "Every Day 8AM": {
      "main": [
        [
          {
            "node": "Fetch All Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every Day 8PM": {
      "main": [
        [
          {
            "node": "Fetch All Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude Curate Digest": {
      "main": [
        [
          {
            "node": "Format Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Digest": {
      "main": [
        [
          {
            "node": "Send Daily Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch All Sources": {
      "main": [
        [
          {
            "node": "Claude Curate Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "timezone": "Asia/Taipei"
  },
  "staticData": null,
  "tags": [
    {
      "name": "telegram"
    },
    {
      "name": "daily-digest"
    },
    {
      "name": "ai"
    },
    {
      "name": "apify"
    },
    {
      "name": "youtube"
    },
    {
      "name": "twitter"
    },
    {
      "name": "instagram"
    },
    {
      "name": "alfred"
    }
  ],
  "triggerCount": 2,
  "pinData": {}
}