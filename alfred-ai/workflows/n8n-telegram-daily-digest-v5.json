{
  "name": "Ray AI ç®¡å®¶ â€” æ¯æ—¥è³‡è¨Šæ•´ç† v5.0",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "cronExpression", "expression": "0 8 * * *" }]
        }
      },
      "id": "schedule-001",
      "name": "Every Day 8AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 300]
    },
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "cronExpression", "expression": "0 20 * * *" }]
        }
      },
      "id": "schedule-002",
      "name": "Every Day 8PM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 500]
    },
    {
      "parameters": {
        "jsCode": "// ===== v5.0: ç”¨ Apify çµ±ä¸€æŠ“å– X/IG/YouTube =====\n// é€é n8n credential å–å¾— API tokens\n\nconst apifyCredentials = await this.helpers.getCredentials('httpHeaderAuth');\nconst APIFY_TOKEN = apifyCredentials.value;\n\nconst notionCredentials = await this.helpers.getCredentials('notionApi');\nconst NOTION_TOKEN = notionCredentials.apiKey;\n\n// ===== è¨­å®šå€ï¼ˆå°æ‡‰ configs/ è³‡æ–™å¤¾çš„è¨­å®šï¼‰ =====\n\n// X/Twitter å¸³è™Ÿï¼ˆå°æ‡‰ configs/x-accounts.jsonï¼‰\nconst xAccounts = [\n  '@AnthropicAI',\n  '@OpenAI',\n  '@skirano',\n  '@kabortz',\n  '@alexalbert__',\n  '@hwchase17'\n];\nconst xKeywords = ['AI agent', 'Claude Code', 'prop firm', 'n8n automation'];\n\n// Instagram å¸³è™Ÿï¼ˆå°æ‡‰ configs/ig-accounts.jsonï¼‰\nconst igAccounts = [\n  'openai',\n  'anthropicai'\n];\n\n// YouTube å›ºå®šé »é“ï¼ˆå°æ‡‰ configs/yt-channels.jsonï¼‰\nconst ytFixedChannels = [\n  { name: 'Anthropic', url: 'https://www.youtube.com/@anthropic-ai' }\n];\nconst ytKeywords = ['AI automation', 'Claude Code', 'prop firm trading', 'n8n workflow'];\n\n// Apify Actor IDsï¼ˆå°æ‡‰ configs/apify-config.jsonï¼‰\nconst TWITTER_ACTOR = 'apidojo/tweet-scraper';\nconst IG_ACTOR = 'apify/instagram-scraper';\nconst YT_ACTOR = 'bernardo/youtube-scraper';\n\nconst APIFY_BASE = 'https://api.apify.com/v2';\nconst TIMEOUT = 120000; // 2 åˆ†é˜\n\n// ===== å·¥å…·å‡½å¼ =====\n\nasync function runApifyActor(actorId, input) {\n  try {\n    const encodedActorId = actorId.replace('/', '~');\n    const response = await this.helpers.httpRequest({\n      method: 'POST',\n      url: `${APIFY_BASE}/acts/${encodedActorId}/run-sync-get-dataset-items`,\n      headers: {\n        'Authorization': `Bearer ${APIFY_TOKEN}`,\n        'Content-Type': 'application/json'\n      },\n      body: input,\n      json: true,\n      timeout: TIMEOUT\n    });\n    return { success: true, data: response };\n  } catch (e) {\n    return { success: false, error: e.message, actorId };\n  }\n}\n\n// ===== å¾ Notion è¼‰å…¥å‹•æ…‹ YouTube è¨‚é–± =====\n\nlet notionChannels = [];\nlet notionKeywords = [];\n\ntry {\n  const DB_ID = 'b57a9c1760784b93b003f221262ff635';\n  const notionRes = await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://api.notion.com/v1/databases/${DB_ID}/query`,\n    headers: {\n      'Authorization': `Bearer ${NOTION_TOKEN}`,\n      'Notion-Version': '2022-06-28',\n      'Content-Type': 'application/json'\n    },\n    body: {\n      filter: {\n        property: 'ç‹€æ…‹',\n        select: { equals: 'âœ… å•Ÿç”¨' }\n      }\n    },\n    json: true\n  });\n\n  for (const page of (notionRes.results || [])) {\n    const props = page.properties;\n    const type = props['é¡å‹']?.select?.name || '';\n    const name = props['Name']?.title?.[0]?.plain_text || '';\n    if (type === 'ğŸ“º é »é“') {\n      const channelId = props['Channel ID']?.rich_text?.[0]?.plain_text || '';\n      const channelUrl = props['URL']?.url || '';\n      if (name) notionChannels.push({ name, channelId, channelUrl });\n    } else if (type === 'ğŸ” é—œéµå­—') {\n      if (name) notionKeywords.push(name);\n    }\n  }\n} catch (e) {\n  // Notion è¼‰å…¥å¤±æ•—ï¼Œç¹¼çºŒç”¨å›ºå®šæ¸…å–®\n}\n\n// åˆä½µå›ºå®š + Notion çš„ YouTube ä¾†æº\nconst allYtChannels = [...ytFixedChannels];\nfor (const ch of notionChannels) {\n  if (!allYtChannels.find(c => c.name === ch.name)) {\n    allYtChannels.push({ name: ch.name, url: ch.channelUrl || '' });\n  }\n}\nconst allYtKeywords = [...new Set([...ytKeywords, ...notionKeywords])];\n\n// ===== ä¸¦è¡ŒåŸ·è¡Œä¸‰å€‹ Apify æŠ“å– =====\n\nconst log = { x: 0, ig: 0, yt: 0, errors: [] };\n\n// æº–å‚™ Apify è¼¸å…¥\nconst twitterInput = {\n  startUrls: xAccounts.map(handle => ({\n    url: `https://twitter.com/${handle.replace('@', '')}`\n  })),\n  maxItems: xAccounts.length * 5,\n  sort: 'Latest'\n};\n\nconst igInput = {\n  directUrls: igAccounts.map(acc => `https://www.instagram.com/${acc}/`),\n  resultsLimit: igAccounts.length * 3,\n  resultsType: 'posts'\n};\n\nconst ytInput = {\n  searchKeywords: allYtKeywords.join(', '),\n  maxResults: 15,\n  startUrls: allYtChannels\n    .filter(ch => ch.url)\n    .map(ch => ({ url: ch.url }))\n};\n\n// åŒæ™‚å•Ÿå‹•ä¸‰å€‹æŠ“å–\nconst [xResult, igResult, ytResult] = await Promise.allSettled([\n  runApifyActor.call(this, TWITTER_ACTOR, twitterInput),\n  runApifyActor.call(this, IG_ACTOR, igInput),\n  runApifyActor.call(this, YT_ACTOR, ytInput)\n]);\n\n// ===== è™•ç†çµæœ =====\n\nlet feedText = '';\n\n// --- X/Twitter ---\nif (xResult.status === 'fulfilled' && xResult.value.success && Array.isArray(xResult.value.data)) {\n  const tweets = xResult.value.data;\n  log.x = tweets.length;\n  if (tweets.length > 0) {\n    feedText += '\\n\\n--- ğŸ¦ X/Twitter ---\\n';\n    for (const tweet of tweets.slice(0, 20)) {\n      const author = tweet.author?.userName || tweet.user?.screen_name || 'æœªçŸ¥';\n      const text = (tweet.text || tweet.full_text || '').substring(0, 300);\n      const likes = tweet.likeCount || tweet.favorite_count || 0;\n      const date = tweet.createdAt || tweet.created_at || '';\n      feedText += `- [@${author}] ${text}\\n  â¤ï¸ ${likes} | ${date}\\n`;\n    }\n  }\n} else {\n  const errMsg = xResult.status === 'rejected' ? xResult.reason : (xResult.value?.error || 'æœªçŸ¥éŒ¯èª¤');\n  log.errors.push(`X/Twitter æŠ“å–å¤±æ•—: ${errMsg}`);\n  feedText += '\\n\\n--- ğŸ¦ X/Twitter ---\\nï¼ˆæŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apify actor è¨­å®šï¼‰\\n';\n}\n\n// --- Instagram ---\nif (igResult.status === 'fulfilled' && igResult.value.success && Array.isArray(igResult.value.data)) {\n  const posts = igResult.value.data;\n  log.ig = posts.length;\n  if (posts.length > 0) {\n    feedText += '\\n\\n--- ğŸ“¸ Instagram ---\\n';\n    for (const post of posts.slice(0, 10)) {\n      const owner = post.ownerUsername || post.owner?.username || 'æœªçŸ¥';\n      const caption = (post.caption || '').substring(0, 300);\n      const likes = post.likesCount || post.likes?.count || 0;\n      feedText += `- [@${owner}] ${caption}\\n  â¤ï¸ ${likes}\\n`;\n    }\n  }\n} else {\n  const errMsg = igResult.status === 'rejected' ? igResult.reason : (igResult.value?.error || 'æœªçŸ¥éŒ¯èª¤');\n  log.errors.push(`Instagram æŠ“å–å¤±æ•—: ${errMsg}`);\n  feedText += '\\n\\n--- ğŸ“¸ Instagram ---\\nï¼ˆæŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apify actor è¨­å®šï¼‰\\n';\n}\n\n// --- YouTube ---\nif (ytResult.status === 'fulfilled' && ytResult.value.success && Array.isArray(ytResult.value.data)) {\n  const videos = ytResult.value.data;\n  log.yt = videos.length;\n  if (videos.length > 0) {\n    feedText += '\\n\\n--- ğŸ¬ YouTube ---\\n';\n    for (const video of videos.slice(0, 15)) {\n      const channel = video.channelName || video.channel || 'æœªçŸ¥';\n      const title = video.title || '';\n      const views = video.viewCount || video.views || 0;\n      const date = video.date || video.uploadDate || '';\n      feedText += `- [${channel}] ${title}\\n  ğŸ‘ï¸ ${views} views | ${date}\\n`;\n    }\n  }\n} else {\n  const errMsg = ytResult.status === 'rejected' ? ytResult.reason : (ytResult.value?.error || 'æœªçŸ¥éŒ¯èª¤');\n  log.errors.push(`YouTube æŠ“å–å¤±æ•—: ${errMsg}`);\n  feedText += '\\n\\n--- ğŸ¬ YouTube ---\\nï¼ˆæŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apify actor è¨­å®šï¼‰\\n';\n}\n\n// å¦‚æœå…¨éƒ¨å¤±æ•—\nif (log.x === 0 && log.ig === 0 && log.yt === 0) {\n  feedText = 'ï¼ˆä»Šæ—¥æ‰€æœ‰ä¾†æºéƒ½æŠ“å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ Apify è¨­å®šå’Œé¡åº¦ï¼‰\\n\\néŒ¯èª¤æ¸…å–®ï¼š\\n' + log.errors.join('\\n');\n}\n\nreturn [{ json: {\n  feedText,\n  xCount: log.x,\n  igCount: log.ig,\n  ytCount: log.yt,\n  errors: log.errors,\n  totalCount: log.x + log.ig + log.yt\n} }];"
      },
      "id": "code-fetch-all",
      "name": "Fetch All Sources via Apify",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 400],
      "credentials": {
        "httpHeaderAuth": {
          "id": "APIFY_CREDENTIAL_ID",
          "name": "Apify API Token"
        },
        "notionApi": {
          "id": "NOTION_CREDENTIAL_ID",
          "name": "Alfred Notion"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-api-key", "value": "={{ $credentials.httpHeaderAuth.value }}" },
            { "name": "anthropic-version", "value": "2023-06-01" },
            { "name": "content-type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'claude-sonnet-4-5-20250929', max_tokens: 3000, system: 'ä½ æ˜¯ Ray çš„å€‹äººè³‡è¨ŠåŠ©ç† Alfredã€‚\\n\\nRay æ˜¯ä¸€å€‹ YouTube å…§å®¹å‰µä½œè€…ï¼Œå°ˆæ³¨æ–¼ Prop Firm äº¤æ˜“æ•™å­¸ï¼ŒåŒæ™‚ä¹Ÿåœ¨é–‹ç™¼ AI è‡ªå‹•åŒ–å·¥å…·ï¼ˆRayOSï¼‰ã€‚\\n\\nä»¥ä¸‹æ˜¯éå» 24 å°æ™‚å¾ X/Twitterã€Instagramã€YouTube æ”¶é›†åˆ°çš„è³‡è¨Šã€‚è«‹å¹«æˆ‘ï¼š\\n\\n1. å¾æ‰€æœ‰ä¾†æºä¸­ï¼ŒæŒ‘å‡ºæœ€å€¼å¾—æˆ‘é—œæ³¨çš„ 8-10 å‰‡\\n2. åˆ†é¡ç‚ºï¼šğŸ¤– AI/Techã€ğŸ“ˆ Tradingã€ğŸ¬ Content Creation\\n3. æ¯å‰‡ç”¨ 2-3 å¥ç¹é«”ä¸­æ–‡æ‘˜è¦\\n4. æ¨™è¨»ä¾†æºå¹³å°ï¼ˆX/IG/YTï¼‰\\n5. æ¨™è¨»ã€Œâš¡ è¡Œå‹•å»ºè­°ã€ï¼šæˆ‘éœ€è¦é¦¬ä¸Šåšä»€éº¼å—ï¼Ÿ\\n\\néæ¿¾æ¨™æº–ï¼ˆå„ªå…ˆåº¦ç”±é«˜åˆ°ä½ï¼‰ï¼š\\n- å¯ä»¥ç›´æ¥ç”¨åœ¨æˆ‘å·¥ä½œæµç¨‹çš„å·¥å…·æˆ–æ–¹æ³•\\n- äº¤æ˜“ç”¢æ¥­çš„é‡å¤§è®ŠåŒ–æˆ–æ–°è¦å®š\\n- å€¼å¾—æˆ‘æ‹å½±ç‰‡è¬›çš„è©±é¡Œ\\n- å…§å®¹å‰µä½œçš„æ–°è¶¨å‹¢æˆ–å¹³å°è®ŠåŒ–\\n\\néæ¿¾æ‰ï¼š\\n- ç´”ç‚’ä½œã€æ²’æœ‰å¯¦è³ªå…§å®¹çš„æ¨æ–‡\\n- è·Ÿæˆ‘é ˜åŸŸå®Œå…¨ç„¡é—œçš„æŠ€è¡“æ–°è\\n- é‡è¤‡çš„è³‡è¨Šï¼ˆä¸åŒä¾†æºè¬›åŒä¸€ä»¶äº‹åªç•™ä¸€å‰‡ï¼‰\\n\\nè¼¸å‡ºæ ¼å¼ï¼ˆä½¿ç”¨ Telegram HTML æ¨™ç±¤ï¼‰ï¼š\\n\\n<b>ğŸ“Š Alfred æ¯æ—¥æƒ…å ±</b>\\n\\n<b>ğŸ¤– AI/Tech</b>\\n1. [X] æ¨™é¡Œ\\n   æ‘˜è¦å…§å®¹\\n   âš¡ è¡Œå‹•å»ºè­°ï¼ˆå¦‚æœæœ‰ï¼‰\\n\\n2. [YT] æ¨™é¡Œ\\n   æ‘˜è¦å…§å®¹\\n\\n<b>ğŸ“ˆ Trading</b>\\n1. [IG] æ¨™é¡Œ\\n   æ‘˜è¦å…§å®¹\\n\\n<b>ğŸ¬ Content Creation</b>\\n1. ...\\n\\n---\\nğŸ¯ ä»Šæ—¥æœ€é‡è¦çš„ä¸€ä»¶äº‹ï¼š{AI æŒ‘å‡ºæœ€å€¼å¾—é—œæ³¨çš„}\\nğŸ“Œ æœ¬é€±è¶¨å‹¢è§€å¯Ÿï¼š{å¦‚æœæœ‰æ˜é¡¯è¶¨å‹¢çš„è©±}\\n\\né‡è¦è¦å‰‡ï¼š\\n- ä½¿ç”¨ HTML æ¨™ç±¤æ ¼å¼åŒ–ï¼ˆ<b>ç²—é«”</b>ã€<i>æ–œé«”</i>ï¼‰\\n- çµ•å°ä¸è¦ç”¨ Markdown çš„ * æˆ– ** æˆ– ` æ ¼å¼\\n- å¦‚æœéœ€è¦é¡¯ç¤º < > ç¬¦è™Ÿï¼Œç”¨ &lt; &gt; æ›¿ä»£\\n- ä¿æŒè¨Šæ¯ä¹¾æ·¨ï¼Œä¸é™„é€£çµ', messages: [{ role: 'user', content: 'ä»¥ä¸‹æ˜¯ä»Šå¤©çš„è³‡è¨Š feedsï¼ˆX/Twitter ' + $json.xCount + ' å‰‡ + Instagram ' + $json.igCount + ' å‰‡ + YouTube ' + $json.ytCount + ' æ”¯ï¼‰ï¼š\\n' + $json.feedText + '\\n\\nè«‹æ•´ç†æˆæ¯æ—¥æ‘˜è¦ã€‚' }] }) }}",
        "options": {
          "response": { "response": { "responseFormat": "json" } },
          "timeout": 60000
        }
      },
      "id": "claude-digest-001",
      "name": "Claude Curate Digest",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [580, 400],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ANTHROPIC_CREDENTIAL_ID",
          "name": "Anthropic API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ ¼å¼åŒ–æ‘˜è¦ + åˆ†æ®µï¼ˆé¿å… Telegram 4096 å­—å…ƒé™åˆ¶ï¼‰\nconst content = $input.first().json;\nlet text = '';\n\nif (content.content && content.content[0] && content.content[0].text) {\n  text = content.content[0].text;\n} else {\n  text = 'âš ï¸ Claude API å›è¦†ç•°å¸¸ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥ workflowã€‚';\n}\n\n// ç§»é™¤ Markdown æ ¼å¼ï¼Œä¿ç•™ HTML\ntext = text.replace(/\\*\\*/g, '');\ntext = text.replace(/\\*/g, '');\n\n// åŠ ä¸Šæ—¥æœŸå’Œç°½å\nconst now = new Date();\nconst taipeiOffset = 8 * 60;\nconst taipeiTime = new Date(now.getTime() + (taipeiOffset + now.getTimezoneOffset()) * 60000);\nconst today = taipeiTime.toISOString().split('T')[0];\nconst hour = taipeiTime.getHours();\nconst period = hour < 14 ? 'â˜€ï¸ æ—©å®‰' : 'ğŸŒ™ æ™šå®‰';\n\n// åŠ ä¸ŠæŠ“å–çµ±è¨ˆ\nconst fetchNode = $('Fetch All Sources via Apify').first().json;\nconst stats = `ğŸ“Š ä¾†æºçµ±è¨ˆï¼šX ${fetchNode.xCount || 0} å‰‡ / IG ${fetchNode.igCount || 0} å‰‡ / YT ${fetchNode.ytCount || 0} æ”¯`;\n\ntext += `\\n\\n---\\nğŸ“… ${today} ${period} | ${stats}\\nğŸ¤– Ray AI ç®¡å®¶ Alfred v5`;\n\n// åˆ†æ®µè™•ç†ï¼ˆTelegram å–®å‰‡è¨Šæ¯ä¸Šé™ 4096 å­—å…ƒï¼‰\nconst MAX_LEN = 4000;\nif (text.length <= MAX_LEN) {\n  return [{ json: { digest: text, parseMode: 'HTML' } }];\n}\n\nconst sections = text.split('\\n\\n');\nconst messages = [];\nlet current = '';\nfor (const section of sections) {\n  if ((current + '\\n\\n' + section).length > MAX_LEN && current.length > 0) {\n    messages.push(current.trim());\n    current = section;\n  } else {\n    current = current ? current + '\\n\\n' + section : section;\n  }\n}\nif (current.trim()) messages.push(current.trim());\n\nreturn messages.map((msg) => ({ json: { digest: msg, parseMode: 'HTML' } }));"
      },
      "id": "code-format-001",
      "name": "Format Digest",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 400]
    },
    {
      "parameters": {
        "chatId": "925855884",
        "text": "={{ $json.digest }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "tg-send-digest",
      "name": "Send Daily Digest",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1140, 400],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "925855884",
        "text": "={{ 'âš ï¸ Alfred Daily Digest åŸ·è¡Œå‡ºéŒ¯\\n\\néŒ¯èª¤ç¯€é»ï¼š' + $json.execution?.error?.node || 'æœªçŸ¥' + '\\néŒ¯èª¤è¨Šæ¯ï¼š' + $json.execution?.error?.message || 'æœªçŸ¥éŒ¯èª¤' + '\\n\\nè«‹åˆ° n8n æª¢æŸ¥ workflow åŸ·è¡Œç´€éŒ„ã€‚' }}",
        "additionalFields": {}
      },
      "id": "tg-send-error",
      "name": "Send Error Notification",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1140, 600],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    }
  ],
  "connections": {
    "Every Day 8AM": {
      "main": [[{ "node": "Fetch All Sources via Apify", "type": "main", "index": 0 }]]
    },
    "Every Day 8PM": {
      "main": [[{ "node": "Fetch All Sources via Apify", "type": "main", "index": 0 }]]
    },
    "Fetch All Sources via Apify": {
      "main": [[{ "node": "Claude Curate Digest", "type": "main", "index": 0 }]]
    },
    "Claude Curate Digest": {
      "main": [[{ "node": "Format Digest", "type": "main", "index": 0 }]]
    },
    "Format Digest": {
      "main": [[{ "node": "Send Daily Digest", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "timezone": "Asia/Taipei"
  },
  "staticData": null,
  "tags": [{ "name": "telegram" }, { "name": "daily-digest" }, { "name": "ai" }, { "name": "apify" }, { "name": "youtube" }, { "name": "twitter" }, { "name": "instagram" }, { "name": "alfred" }],
  "triggerCount": 2,
  "pinData": {}
}
