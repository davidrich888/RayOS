{
  "name": "Ray AI ç®¡å®¶ â€” é»å­æ”¶é›† v3.0",
  "nodes": [
    {
      "parameters": {
        "updates": ["message", "callback_query"],
        "additionalFields": {}
      },
      "id": "tg-trigger-001",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [0, 300],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [{ "leftValue": "={{ $json.callback_query }}", "rightValue": "", "operator": { "type": "string", "operation": "exists" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "callback"
            },
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [{ "leftValue": "={{ $json.message }}", "rightValue": "", "operator": { "type": "string", "operation": "exists" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "message"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-event-type",
      "name": "Route Event Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [220, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": false, "leftValue": "" },
          "conditions": [
            { "id": "f1", "leftValue": "={{ $json.message.text.length }}", "rightValue": 2, "operator": { "type": "number", "operation": "gt" } },
            { "id": "f2", "leftValue": "={{ $json.message.text }}", "rightValue": "/", "operator": { "type": "string", "operation": "notStartsWith" } }
          ],
          "combinator": "and"
        }
      },
      "id": "filter-001",
      "name": "Filter Short & Commands",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [440, 400]
    },
    {
      "parameters": {
        "jsCode": "// å»ºç«‹ Claude è¨Šæ¯ï¼ˆå«å°è©±æ­·å²ï¼‰\nconst chatId = $json.message.chat.id;\nconst messageText = $json.message.text;\nconst staticData = $getWorkflowStaticData('global');\n\n// æ¸…é™¤è¶…é 24 å°æ™‚çš„èˆŠå°è©±\nconst now = Date.now();\nconst ONE_DAY = 24 * 60 * 60 * 1000;\nfor (const key of Object.keys(staticData)) {\n  if (key.startsWith('idea_')) {\n    const entry = staticData[key];\n    if (entry && entry.timestamp && (now - entry.timestamp) > ONE_DAY) {\n      const suffix = key.replace('idea_', '');\n      delete staticData[key];\n      delete staticData[`history_${suffix}`];\n    }\n  }\n}\n\nconst existingHistory = staticData[`history_${chatId}`] || [];\nconst messages = [...existingHistory, { role: 'user', content: messageText }];\nconst isContinuation = existingHistory.length > 0;\n\nreturn [{\n  json: {\n    chatId,\n    messageText,\n    messages,\n    isContinuation,\n    originalData: $json\n  }\n}];"
      },
      "id": "code-build-messages",
      "name": "Build Claude Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-api-key", "value": "={{ $credentials.httpHeaderAuth.value }}" },
            { "name": "anthropic-version", "value": "2023-06-01" },
            { "name": "content-type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'claude-haiku-4-5-20251001', max_tokens: 1500, system: $('Build Claude Messages').first().json.systemPrompt || 'ä½ æ˜¯ Ray çš„ AI ç®¡å®¶ Alfredã€‚ä½ æ—¢æ˜¯ Ray çš„é»å­åˆ†æå¸«ï¼Œä¹Ÿæ˜¯ä»–çš„æ—¥å¸¸ AI åŠ©æ‰‹ã€‚\\n\\næ”¶åˆ°è¨Šæ¯å¾Œï¼Œè«‹å…ˆåˆ¤æ–·é€™æ˜¯å“ªä¸€ç¨®ï¼š\\n\\nğŸ“º YouTube è¿½è¹¤çš„ç‰¹å¾µï¼š\\n- åŒ…å« youtube.comã€youtu.be é€£çµæˆ– YouTube é »é“ handleï¼ˆ@xxxï¼‰\\n- æåˆ°ã€Œè¿½è¹¤ã€ã€Œè¨‚é–±ã€ã€ŒåŠ å…¥ã€+ é »é“å\\n- ã€Œè¿½è¹¤é—œéµå­—ï¼šxxxã€æˆ–ã€Œæœå°‹é—œéµå­—ï¼šxxxã€çš„æ ¼å¼\\n- æ˜ç¢ºè¦æ±‚ç›£æ§æŸå€‹ YouTube å…§å®¹ä¾†æº\\n\\nğŸ’¡ é»å­/æƒ³æ³•çš„ç‰¹å¾µï¼š\\n- æå‡ºæ–°çš„å•†æ¥­è¨ˆç•«ã€ç”¢å“ ideaã€å…§å®¹æ–¹å‘ã€å°ˆæ¡ˆæ§‹æƒ³\\n- å¥å‹å¸¸è¦‹ï¼šã€Œæˆ‘æƒ³è¦åš...ã€ã€Œå¦‚æœåšä¸€å€‹...ã€ã€Œæœ‰ä¸€å€‹ ideaã€ã€Œæˆ‘åœ¨æƒ³...æ˜¯ä¸æ˜¯å¯ä»¥...ã€\\n- æè¿°å…·é«”çš„è¡Œå‹•è¨ˆç•«æˆ–ç›®æ¨™\\n- é—œæ–¼æ–°çš„æŠ•è³‡ç­–ç•¥ã€äº¤æ˜“æ–¹æ³•\\n\\nğŸ’¬ ä¸€èˆ¬å°è©±çš„ç‰¹å¾µï¼š\\n- å•ä½ å•é¡Œï¼ˆã€Œä½ æ˜¯èª°ã€ã€Œçµ¦æˆ‘ç¶²å€ã€ã€Œæ€éº¼ç”¨ã€ï¼‰\\n- é–’èŠã€æ‰“æ‹›å‘¼ï¼ˆã€Œä½ å¥½ã€ã€Œæ—©å®‰ã€ï¼‰\\n- å°ä¹‹å‰å›è¦†çš„è¿½å•æˆ–åæ‡‰ï¼ˆä½†ä¸æ˜¯æ–°é»å­ï¼‰\\n- è«‹æ±‚å¹«å¿™åšæŸä»¶äº‹ï¼ˆã€Œå¹«æˆ‘æŸ¥...ã€ã€Œç¿»è­¯...ã€ï¼‰\\n\\nâ–  è‹¥æ˜¯ ğŸ“º YouTube è¿½è¹¤ï¼š\\n1. åˆ¤æ–·æ˜¯ã€Œé »é“è¿½è¹¤ã€é‚„æ˜¯ã€Œé—œéµå­—æœå°‹ã€\\n2. ç”¨ç¹é«”ä¸­æ–‡å›è¦†ç¢ºèªè¨Šæ¯ï¼ˆ1-2å¥ï¼‰\\n3. çµå°¾åŠ  ---JSON---ï¼š\\n\\n---JSON---\\n{\"title\": \"é »é“åæˆ–é—œéµå­—\", \"type\": \"ğŸ“º YouTubeé »é“\" æˆ– \"ğŸ” æœå°‹é—œéµå­—\", \"channel_url\": \"https://...\", \"channel_id\": \"\"}\\n\\næ³¨æ„ï¼š\\n- channel_url åªæœ‰é »é“æ‰éœ€è¦å¡«ï¼Œé—œéµå­—ç•™ç©ºå­—ä¸²\\n- channel_id ç•™ç©ºå­—ä¸²ï¼Œç³»çµ±æœƒè‡ªå‹•è§£æ\\n- å¦‚æœç”¨æˆ¶çµ¦çš„æ˜¯ @handle æ ¼å¼ï¼Œchannel_url å¡« https://www.youtube.com/@handle\\n\\nâ–  è‹¥æ˜¯ ğŸ’¡ é»å­/æƒ³æ³•ï¼š\\n1. ç”¨ç¹é«”ä¸­æ–‡å‹å–„åœ°åˆ†æé€™å€‹æƒ³æ³•ï¼ˆ3-5å¥ï¼‰\\n2. çµå°¾åŠ  ---JSON---ï¼š\\n\\n---JSON---\\n{\"title\": \"æƒ³æ³•æ‘˜è¦ï¼ˆ30å­—å…§ï¼‰\", \"type\": \"é¸ä¸€å€‹ï¼šğŸ’° è³£éŒ¢é»å­ / ğŸ“¹ å½±ç‰‡é»å­ / ğŸ› ï¸ å·¥å…·/è‡ªå‹•åŒ– / ğŸ“ å…§å®¹é»å­ / ğŸŒŸ äººç”Ÿç›®æ¨™ / ğŸ¤” å…¶ä»–\", \"priority\": \"é¸ä¸€å€‹ï¼šğŸ”¥ é«˜ / â­ ä¸­ / ğŸ“Œ ä½\", \"notes\": \"åŸå§‹è¨Šæ¯ + åˆ†æé‡é»\"}\\n\\nâ–  è‹¥æ˜¯ ğŸ’¬ ä¸€èˆ¬å°è©±ï¼š\\n- ç›´æ¥ç”¨ç¹é«”ä¸­æ–‡å‹å–„å›è¦†\\n- çµ•å°ä¸è¦åŠ  ---JSON---\\n\\nâ–  è‹¥æ˜¯å»¶çºŒä¹‹å‰çš„å°è©±ä¸”ä¹‹å‰åœ¨è¨è«–é»å­ï¼š\\n- ç¹¼çºŒæ·±å…¥è¨è«–ï¼Œä¸¦åœ¨æœ€å¾Œæ›´æ–° ---JSON--- åˆ†é¡\\n\\né‡è¦è¦å‰‡ï¼š\\n- åªæœ‰çœŸæ­£çš„æ–°é»å­æˆ– YouTube è¿½è¹¤è«‹æ±‚æ‰åŠ  ---JSON---ï¼Œä¸€èˆ¬èŠå¤©çµ•å°ä¸åŠ \\n- å›è¦†ä¸­ä¸è¦ä½¿ç”¨ Markdown ç‰¹æ®Šå­—å…ƒï¼ˆ* _ ` [ ]ï¼‰ï¼Œç”¨ç´”æ–‡å­—å³å¯\\n- å¦‚æœéœ€è¦å¼·èª¿ï¼Œç”¨å…¨å½¢æ‹¬è™Ÿã€ã€‘æˆ– emoji æ¨™æ³¨', messages: $json.messages }) }}",
        "options": {
          "response": { "response": { "responseFormat": "json" } }
        }
      },
      "id": "claude-001",
      "name": "Claude Analyze",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 400],
      "credentials": {
        "httpHeaderAuth": {
          "id": "ANTHROPIC_CREDENTIAL_ID",
          "name": "Anthropic API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// è§£æ Claude å›è¦†ï¼šåˆ¤æ–·æ˜¯é»å­ã€YouTube è¿½è¹¤ã€é‚„æ˜¯ä¸€èˆ¬èŠå¤©\nconst content = $input.first().json;\nlet text = '';\nif (content.content && content.content[0] && content.content[0].text) {\n  text = content.content[0].text;\n}\n\nconst chatId = $('Build Claude Messages').first().json.chatId;\nconst messageText = $('Build Claude Messages').first().json.messageText;\nconst messages = $('Build Claude Messages').first().json.messages;\n\nconst separator = '---JSON---';\nconst sepIdx = text.indexOf(separator);\nconst hasJson = sepIdx !== -1;\n\nconst staticData = $getWorkflowStaticData('global');\n\nif (!hasJson) {\n  // ä¸€èˆ¬èŠå¤©æ¨¡å¼\n  staticData[`history_${chatId}`] = [...messages, { role: 'assistant', content: text }];\n  return [{ json: { chatId, analysis: text, isIdea: false, isYouTube: false } }];\n}\n\n// æœ‰ JSON â€” è§£æå®ƒ\nlet analysis = text.substring(0, sepIdx).trim();\nlet jsonData = null;\nlet jsonStr = text.substring(sepIdx + separator.length).trim();\njsonStr = jsonStr.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\ntry {\n  jsonData = JSON.parse(jsonStr);\n} catch (e) {\n  jsonData = { title: messageText.substring(0, 30), type: 'ğŸ¤” å…¶ä»–', priority: 'â­ ä¸­', notes: messageText };\n}\n\n// åˆ¤æ–·æ˜¯å¦ç‚º YouTube è¿½è¹¤\nconst isYouTube = jsonData.type === 'ğŸ“º YouTubeé »é“' || jsonData.type === 'ğŸ” æœå°‹é—œéµå­—';\n\nif (isYouTube) {\n  staticData[`history_${chatId}`] = [...messages, { role: 'assistant', content: analysis }];\n  return [{ json: {\n    chatId,\n    analysis,\n    isIdea: true,\n    isYouTube: true,\n    title: jsonData.title || '',\n    type: jsonData.type || 'ğŸ“º YouTubeé »é“',\n    channelUrl: jsonData.channel_url || '',\n    channelId: jsonData.channel_id || ''\n  } }];\n}\n\n// ä¸€èˆ¬é»å­\nstaticData[`idea_${chatId}`] = {\n  analysis,\n  data: jsonData,\n  originalMessage: messageText,\n  timestamp: Date.now(),\n  date: new Date().toISOString().split('T')[0]\n};\nstaticData[`history_${chatId}`] = [...messages, { role: 'assistant', content: analysis }];\n\nreturn [{ json: {\n  chatId,\n  analysis,\n  isIdea: true,\n  isYouTube: false,\n  title: jsonData.title,\n  type: jsonData.type,\n  priority: jsonData.priority\n} }];"
      },
      "id": "code-parse-state",
      "name": "Parse + Store State",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 400]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [
                  { "leftValue": "={{ $json.isIdea }}", "rightValue": true, "operator": { "type": "boolean", "operation": "true" } },
                  { "leftValue": "={{ $json.isYouTube }}", "rightValue": true, "operator": { "type": "boolean", "operation": "true" } }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "youtube"
            },
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [
                  { "leftValue": "={{ $json.isIdea }}", "rightValue": true, "operator": { "type": "boolean", "operation": "true" } },
                  { "leftValue": "={{ $json.isYouTube }}", "rightValue": false, "operator": { "type": "boolean", "operation": "false" } }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "idea"
            },
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [{ "leftValue": "={{ $json.isIdea }}", "rightValue": false, "operator": { "type": "boolean", "operation": "false" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "chat"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-idea-chat",
      "name": "Route Idea vs Chat",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [1320, 400]
    },
    {
      "parameters": {
        "jsCode": "// å¾ YouTube URL è§£æ Channel ID\nconst chatId = $json.chatId;\nconst title = $json.title;\nconst type = $json.type;\nlet channelUrl = $json.channelUrl || '';\nlet channelId = $json.channelId || '';\nconst analysis = $json.analysis;\n\n// å¦‚æœæœ‰ URL ä½†æ²’æœ‰ Channel IDï¼Œå˜—è©¦å¾ YouTube é é¢è§£æ\nif (channelUrl && !channelId) {\n  try {\n    const html = await this.helpers.httpRequest({\n      method: 'GET',\n      url: channelUrl,\n      returnFullResponse: false,\n      encoding: 'utf-8',\n      timeout: 10000\n    });\n    const patterns = [\n      /\"channelId\":\"(UC[a-zA-Z0-9_-]{22})\"/,\n      /\"externalId\":\"(UC[a-zA-Z0-9_-]{22})\"/,\n      /channel\\/(UC[a-zA-Z0-9_-]{22})/,\n      /\"browseId\":\"(UC[a-zA-Z0-9_-]{22})\"/\n    ];\n    for (const pattern of patterns) {\n      const match = String(html).match(pattern);\n      if (match) {\n        channelId = match[1];\n        break;\n      }\n    }\n  } catch (e) {\n    // è§£æå¤±æ•—ï¼Œæœƒå­˜å…¥ä½†æ²’æœ‰ channel ID\n  }\n}\n\nreturn [{ json: { chatId, title, type, channelUrl, channelId, analysis } }];"
      },
      "id": "code-resolve-channel",
      "name": "Resolve Channel ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1540, 250]
    },
    {
      "parameters": {
        "jsCode": "// å­˜å…¥ YouTube è¿½è¹¤ DBï¼ˆé€é Notion API + n8n credentialï¼‰\nconst credentials = await this.helpers.getCredentials('notionApi');\nconst NOTION_TOKEN = credentials.apiKey;\nconst DB_ID = 'b57a9c1760784b93b003f221262ff635';\n\nconst title = $json.title || '';\nconst type = $json.type || 'ğŸ” æœå°‹é—œéµå­—';\nconst channelId = $json.channelId || '';\nconst channelUrl = $json.channelUrl || '';\nconst today = new Date().toISOString().split('T')[0];\n\nconst properties = {\n  'Name': { title: [{ text: { content: title } }] },\n  'é¡å‹': { select: { name: type === 'ğŸ“º YouTubeé »é“' ? 'ğŸ“º é »é“' : 'ğŸ” é—œéµå­—' } },\n  'ç‹€æ…‹': { select: { name: 'âœ… å•Ÿç”¨' } },\n  'å»ºç«‹æ—¥æœŸ': { date: { start: today } }\n};\n\nif (channelId) {\n  properties['Channel ID'] = { rich_text: [{ text: { content: channelId } }] };\n}\nif (channelUrl) {\n  properties['URL'] = { url: channelUrl };\n}\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://api.notion.com/v1/pages',\n    headers: {\n      'Authorization': 'Bearer ' + NOTION_TOKEN,\n      'Notion-Version': '2022-06-28',\n      'Content-Type': 'application/json'\n    },\n    body: {\n      parent: { database_id: DB_ID },\n      properties: properties\n    },\n    json: true\n  });\n  if (response.object === 'error') {\n    return [{ json: { chatId: $json.chatId, title, type, channelUrl, channelId, analysis: $json.analysis, notionError: response.message } }];\n  }\n} catch (e) {\n  return [{ json: { chatId: $json.chatId, title, type, channelUrl, channelId, analysis: $json.analysis, notionError: e.message } }];\n}\n\nreturn [{ json: $json }];"
      },
      "id": "notion-yt-001",
      "name": "Save to YouTube DB",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 250],
      "credentials": {
        "notionApi": {
          "id": "NOTION_CREDENTIAL_ID",
          "name": "Alfred Notion"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Resolve Channel ID').first().json.chatId }}",
        "text": "={{ 'âœ… å·²åŠ å…¥è¿½è¹¤ï¼\\n\\n' + ($('Resolve Channel ID').first().json.type === 'ğŸ“º YouTubeé »é“' ? 'ğŸ“º é »é“ï¼š' : 'ğŸ” é—œéµå­—ï¼š') + $('Resolve Channel ID').first().json.title + ($('Resolve Channel ID').first().json.channelId ? '\\nğŸ†” Channel ID: ' + $('Resolve Channel ID').first().json.channelId : '\\nâš ï¸ Channel ID æœªè§£ææˆåŠŸï¼Œè«‹åˆ° Notion æ‰‹å‹•è£œä¸Š') + '\\n\\nä¸‹æ¬¡ Daily Digest å°±æœƒåŒ…å«é€™å€‹ä¾†æºäº† ğŸ“¬' }}",
        "additionalFields": {}
      },
      "id": "tg-send-yt-confirm",
      "name": "Send YT Confirm",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1980, 250],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// å»ºç«‹ Telegram å›è¦†ï¼ˆé»å­æ¨¡å¼ â€” å« inline keyboard æŒ‰éˆ•ï¼‰\nconst chatId = $json.chatId;\nconst analysis = $json.analysis;\nconst title = $json.title;\nconst type = $json.type;\nconst priority = $json.priority;\n\n// ä¸ä½¿ç”¨ Markdown ç‰¹æ®Šå­—å…ƒï¼Œæ”¹ç”¨ç´”æ–‡å­— + emoji\nconst messageText = `ğŸ§  Alfred åˆ†æ\\n\\n${analysis}\\n\\nğŸ“‹ åˆ†é¡é è¦½ï¼š\\nğŸ“Œ ${title}\\nğŸ·ï¸ ${type} / ${priority}\\n\\nè¦å­˜å…¥ Notion å—ï¼Ÿ`;\n\nconst replyMarkup = JSON.stringify({\n  inline_keyboard: [\n    [\n      { text: 'âœ… å­˜å…¥', callback_data: 'save_idea' },\n      { text: 'âŒ ä¸å­˜å…¥', callback_data: 'skip_idea' }\n    ],\n    [\n      { text: 'ğŸ’¬ ç¹¼çºŒè¨è«–', callback_data: 'discuss_more' }\n    ]\n  ]\n});\n\nreturn [{ json: { chatId, messageText, replyMarkup } }];"
      },
      "id": "code-build-reply",
      "name": "Build Reply Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1540, 450]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.messageText }}",
        "additionalFields": {
          "replyMarkup": "={{ $json.replyMarkup }}"
        }
      },
      "id": "tg-send-analysis",
      "name": "Send Analysis + Buttons",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1760, 450],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.analysis }}",
        "additionalFields": {}
      },
      "id": "tg-send-chat-reply",
      "name": "Send Chat Reply",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1540, 550],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æå– callback è³‡æ–™ä¸¦å›æ‡‰ callback queryï¼ˆç”¨ this.helpers.httpRequest å–ä»£ fetchï¼‰\nconst cq = $json.callback_query;\nconst chatId = cq.message.chat.id;\nconst callbackId = cq.id;\nconst callbackData = cq.data;\nconst messageId = cq.message.message_id;\n\n// å–å¾— Telegram credential\nconst credentials = await this.helpers.getCredentials('telegramApi');\nconst botToken = credentials.accessToken;\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://api.telegram.org/bot${botToken}/answerCallbackQuery`,\n    headers: { 'Content-Type': 'application/json' },\n    body: { callback_query_id: callbackId },\n    json: true\n  });\n} catch (e) {\n  // answerCallbackQuery å¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹\n}\n\nreturn [{ json: { chatId, callbackId, callbackData, messageId } }];"
      },
      "id": "code-extract-callback",
      "name": "Extract + Answer Callback",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 200],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [{ "leftValue": "={{ $json.callbackData }}", "rightValue": "save_idea", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "save"
            },
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [{ "leftValue": "={{ $json.callbackData }}", "rightValue": "skip_idea", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "skip"
            },
            {
              "conditions": {
                "options": { "caseSensitive": true, "leftValue": "" },
                "conditions": [{ "leftValue": "={{ $json.callbackData }}", "rightValue": "discuss_more", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "discuss"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-callback",
      "name": "Route Callback",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [700, 200]
    },
    {
      "parameters": {
        "jsCode": "// SAVEï¼šå¾ staticData å–å›æš«å­˜çš„é»å­\nconst chatId = $json.chatId;\nconst messageId = $json.messageId;\nconst staticData = $getWorkflowStaticData('global');\nconst stored = staticData[`idea_${chatId}`];\n\n// éŒ¯èª¤è™•ç†ï¼šæ‰¾ä¸åˆ°æš«å­˜çš„é»å­\nif (!stored) {\n  return [{ json: {\n    chatId,\n    messageId,\n    error: true,\n    errorMsg: 'âš ï¸ æ‰¾ä¸åˆ°å¾…å­˜çš„æƒ³æ³•ï¼Œå¯èƒ½å·²éæœŸã€‚è«‹é‡æ–°å‚³é€ã€‚'\n  } }];\n}\n\nconst result = {\n  chatId,\n  messageId,\n  title: stored.data.title || 'æœªåˆ†é¡æƒ³æ³•',\n  type: stored.data.type || 'ğŸ¤” å…¶ä»–',\n  priority: stored.data.priority || 'â­ ä¸­',\n  notes: stored.data.notes || stored.originalMessage,\n  date: stored.date,\n  analysis: stored.analysis,\n  error: false\n};\n\ndelete staticData[`idea_${chatId}`];\ndelete staticData[`history_${chatId}`];\n\nreturn [{ json: result }];"
      },
      "id": "code-retrieve-state",
      "name": "Retrieve State",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [940, 100]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "" },
          "conditions": [
            { "id": "err-check", "leftValue": "={{ $json.error }}", "rightValue": true, "operator": { "type": "boolean", "operation": "false" } }
          ],
          "combinator": "and"
        }
      },
      "id": "if-error-check",
      "name": "Has Valid Idea?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1120, 100]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": { "__rl": true, "value": "ed035c908cc04b7b999ef0c023557add", "mode": "id" },
        "title": "={{ $json.title }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "é¡å‹|select", "selectValue": "={{ $json.type }}" },
            { "key": "ç‹€æ…‹|select", "selectValue": "ğŸ’¡ æ–°æƒ³æ³•" },
            { "key": "å„ªå…ˆåº¦|select", "selectValue": "={{ $json.priority }}" },
            { "key": "å»ºç«‹æ—¥æœŸ|date", "dateValue": "={{ $json.date }}" }
          ]
        },
        "blockUi": {
          "blockValues": [
            { "type": "paragraph", "textContent": "={{ $json.notes }}" },
            { "type": "paragraph", "textContent": "={{ '\\n--- Alfred åˆ†æ ---\\n' + $json.analysis }}" }
          ]
        }
      },
      "id": "notion-create-001",
      "name": "Save to Notion Ideas",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [1300, 100],
      "credentials": {
        "notionApi": {
          "id": "NOTION_CREDENTIAL_ID",
          "name": "Alfred Notion"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = $('Retrieve State').first().json.chatId;\nconst messageId = $('Retrieve State').first().json.messageId;\nconst title = $('Retrieve State').first().json.title;\nconst type = $('Retrieve State').first().json.type;\nconst priority = $('Retrieve State').first().json.priority;\n\nreturn [{ json: {\n  chatId,\n  messageId,\n  confirmText: `âœ… å·²å­˜å…¥ Notionï¼\\n\\nğŸ“Œ ${title}\\nğŸ·ï¸ ${type} / ${priority}`\n} }];"
      },
      "id": "code-confirm-save",
      "name": "Build Save Confirmation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 100]
    },
    {
      "parameters": {
        "jsCode": "// ç§»é™¤ inline keyboard æŒ‰éˆ•\nconst credentials = await this.helpers.getCredentials('telegramApi');\nconst botToken = credentials.accessToken;\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://api.telegram.org/bot${botToken}/editMessageReplyMarkup`,\n    headers: { 'Content-Type': 'application/json' },\n    body: {\n      chat_id: $json.chatId,\n      message_id: $json.messageId,\n      reply_markup: JSON.stringify({ inline_keyboard: [] })\n    },\n    json: true\n  });\n} catch (e) {\n  // æŒ‰éˆ•ç§»é™¤å¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹\n}\n\nreturn [{ json: $json }];"
      },
      "id": "tg-remove-buttons-save",
      "name": "Remove Buttons (Save)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 100],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.confirmText }}",
        "additionalFields": {}
      },
      "id": "tg-send-confirm",
      "name": "Send Save Confirm",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1900, 100],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// SKIPï¼šæ¸…é™¤æš«å­˜ç‹€æ…‹\nconst chatId = $json.chatId;\nconst messageId = $json.messageId;\nconst staticData = $getWorkflowStaticData('global');\ndelete staticData[`idea_${chatId}`];\ndelete staticData[`history_${chatId}`];\n\nreturn [{ json: { chatId, messageId, text: 'å¥½çš„ï¼Œä¸å­˜å…¥ ğŸ‘Œ' } }];"
      },
      "id": "code-skip",
      "name": "Clear State (Skip)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [940, -50]
    },
    {
      "parameters": {
        "jsCode": "// ç§»é™¤ inline keyboard æŒ‰éˆ•\nconst credentials = await this.helpers.getCredentials('telegramApi');\nconst botToken = credentials.accessToken;\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://api.telegram.org/bot${botToken}/editMessageReplyMarkup`,\n    headers: { 'Content-Type': 'application/json' },\n    body: {\n      chat_id: $json.chatId,\n      message_id: $json.messageId,\n      reply_markup: JSON.stringify({ inline_keyboard: [] })\n    },\n    json: true\n  });\n} catch (e) {}\n\nreturn [{ json: $json }];"
      },
      "id": "tg-remove-buttons-skip",
      "name": "Remove Buttons (Skip)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1160, -50],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.text }}",
        "additionalFields": {}
      },
      "id": "tg-send-skip",
      "name": "Send Skip Reply",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1380, -50],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const chatId = $json.chatId;\nconst messageId = $json.messageId;\n\nreturn [{ json: {\n  chatId,\n  messageId,\n  text: 'æ²’å•é¡Œï¼ç¹¼çºŒè·Ÿæˆ‘èŠé€™å€‹æƒ³æ³•å§ ğŸ’¬\\n\\nä½ å¯ä»¥è£œå……æ›´å¤šç´°ç¯€ã€æå•ã€æˆ–å‘Šè¨´æˆ‘ä½ çš„ç–‘æ…®ã€‚\\nèŠå®Œä¹‹å¾Œæˆ‘æœƒå†å•ä½ è¦ä¸è¦å­˜å…¥ Notionã€‚'\n} }];"
      },
      "id": "code-discuss",
      "name": "Build Discuss Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [940, 200]
    },
    {
      "parameters": {
        "jsCode": "// ç§»é™¤ inline keyboard æŒ‰éˆ•\nconst credentials = await this.helpers.getCredentials('telegramApi');\nconst botToken = credentials.accessToken;\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://api.telegram.org/bot${botToken}/editMessageReplyMarkup`,\n    headers: { 'Content-Type': 'application/json' },\n    body: {\n      chat_id: $json.chatId,\n      message_id: $json.messageId,\n      reply_markup: JSON.stringify({ inline_keyboard: [] })\n    },\n    json: true\n  });\n} catch (e) {}\n\nreturn [{ json: $json }];"
      },
      "id": "tg-remove-buttons-discuss",
      "name": "Remove Buttons (Discuss)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1160, 200],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.text }}",
        "additionalFields": {}
      },
      "id": "tg-send-discuss",
      "name": "Send Discuss Reply",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1380, 200],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Retrieve State').first().json.chatId }}",
        "text": "={{ $('Retrieve State').first().json.errorMsg }}",
        "additionalFields": {}
      },
      "id": "tg-send-error",
      "name": "Send Error Reply",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1300, -100],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ç§»é™¤éŒ¯èª¤è¨Šæ¯å°æ‡‰çš„æŒ‰éˆ•\nconst credentials = await this.helpers.getCredentials('telegramApi');\nconst botToken = credentials.accessToken;\nconst chatId = $('Retrieve State').first().json.chatId;\nconst messageId = $('Retrieve State').first().json.messageId;\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://api.telegram.org/bot${botToken}/editMessageReplyMarkup`,\n    headers: { 'Content-Type': 'application/json' },\n    body: {\n      chat_id: chatId,\n      message_id: messageId,\n      reply_markup: JSON.stringify({ inline_keyboard: [] })\n    },\n    json: true\n  });\n} catch (e) {}\n\nreturn [{ json: { chatId, messageId } }];"
      },
      "id": "tg-remove-buttons-error",
      "name": "Remove Buttons (Error)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, -100],
      "credentials": {
        "telegramApi": {
          "id": "TELEGRAM_CREDENTIAL_ID",
          "name": "Alfred Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [[{ "node": "Route Event Type", "type": "main", "index": 0 }]]
    },
    "Route Event Type": {
      "main": [
        [{ "node": "Extract + Answer Callback", "type": "main", "index": 0 }],
        [{ "node": "Filter Short & Commands", "type": "main", "index": 0 }]
      ]
    },
    "Filter Short & Commands": {
      "main": [[{ "node": "Build Claude Messages", "type": "main", "index": 0 }]]
    },
    "Build Claude Messages": {
      "main": [[{ "node": "Claude Analyze", "type": "main", "index": 0 }]]
    },
    "Claude Analyze": {
      "main": [[{ "node": "Parse + Store State", "type": "main", "index": 0 }]]
    },
    "Parse + Store State": {
      "main": [[{ "node": "Route Idea vs Chat", "type": "main", "index": 0 }]]
    },
    "Route Idea vs Chat": {
      "main": [
        [{ "node": "Resolve Channel ID", "type": "main", "index": 0 }],
        [{ "node": "Build Reply Payload", "type": "main", "index": 0 }],
        [{ "node": "Send Chat Reply", "type": "main", "index": 0 }]
      ]
    },
    "Resolve Channel ID": {
      "main": [[{ "node": "Save to YouTube DB", "type": "main", "index": 0 }]]
    },
    "Save to YouTube DB": {
      "main": [[{ "node": "Send YT Confirm", "type": "main", "index": 0 }]]
    },
    "Build Reply Payload": {
      "main": [[{ "node": "Send Analysis + Buttons", "type": "main", "index": 0 }]]
    },
    "Extract + Answer Callback": {
      "main": [[{ "node": "Route Callback", "type": "main", "index": 0 }]]
    },
    "Route Callback": {
      "main": [
        [{ "node": "Retrieve State", "type": "main", "index": 0 }],
        [{ "node": "Clear State (Skip)", "type": "main", "index": 0 }],
        [{ "node": "Build Discuss Reply", "type": "main", "index": 0 }]
      ]
    },
    "Retrieve State": {
      "main": [[{ "node": "Has Valid Idea?", "type": "main", "index": 0 }]]
    },
    "Has Valid Idea?": {
      "main": [
        [{ "node": "Save to Notion Ideas", "type": "main", "index": 0 }],
        [{ "node": "Remove Buttons (Error)", "type": "main", "index": 0 }]
      ]
    },
    "Remove Buttons (Error)": {
      "main": [[{ "node": "Send Error Reply", "type": "main", "index": 0 }]]
    },
    "Save to Notion Ideas": {
      "main": [[{ "node": "Build Save Confirmation", "type": "main", "index": 0 }]]
    },
    "Build Save Confirmation": {
      "main": [[{ "node": "Remove Buttons (Save)", "type": "main", "index": 0 }]]
    },
    "Remove Buttons (Save)": {
      "main": [[{ "node": "Send Save Confirm", "type": "main", "index": 0 }]]
    },
    "Clear State (Skip)": {
      "main": [[{ "node": "Remove Buttons (Skip)", "type": "main", "index": 0 }]]
    },
    "Remove Buttons (Skip)": {
      "main": [[{ "node": "Send Skip Reply", "type": "main", "index": 0 }]]
    },
    "Build Discuss Reply": {
      "main": [[{ "node": "Remove Buttons (Discuss)", "type": "main", "index": 0 }]]
    },
    "Remove Buttons (Discuss)": {
      "main": [[{ "node": "Send Discuss Reply", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [{ "name": "telegram" }, { "name": "notion" }, { "name": "ai" }, { "name": "youtube" }, { "name": "alfred" }],
  "triggerCount": 1,
  "pinData": {}
}
