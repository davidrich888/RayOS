<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“š Ray çš„å­¸ç¿’ç ”ç©¶åº«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', -apple-system, sans-serif; }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    const API_URL = "https://david86726.app.n8n.cloud/webhook/youtube-videos";
    const UPDATE_API_URL = "https://david86726.app.n8n.cloud/webhook/update-video";
    const DELETE_API_URL = "https://david86726.app.n8n.cloud/webhook/delete-video";

    const categories = ["å…¨éƒ¨", "äº¤æ˜“", "AI è‡ªå‹•åŒ–", "å•†æ¥­", "å¥èº«", "å…©æ€§", "äººç”Ÿ", "ç¾å­¸"];
    const statuses = ["å…¨éƒ¨", "å¾…çœ‹", "é€²è¡Œä¸­", "å·²å®Œæˆ"];

    // === Resource Library å¸¸æ•¸ ===
    const RESOURCE_WEBHOOK_URL = "https://david86726.app.n8n.cloud/webhook/resource-library"; // placeholderï¼Œç­‰ n8n å»ºå¥½å†ç¢ºèª
    const RESOURCE_CACHE_KEY = "rayos_resource_library";

    const resourceCategories = [
      { label: "å…¨éƒ¨", emoji: "" },
      { label: "Money/Business", emoji: "ğŸ’°" },
      { label: "AI/Tech", emoji: "ğŸ¤–" },
      { label: "Trading", emoji: "ğŸ“ˆ" },
      { label: "Content Creation", emoji: "ğŸ“¹" },
      { label: "Mindset", emoji: "ğŸ§ " },
      { label: "Tools", emoji: "ğŸ”§" },
      { label: "Learning", emoji: "ğŸ“š" },
    ];

    const sourceTypes = [
      { value: "X", label: "X / Twitter", icon: "ğŸ¦" },
      { value: "Instagram", label: "Instagram", icon: "ğŸ“¸" },
      { value: "Article", label: "Article", icon: "ğŸ“°" },
      { value: "YouTube", label: "YouTube", icon: "ğŸ¬" },
      { value: "Note", label: "Note", icon: "ğŸ“" },
      { value: "Other", label: "Other", icon: "ğŸ“Œ" },
    ];

    const getSourceIcon = (type) => {
      const found = sourceTypes.find(s => s.value === type);
      return found ? found.icon : "ğŸ“Œ";
    };

    // Mock è³‡æ–™ï¼ˆn8n webhook é‚„æ²’å»ºå¥½æ™‚ç”¨ä¾†æ¸¬è©¦ UIï¼‰
    const MOCK_RESOURCES = [
      {
        id: "mock-1",
        title: "Prop Firm é€šéç‡æå‡ç­–ç•¥",
        url: "https://x.com/example/status/123",
        content: "åˆ†äº«ä¸€å€‹æˆ‘ç”¨äº†ä¸‰å€‹æœˆçš„ Prop Firm ç­–ç•¥ï¼Œé€šéç‡å¾ 30% æå‡åˆ° 70%ã€‚é—œéµåœ¨æ–¼é¢¨æ§ç®¡ç†å’Œå€‰ä½è¨ˆç®—...",
        source_type: "X",
        summary: "ä½œè€…åˆ†äº« Prop Firm é€šéç‡å¾ 30% æå‡åˆ° 70% çš„ç¶“é©—ã€‚æ ¸å¿ƒç­–ç•¥åŒ…æ‹¬åš´æ ¼é¢¨æ§ç®¡ç†ã€ç²¾ç¢ºå€‰ä½è¨ˆç®—ï¼Œä»¥åŠé¿å…åœ¨é«˜æ³¢å‹•æ™‚æ®µäº¤æ˜“ã€‚",
        key_takeaway: "é¢¨æ§ > ç²åˆ©ï¼Œå…ˆæ´»ä¸‹ä¾†æ‰èƒ½è³ºéŒ¢",
        tags: ["ğŸ“ˆ Trading", "ğŸ’° Money/Business"],
        source: "manual",
        created_time: "2026-02-12T10:30:00Z",
      },
      {
        id: "mock-2",
        title: "Claude Code è‡ªå‹•åŒ–å·¥ä½œæµ",
        url: "https://example.com/article/claude-code",
        content: "å¦‚ä½•ç”¨ Claude Code + n8n æ‰“é€ å…¨è‡ªå‹•çš„å…§å®¹ç”Ÿç”¢æµç¨‹...",
        source_type: "Article",
        summary: "ä»‹ç´¹å¦‚ä½•çµåˆ Claude Code å’Œ n8n å»ºç«‹è‡ªå‹•åŒ–å…§å®¹æµç¨‹ã€‚å¾æ§‹æ€ã€æ’°ç¨¿ã€æ’ç‰ˆåˆ°ç™¼å¸ƒï¼Œå…¨ç¨‹å¯ä»¥ç”¨ AI è¼”åŠ©å®Œæˆã€‚",
        key_takeaway: "AI ä¸æ˜¯å–ä»£ä½ ï¼Œè€Œæ˜¯è®“ä½ ä¸€å€‹äººåšåå€‹äººçš„äº‹",
        tags: ["ğŸ¤– AI/Tech", "ğŸ”§ Tools"],
        source: "telegram",
        created_time: "2026-02-11T15:00:00Z",
      },
      {
        id: "mock-3",
        title: "YouTube ç¸®åœ– CTR å„ªåŒ–æŠ€å·§",
        url: "https://www.instagram.com/p/example123",
        content: "ä¸‰å€‹é¦¬ä¸Šèƒ½ç”¨çš„ç¸®åœ–è¨­è¨ˆæŠ€å·§ï¼š1. è‡‰éƒ¨è¡¨æƒ…è¦èª‡å¼µ 2. æ–‡å­—ä¸è¶…é4å€‹å­— 3. å°æ¯”è‰²æ­é…",
        source_type: "Instagram",
        summary: "åˆ†äº«ä¸‰å€‹å¯¦ç”¨çš„ YouTube ç¸®åœ–è¨­è¨ˆæŠ€å·§ï¼Œèƒ½æœ‰æ•ˆæå‡é»æ“Šç‡ã€‚é‡é»åœ¨æ–¼è‡‰éƒ¨è¡¨æƒ…ã€ç²¾ç°¡æ–‡å­—å’Œé¡è‰²å°æ¯”ã€‚",
        key_takeaway: "ç¸®åœ–æ˜¯å½±ç‰‡çš„å»£å‘Šï¼Œè¦åƒå»£å‘Šä¸€æ¨£è¨­è¨ˆ",
        tags: ["ğŸ“¹ Content Creation"],
        source: "manual",
        created_time: "2026-02-10T09:00:00Z",
      },
      {
        id: "mock-4",
        title: "äº¤æ˜“å¿ƒæ…‹ç­†è¨˜ï¼šè™§æå¾Œçš„å¾©ç›¤",
        url: "",
        content: "ä»Šå¤©é€£çºŒæ­¢æä¸‰æ¬¡ï¼Œæƒ…ç·’é–‹å§‹æ³¢å‹•ã€‚å†·éœä¸‹ä¾†å¾Œåæ€ï¼š1. é€²å ´æ¢ä»¶æ²’å•é¡Œ 2. æ­¢æä½ç½®åˆç† 3. å¸‚å ´æ¢ä»¶è®Šäº†ä½†æˆ‘æ²’èª¿æ•´ã€‚çµè«–ï¼šä¸æ˜¯ç­–ç•¥éŒ¯ï¼Œæ˜¯æ²’æœ‰è­˜åˆ¥å¸‚å ´ç‹€æ…‹çš„è®ŠåŒ–ã€‚",
        source_type: "Note",
        summary: "äº¤æ˜“è€…åœ¨é€£çºŒè™§æå¾Œçš„å¿ƒæ…‹è¦†ç›¤ã€‚åˆ†æç™¼ç¾ç­–ç•¥æœ¬èº«æ²’å•é¡Œï¼Œä½†å¿½ç•¥äº†å¸‚å ´ç‹€æ…‹çš„è®ŠåŒ–ã€‚æé†’è‡ªå·±è¦å…ˆåˆ¤æ–·å¸‚å ´ç’°å¢ƒå†æ±ºå®šæ˜¯å¦é€²å ´ã€‚",
        key_takeaway: "è™§æä¸å¯æ€•ï¼Œä¸çŸ¥é“ç‚ºä»€éº¼è™§ææ‰å¯æ€•",
        tags: ["ğŸ“ˆ Trading", "ğŸ§  Mindset"],
        source: "manual",
        created_time: "2026-02-09T20:00:00Z",
      },
      {
        id: "mock-5",
        title: "Hormozi çš„å…§å®¹é£›è¼ªç†è«–",
        url: "https://www.youtube.com/watch?v=example",
        content: "Alex Hormozi è§£é‡‹ç‚ºä»€éº¼ä»–æ¯å¤©ç™¼å¸ƒå…§å®¹ï¼šContent is the new cold calling. ä½ ç™¼çš„æ¯ä¸€ç¯‡å…§å®¹éƒ½æ˜¯ä¸€å€‹ 24/7 å·¥ä½œçš„æ¥­å‹™å“¡ã€‚",
        source_type: "YouTube",
        summary: "Hormozi åˆ†äº«ä»–çš„å…§å®¹é£›è¼ªç­–ç•¥ï¼šæŠŠå…§å®¹ç•¶æˆå…¨å¤©å€™çš„æ¥­å‹™å“¡ã€‚é‡å¤§ > å“è³ªï¼Œå…ˆè¿½æ±‚é‡ï¼Œå“è³ªæœƒè‡ªç„¶æå‡ã€‚",
        key_takeaway: "Content is the new cold calling â€” å…§å®¹å°±æ˜¯ä½ çš„æ¥­å‹™åœ˜éšŠ",
        tags: ["ğŸ“¹ Content Creation", "ğŸ’° Money/Business", "ğŸ§  Mindset"],
        source: "telegram",
        created_time: "2026-02-08T12:00:00Z",
      },
    ];

    // æ™‚é–“è½‰ç§’æ•¸
    function timeToSeconds(timeStr) {
      const parts = timeStr.split(':').map(Number);
      if (parts.length === 2) {
        return parts[0] * 60 + parts[1];
      } else if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
      }
      return 0;
    }

    // è§£æç²¾è¯ç‰‡æ®µ
    function parseHighlights(text) {
      if (!text) return [];
      const lines = text.split('\n').filter(line => line.trim());
      return lines.map(line => {
        const match = line.match(/^(\d+:\d+)(?:-(\d+:\d+))?\s*[-â€“]\s*(.+)$/);
        if (match) {
          return {
            startTime: match[1],
            endTime: match[2] || null,
            description: match[3].trim(),
            startSeconds: timeToSeconds(match[1])
          };
        }
        return null;
      }).filter(Boolean);
    }

    // æ˜Ÿæ˜Ÿè©•åˆ†çµ„ä»¶
    function StarRating({ rating, onRate, size = "text-lg" }) {
      const [hoverRating, setHoverRating] = useState(0);
      
      return (
        <div className="flex gap-0.5">
          {[1, 2, 3, 4, 5].map(star => (
            <button
              key={star}
              onClick={() => onRate(star)}
              onMouseEnter={() => setHoverRating(star)}
              onMouseLeave={() => setHoverRating(0)}
              className={`${size} transition-colors ${
                (hoverRating || rating) >= star ? 'text-yellow-400' : 'text-neutral-600'
              } hover:scale-110`}
            >
              â˜…
            </button>
          ))}
        </div>
      );
    }

    // ç‹€æ…‹é¸æ“‡çµ„ä»¶
    function StatusSelector({ currentStatus, onStatusChange }) {
      const statusOptions = ["å¾…çœ‹", "é€²è¡Œä¸­", "å·²å®Œæˆ"];
      
      return (
        <div className="flex gap-2">
          {statusOptions.map(status => (
            <button
              key={status}
              onClick={() => onStatusChange(status)}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                currentStatus === status
                  ? status === "å¾…çœ‹" ? "bg-neutral-700 text-white" :
                    status === "é€²è¡Œä¸­" ? "bg-amber-500/20 text-amber-400 border border-amber-500/30" :
                    "bg-emerald-500/20 text-emerald-400 border border-emerald-500/30"
                  : "bg-neutral-800 text-neutral-400 hover:bg-neutral-700"
              }`}
            >
              {status}
            </button>
          ))}
        </div>
      );
    }

    // åˆ†é¡å¤šé¸çµ„ä»¶
    function CategoryMultiSelector({ currentCategories, onCategoriesChange, availableCategories }) {
      const selected = currentCategories ? currentCategories.split(',').map(c => c.trim()).filter(Boolean) : [];

      const toggleCategory = (cat) => {
        let newSelected;
        if (selected.includes(cat)) {
          newSelected = selected.filter(c => c !== cat);
        } else {
          newSelected = [...selected, cat];
        }
        onCategoriesChange(newSelected.join(', '));
      };

      return (
        <div className="flex flex-wrap gap-2">
          {availableCategories.filter(c => c !== "å…¨éƒ¨").map(cat => (
            <button
              key={cat}
              onClick={() => toggleCategory(cat)}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                selected.includes(cat)
                  ? "bg-amber-500/20 text-amber-400 border border-amber-500/30"
                  : "bg-neutral-800 text-neutral-400 hover:bg-neutral-700"
              }`}
            >
              {cat}
            </button>
          ))}
        </div>
      );
    }

    // èªéŸ³è¼¸å…¥çµ„ä»¶
    function SpeechToText({ onTranscript, isListening, setIsListening }) {
      const recognitionRef = useRef(null);

      useEffect(() => {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognitionRef.current = new SpeechRecognition();
          recognitionRef.current.continuous = true;
          recognitionRef.current.interimResults = true;
          recognitionRef.current.lang = 'zh-TW';

          recognitionRef.current.onresult = (event) => {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              transcript += event.results[i][0].transcript;
            }
            onTranscript(transcript);
          };

          recognitionRef.current.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            setIsListening(false);
          };

          recognitionRef.current.onend = () => {
            setIsListening(false);
          };
        }
      }, []);

      const toggleListening = () => {
        if (isListening) {
          recognitionRef.current?.stop();
          setIsListening(false);
        } else {
          recognitionRef.current?.start();
          setIsListening(true);
        }
      };

      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        return null;
      }

      return (
        <button
          onClick={toggleListening}
          className={`p-2 rounded-lg transition-all ${
            isListening 
              ? 'bg-red-500 text-white animate-pulse' 
              : 'bg-neutral-700 text-neutral-400 hover:bg-neutral-600'
          }`}
          title={isListening ? 'åœæ­¢éŒ„éŸ³' : 'èªéŸ³è¼¸å…¥'}
        >
          ğŸ¤
        </button>
      );
    }

    // å½±ç‰‡å½ˆçª—çµ„ä»¶
    function VideoModal({ video, onClose, onUpdate, onDelete, getThumbnail }) {
      const [rating, setRating] = useState(video.rating || 0);
      const [status, setStatus] = useState(video.status || "å¾…çœ‹");
      const [selectedCategories, setSelectedCategories] = useState(video.category || "");
      const [notes, setNotes] = useState(video.notes || "");
      const [thumbnailSaved, setThumbnailSaved] = useState(video.thumbnailSaved || false);
      const [isListening, setIsListening] = useState(false);
      const [tempTranscript, setTempTranscript] = useState("");
      const [isUpdating, setIsUpdating] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [isDeleting, setIsDeleting] = useState(false);
      const [currentTime, setCurrentTime] = useState(0);
      const [isSavingNotes, setIsSavingNotes] = useState(false);
      const iframeRef = useRef(null);

      const getVideoId = (url) => {
        if (!url) return null;
        // youtube.com/watch?v=ID
        let match = url.match(/[?&]v=([^&]+)/);
        if (match) return match[1];
        // youtu.be/ID
        match = url.match(/youtu\.be\/([^?&/]+)/);
        if (match) return match[1];
        // youtube.com/embed/ID æˆ– youtube.com/shorts/ID
        match = url.match(/youtube\.com\/(?:embed|shorts)\/([^?&/]+)/);
        if (match) return match[1];
        return null;
      };

      const videoId = getVideoId(video.url);
      const highlights = parseHighlights(video.highlights);
      const [shouldAutoplay, setShouldAutoplay] = useState(false);

      const seekTo = (seconds) => {
        setCurrentTime(seconds);
        setShouldAutoplay(true);
      };

      const youtubeUrl = videoId 
        ? `https://www.youtube.com/embed/${videoId}${currentTime > 0 ? `?start=${currentTime}` : ''}${shouldAutoplay ? (currentTime > 0 ? '&' : '?') + 'autoplay=1' : ''}`
        : '';

      const handleRatingChange = async (newRating) => {
        setRating(newRating);
        setIsUpdating(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageId: video.id,
              rating: newRating,
              status: status
            })
          });
          onUpdate(video.id, { rating: newRating, status });
        } catch (err) {
          console.error('Error updating rating:', err);
        }
        setIsUpdating(false);
      };

      const handleStatusChange = async (newStatus) => {
        setStatus(newStatus);
        setIsUpdating(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageId: video.id,
              rating: rating,
              status: newStatus
            })
          });
          onUpdate(video.id, { rating, status: newStatus });
        } catch (err) {
          console.error('Error updating status:', err);
        }
        setIsUpdating(false);
      };

      const handleCategoriesChange = async (newCategories) => {
        setSelectedCategories(newCategories);
        setIsUpdating(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageId: video.id,
              categories: newCategories
            })
          });
          onUpdate(video.id, { category: newCategories });
        } catch (err) {
          console.error('Error updating categories:', err);
        }
        setIsUpdating(false);
      };

      const handleSaveNotes = async () => {
        setIsSavingNotes(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageId: video.id,
              notes: notes
            })
          });
          onUpdate(video.id, { notes });
        } catch (err) {
          console.error('Error saving notes:', err);
        }
        setIsSavingNotes(false);
      };

      const handleThumbnailSaveToggle = async () => {
        const newValue = !thumbnailSaved;
        setThumbnailSaved(newValue);
        setIsUpdating(true);
        try {
          await fetch(UPDATE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageId: video.id,
              thumbnailSaved: newValue
            })
          });
          onUpdate(video.id, { thumbnailSaved: newValue });
        } catch (err) {
          console.error('Error updating thumbnail saved:', err);
          setThumbnailSaved(!newValue);
        }
        setIsUpdating(false);
      };

      const handleDownloadThumbnail = async () => {
        const thumbnailUrl = getThumbnail(video);
        if (!thumbnailUrl) return;
        
        try {
          // ä½¿ç”¨é«˜ç•«è³ªç‰ˆæœ¬
          const videoId = getVideoId(video.url);
          const hqUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg` : thumbnailUrl;
          
          // é–‹æ–°åˆ†é ä¸‹è¼‰
          window.open(hqUrl, '_blank');
        } catch (err) {
          console.error('Error downloading thumbnail:', err);
        }
      };

      const handleDelete = async () => {
        setIsDeleting(true);
        try {
          await fetch(DELETE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageId: video.id
            })
          });
          onDelete(video.id);
          onClose();
        } catch (err) {
          console.error('Error deleting video:', err);
          alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
        setIsDeleting(false);
      };

      useEffect(() => {
        const handleEsc = (e) => {
          if (e.key === 'Escape') onClose();
        };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
      }, [onClose]);

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" />
          <div 
            className="relative bg-neutral-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto border border-neutral-700"
            onClick={e => e.stopPropagation()}
          >
            {/* é—œé–‰æŒ‰éˆ• */}
            <button 
              onClick={onClose}
              className="absolute top-4 right-4 z-10 w-8 h-8 flex items-center justify-center rounded-full bg-neutral-800 text-neutral-400 hover:bg-neutral-700 hover:text-white transition-colors"
            >
              âœ•
            </button>

            {/* é ­éƒ¨è³‡è¨Š */}
            <div className="p-6 pb-0">
              <div className="flex gap-2 text-xs text-neutral-500 mb-2">
                <span>{video.category || 'æœªåˆ†é¡'}</span>
                <span>â€¢</span>
                <span>{video.channel}</span>
              </div>
              <h2 className="text-lg font-semibold text-white pr-8 leading-snug">
                {video.title}
              </h2>
            </div>

            {/* å½±ç‰‡æ’­æ”¾å™¨ */}
            <div className="p-6 pb-4">
              {videoId ? (
                <div className="aspect-video bg-black rounded-xl overflow-hidden">
                  <iframe
                    ref={iframeRef}
                    key={currentTime}
                    src={youtubeUrl}
                    className="w-full h-full"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowFullScreen
                  />
                </div>
              ) : (
                <div className="aspect-video bg-neutral-800 rounded-xl flex items-center justify-center">
                  <span className="text-neutral-500">ç„¡æ³•è¼‰å…¥å½±ç‰‡</span>
                </div>
              )}
              
              {/* ç¸®åœ–æ“ä½œæŒ‰éˆ• */}
              <div className="flex gap-2 mt-3">
                <button
                  onClick={handleThumbnailSaveToggle}
                  className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                    thumbnailSaved 
                      ? 'bg-pink-500/20 text-pink-400 border border-pink-500/30' 
                      : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'
                  }`}
                >
                  {thumbnailSaved ? 'â¤ï¸ å·²æ”¶è—ç¸®åœ–' : 'ğŸ¤ æ”¶è—ç¸®åœ–'}
                </button>
                <button
                  onClick={handleDownloadThumbnail}
                  className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-neutral-800 text-neutral-400 hover:bg-neutral-700 transition-all"
                >
                  â¬‡ï¸ ä¸‹è¼‰ç¸®åœ–
                </button>
              </div>
            </div>

            {/* ç²¾è¯ç‰‡æ®µ */}
            {highlights.length > 0 && (
              <div className="px-6 pb-4">
                <div className="bg-gradient-to-br from-amber-900/40 to-amber-800/20 rounded-xl p-4 border border-amber-600/30">
                  <div className="text-sm font-medium text-amber-400 mb-3">â­ ç²¾è¯ç‰‡æ®µï¼ˆé»æ“Šè·³è½‰ï¼‰</div>
                  <div className="space-y-2">
                    {highlights.map((h, i) => (
                      <button
                        key={i}
                        onClick={() => seekTo(h.startSeconds)}
                        className="w-full flex items-start gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors text-left group"
                      >
                        <span className="text-amber-300 font-mono text-sm whitespace-nowrap bg-amber-500/30 px-2 py-1 rounded border border-amber-500/40 group-hover:bg-amber-500/40 transition-colors">
                          {h.startTime}{h.endTime ? `-${h.endTime}` : ''}
                        </span>
                        <span className="text-neutral-300 text-sm pt-1">{h.description}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* è©•åˆ†èˆ‡ç‹€æ…‹ */}
            <div className="px-6 pb-4 flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
              <div>
                <div className="text-xs text-neutral-500 mb-1">æˆ‘çš„è©•åˆ†</div>
                <StarRating rating={rating} onRate={handleRatingChange} size="text-xl" />
              </div>
              <div>
                <div className="text-xs text-neutral-500 mb-1">è§€çœ‹ç‹€æ…‹</div>
                <StatusSelector currentStatus={status} onStatusChange={handleStatusChange} />
              </div>
            </div>

            {/* åˆ†é¡ï¼ˆå¯è¤‡é¸ï¼‰ */}
            <div className="px-6 pb-4">
              <div className="text-xs text-neutral-500 mb-2">åˆ†é¡ï¼ˆå¯è¤‡é¸ï¼‰</div>
              <CategoryMultiSelector 
                currentCategories={selectedCategories}
                onCategoriesChange={handleCategoriesChange}
                availableCategories={categories}
              />
            </div>

            {/* AI æ‘˜è¦ */}
            {video.summary && (
              <div className="px-6 pb-4">
                <div className="bg-neutral-800/50 rounded-xl p-4 border border-neutral-700">
                  <div className="text-sm font-medium text-neutral-300 mb-3">ğŸ¤– AI æ‘˜è¦</div>
                  <div className="text-sm text-neutral-300 whitespace-pre-line leading-relaxed">
                    {video.summary}
                  </div>
                  {video.keyTakeaway && (
                    <div className="mt-4 pt-4 border-t border-neutral-700">
                      <div className="text-sm text-amber-400">
                        ğŸ’¡ {video.keyTakeaway}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* æˆ‘çš„ç­†è¨˜ */}
            <div className="px-6 pb-4">
              <div className="bg-neutral-800/50 rounded-xl p-4 border border-neutral-700">
                <div className="flex items-center justify-between mb-3">
                  <div className="text-sm font-medium text-neutral-300">ğŸ“ æˆ‘çš„ç­†è¨˜</div>
                  <div className="flex gap-2">
                    <SpeechToText 
                      onTranscript={(t) => setTempTranscript(t)}
                      isListening={isListening}
                      setIsListening={setIsListening}
                    />
                    <button
                      onClick={handleSaveNotes}
                      disabled={isSavingNotes}
                      className="px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-500 text-black hover:bg-amber-400 transition-colors disabled:opacity-50"
                    >
                      {isSavingNotes ? 'å„²å­˜ä¸­...' : 'å„²å­˜ç­†è¨˜'}
                    </button>
                  </div>
                </div>
                <textarea
                  value={isListening ? notes + tempTranscript : notes}
                  onChange={(e) => setNotes(e.target.value)}
                  onBlur={() => {
                    if (tempTranscript) {
                      setNotes(notes + tempTranscript);
                      setTempTranscript("");
                    }
                  }}
                  placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„ç­†è¨˜..."
                  className="w-full h-24 bg-neutral-900 border border-neutral-700 rounded-lg p-3 text-sm text-neutral-300 placeholder-neutral-600 outline-none focus:border-neutral-500 resize-none"
                />
              </div>
            </div>

            {/* åº•éƒ¨æŒ‰éˆ• */}
            <div className="p-6 pt-2 flex gap-3">
              <a
                href={video.url}
                target="_blank"
                rel="noopener noreferrer"
                className="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white font-medium text-sm text-center transition-colors flex items-center justify-center gap-2"
              >
                <span>â–¶</span> åœ¨ YouTube è§€çœ‹
              </a>
              <button
                onClick={() => setShowDeleteConfirm(true)}
                className="px-4 py-3 rounded-xl bg-neutral-800 hover:bg-red-900 text-neutral-400 hover:text-red-400 font-medium text-sm transition-colors"
                title="åˆªé™¤å½±ç‰‡"
              >
                ğŸ—‘ï¸
              </button>
              <button
                onClick={onClose}
                className="px-6 py-3 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-neutral-300 font-medium text-sm transition-colors"
              >
                é—œé–‰
              </button>
            </div>

            {/* åˆªé™¤ç¢ºèªå°è©±æ¡† */}
            {showDeleteConfirm && (
              <div className="absolute inset-0 bg-black/80 flex items-center justify-center rounded-2xl">
                <div className="bg-neutral-800 rounded-xl p-6 mx-4 max-w-sm border border-neutral-700">
                  <div className="text-center mb-4">
                    <div className="text-3xl mb-2">ğŸ—‘ï¸</div>
                    <h3 className="text-white font-semibold mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
                    <p className="text-neutral-400 text-sm">é€™æœƒåŒæ™‚å¾ Notion è³‡æ–™åº«ä¸­ç§»é™¤æ­¤å½±ç‰‡</p>
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={() => setShowDeleteConfirm(false)}
                      className="flex-1 py-2 rounded-lg bg-neutral-700 text-white text-sm font-medium hover:bg-neutral-600 transition-colors"
                    >
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={handleDelete}
                      disabled={isDeleting}
                      className="flex-1 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-500 transition-colors disabled:opacity-50"
                    >
                      {isDeleting ? 'åˆªé™¤ä¸­...' : 'ç¢ºå®šåˆªé™¤'}
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* æ›´æ–°ä¸­æŒ‡ç¤ºå™¨ */}
            {isUpdating && (
              <div className="absolute top-4 left-4 bg-neutral-800 px-3 py-1 rounded-full text-xs text-neutral-400">
                å„²å­˜ä¸­...
              </div>
            )}
          </div>
        </div>
      );
    }

    // å½±ç‰‡å¡ç‰‡çµ„ä»¶
    function VideoCard({ video, getThumbnail, onOpenModal }) {
      // å–å¾—å„ªå…ˆåº¦æ¨™ç±¤æ¨£å¼
      const getPriorityStyle = () => {
        if (video.priority?.includes('å¿…çœ‹')) {
          return { bg: 'bg-red-500/90', text: 'ğŸ”¥ å¿…çœ‹' };
        } else if (video.priority?.includes('é‡è¦')) {
          return { bg: 'bg-amber-500/90', text: 'â­ é‡è¦' };
        }
        return null;
      };

      const priorityStyle = getPriorityStyle();

      return (
        <div className="bg-neutral-900 rounded-xl overflow-hidden border border-neutral-800 hover:border-neutral-700 transition-all group">
          {/* Thumbnail */}
          <div 
            className="relative aspect-video bg-neutral-800 overflow-hidden cursor-pointer"
            onClick={() => onOpenModal(video)}
          >
            {getThumbnail(video) && (
              <img 
                src={getThumbnail(video)} 
                alt={video.title}
                className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                loading="lazy"
                referrerPolicy="no-referrer"
                onError={(e) => { e.target.style.display = 'none'; }}
              />
            )}
            <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent pointer-events-none" />
            
            {/* å·¦ä¸Šè§’ï¼šè©•åˆ†æ˜Ÿæ˜Ÿ */}
            {video.rating > 0 && (
              <div className="absolute top-2 left-2 bg-black/80 px-2 py-1 rounded text-xs font-medium text-yellow-400 flex items-center gap-0.5">
                {'â˜…'.repeat(video.rating)}
              </div>
            )}
            
            {/* å³ä¸Šè§’ï¼šå„ªå…ˆåº¦æ¨™ç±¤ */}
            {priorityStyle && (
              <div className={`absolute top-2 right-2 ${priorityStyle.bg} px-2 py-1 rounded text-xs font-medium text-white`}>
                {priorityStyle.text}
              </div>
            )}
            
            {/* å³ä¸Šè§’ï¼šæ”¶è—ç¸®åœ–æ¨™è¨˜ï¼ˆå¦‚æœæ²’æœ‰å„ªå…ˆåº¦æ‰é¡¯ç¤ºåœ¨å³ä¸Šï¼‰ */}
            {video.thumbnailSaved && !priorityStyle && (
              <div className="absolute top-2 right-2 bg-pink-500/90 px-2 py-1 rounded text-xs font-medium text-white">
                â¤ï¸ å·²æ”¶è—
              </div>
            )}
            
            {/* æ”¶è—ç¸®åœ–æ¨™è¨˜ï¼ˆå¦‚æœæœ‰å„ªå…ˆåº¦å‰‡é¡¯ç¤ºåœ¨å³ä¸‹ï¼‰ */}
            {video.thumbnailSaved && priorityStyle && (
              <div className="absolute bottom-2 left-2 bg-pink-500/90 px-2 py-1 rounded text-xs font-medium text-white">
                â¤ï¸
              </div>
            )}
            
            {/* å³ä¸‹è§’ï¼šå½±ç‰‡é•·åº¦ */}
            {video.duration && (
              <div className="absolute bottom-2 right-2 bg-black/80 px-1.5 py-0.5 rounded text-xs font-medium">
                {video.duration}
              </div>
            )}
            
            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
              <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                <span className="text-white text-lg ml-1">â–¶</span>
              </div>
            </div>
          </div>

          {/* Content */}
          <div className="p-4">
            <div className="flex gap-2 mb-2 text-xs">
              <span className="text-neutral-500">{video.category || 'æœªåˆ†é¡'}</span>
              <span className="text-neutral-700">â€¢</span>
              <span className={
                video.status === "å¾…çœ‹" ? "text-neutral-500" :
                video.status === "é€²è¡Œä¸­" ? "text-amber-500" :
                "text-emerald-500"
              }>{video.status}</span>
            </div>

            <h3 className="font-medium text-white mb-1.5 line-clamp-2 leading-snug text-sm">
              {video.title}
            </h3>
            <p className="text-xs text-neutral-500 mb-3">{video.channel}</p>

            {/* Summary Preview */}
            {video.summary ? (
              <div className="bg-neutral-800/50 rounded-lg p-3 border border-neutral-800">
                <div className="text-xs text-neutral-400 mb-1">AI æ‘˜è¦</div>
                <div className="text-xs text-neutral-300 line-clamp-3">
                  {video.summary.split('\n')[0]}
                </div>
              </div>
            ) : (
              <div className="bg-neutral-800/30 rounded-lg p-3 border border-dashed border-neutral-800 text-center">
                <p className="text-xs text-neutral-600">å°šæœªæ•´ç†æ‘˜è¦</p>
              </div>
            )}

            {/* Actions */}
            <div className="flex gap-2 mt-3">
              <button 
                onClick={() => onOpenModal(video)}
                className="flex-1 py-2 rounded-lg border border-neutral-800 text-neutral-400 text-xs font-medium hover:bg-neutral-800 hover:text-white transition-colors text-center"
              >
                ğŸ“– æŸ¥çœ‹è©³æƒ…
              </button>
              <a 
                href={video.url}
                target="_blank"
                rel="noopener noreferrer"
                className="py-2 px-3 rounded-lg border border-neutral-800 text-neutral-400 text-xs font-medium hover:bg-neutral-800 hover:text-white transition-colors"
              >
                â–¶ï¸
              </a>
            </div>
          </div>
        </div>
      );
    }

    // === Resource Library çµ„ä»¶ ===

    // è³‡æºå¡ç‰‡çµ„ä»¶
    function ResourceCard({ resource, onDelete }) {
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [isDeleting, setIsDeleting] = useState(false);

      const handleDelete = async () => {
        setIsDeleting(true);
        try {
          await fetch(RESOURCE_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: "delete_resource", pageId: resource.id })
          });
          onDelete(resource.id);
        } catch (err) {
          console.error('åˆªé™¤è³‡æºå¤±æ•—:', err);
          // å³ä½¿ webhook å¤±æ•—ï¼Œmock æ¨¡å¼ä¸‹ä¹Ÿç§»é™¤ï¼ˆæ–¹ä¾¿æ¸¬è©¦ï¼‰
          onDelete(resource.id);
        }
        setIsDeleting(false);
        setShowDeleteConfirm(false);
      };

      const formattedDate = resource.created_time
        ? new Date(resource.created_time).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })
        : '';

      return (
        <div className="bg-neutral-900 rounded-xl border border-neutral-800 hover:border-neutral-700 transition-all p-5 flex flex-col gap-3 relative">
          {/* é ‚éƒ¨ï¼šä¾†æº icon + é¡å‹ + æ—¥æœŸ + åˆªé™¤ */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span className="text-lg">{getSourceIcon(resource.source_type)}</span>
              <span className="text-xs text-neutral-500">{resource.source_type}</span>
              {resource.source === "telegram" && (
                <span className="text-xs bg-blue-500/20 text-blue-400 px-1.5 py-0.5 rounded">TG</span>
              )}
            </div>
            <div className="flex items-center gap-2">
              <span className="text-xs text-neutral-600">{formattedDate}</span>
              <button
                onClick={() => setShowDeleteConfirm(true)}
                className="text-neutral-600 hover:text-red-400 transition-colors text-sm p-1"
                title="åˆªé™¤"
              >
                ğŸ—‘ï¸
              </button>
            </div>
          </div>

          {/* æ¨™é¡Œ */}
          <h3 className="font-medium text-white text-sm leading-snug">{resource.title}</h3>

          {/* AI æ‘˜è¦ */}
          <p className="text-sm text-neutral-400 leading-relaxed line-clamp-3">{resource.summary}</p>

          {/* Key Takeaway */}
          {resource.key_takeaway && (
            <div className="bg-amber-500/10 border border-amber-500/20 rounded-lg px-3 py-2">
              <p className="text-sm text-amber-300">ğŸ’¡ {resource.key_takeaway}</p>
            </div>
          )}

          {/* æ¨™ç±¤ */}
          <div className="flex flex-wrap gap-1.5">
            {(resource.tags || []).map(tag => (
              <span key={tag} className="text-xs bg-neutral-800 text-neutral-400 px-2 py-1 rounded-md">
                {tag}
              </span>
            ))}
          </div>

          {/* åŸå§‹é€£çµ */}
          {resource.url && (
            <a
              href={resource.url}
              target="_blank"
              rel="noopener noreferrer"
              className="text-xs text-neutral-500 hover:text-neutral-300 truncate transition-colors mt-auto"
            >
              ğŸ”— {resource.url}
            </a>
          )}

          {/* åˆªé™¤ç¢ºèª */}
          {showDeleteConfirm && (
            <div className="absolute inset-0 bg-neutral-900/95 rounded-xl flex items-center justify-center p-4">
              <div className="text-center">
                <p className="text-sm text-neutral-300 mb-3">ç¢ºå®šè¦åˆªé™¤é€™å€‹è³‡æºï¼Ÿ</p>
                <div className="flex gap-2 justify-center">
                  <button
                    onClick={() => setShowDeleteConfirm(false)}
                    className="px-3 py-1.5 rounded-lg bg-neutral-700 text-white text-xs hover:bg-neutral-600 transition-colors"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    onClick={handleDelete}
                    disabled={isDeleting}
                    className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-xs hover:bg-red-500 transition-colors disabled:opacity-50"
                  >
                    {isDeleting ? 'åˆªé™¤ä¸­...' : 'ç¢ºå®šåˆªé™¤'}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // QuickCapture è¡¨å–®çµ„ä»¶
    function QuickCapture({ onAdd }) {
      const [isOpen, setIsOpen] = useState(false);
      const [url, setUrl] = useState("");
      const [content, setContent] = useState("");
      const [sourceType, setSourceType] = useState("X");
      const [isSubmitting, setIsSubmitting] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!content.trim()) return;

        setIsSubmitting(true);
        const payload = {
          type: "add_resource",
          data: {
            url: url.trim(),
            content: content.trim(),
            source_type: sourceType,
            source: "manual",
          }
        };

        try {
          console.log("ğŸ“¤ é€å‡º Resource payload:", JSON.stringify(payload, null, 2));
          const res = await fetch(RESOURCE_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          onAdd(data);
          // æ¸…ç©ºè¡¨å–®
          setUrl("");
          setContent("");
          setSourceType("X");
          setIsOpen(false);
        } catch (err) {
          console.error('æ–°å¢è³‡æºå¤±æ•—:', err);
          // webhook é‚„æ²’å»ºå¥½æ™‚ï¼Œç”¨ mock å›å‚³æ¸¬è©¦
          const mockResponse = {
            id: "mock-" + Date.now(),
            title: content.trim().substring(0, 30) + "...",
            url: url.trim(),
            content: content.trim(),
            source_type: sourceType,
            summary: "ï¼ˆAI æ‘˜è¦å¾…ç”¢ç”Ÿ â€” n8n webhook å°šæœªé€£æ¥ï¼‰",
            key_takeaway: "ï¼ˆå¾… AI è™•ç†ï¼‰",
            tags: [],
            source: "manual",
            created_time: new Date().toISOString(),
          };
          console.log("âš ï¸ Webhook æœªé€£æ¥ï¼Œä½¿ç”¨ mock è³‡æ–™:", mockResponse);
          onAdd(mockResponse);
          setUrl("");
          setContent("");
          setSourceType("X");
          setIsOpen(false);
        }
        setIsSubmitting(false);
      };

      return (
        <div className="mb-6">
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-neutral-300 text-sm font-medium transition-colors w-full sm:w-auto"
          >
            {isOpen ? "âœ• æ”¶åˆ" : "â• å¿«é€Ÿæ”¶é›†"}
          </button>

          {isOpen && (
            <form onSubmit={handleSubmit} className="mt-3 bg-neutral-900 border border-neutral-800 rounded-xl p-4 space-y-3">
              {/* ä¾†æºé¡å‹ */}
              <div className="flex gap-2 flex-wrap">
                {sourceTypes.map(st => (
                  <button
                    key={st.value}
                    type="button"
                    onClick={() => setSourceType(st.value)}
                    className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                      sourceType === st.value
                        ? "bg-white text-black"
                        : "bg-neutral-800 text-neutral-400 hover:bg-neutral-700"
                    }`}
                  >
                    {st.icon} {st.label}
                  </button>
                ))}
              </div>

              {/* URL */}
              <input
                type="url"
                placeholder="URLï¼ˆå¯é¸ï¼‰"
                value={url}
                onChange={e => setUrl(e.target.value)}
                className="w-full px-4 py-2.5 rounded-lg border border-neutral-800 bg-neutral-950 text-neutral-200 text-sm outline-none focus:border-neutral-600 transition-colors placeholder-neutral-600"
              />

              {/* å…§å®¹ */}
              <textarea
                placeholder="è²¼ä¸Šå…§å®¹æˆ–å¯«ä¸‹ç­†è¨˜...ï¼ˆå¿…å¡«ï¼‰"
                value={content}
                onChange={e => setContent(e.target.value)}
                required
                rows={4}
                className="w-full px-4 py-3 rounded-lg border border-neutral-800 bg-neutral-950 text-neutral-200 text-sm outline-none focus:border-neutral-600 transition-colors placeholder-neutral-600 resize-none"
              />

              {/* é€å‡º */}
              <button
                type="submit"
                disabled={!content.trim() || isSubmitting}
                className="px-6 py-2.5 rounded-xl bg-white text-black font-medium text-sm hover:bg-neutral-200 transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
              >
                {isSubmitting ? "è™•ç†ä¸­..." : "é€å‡ºçµ¦ AI åˆ†é¡"}
              </button>
            </form>
          )}
        </div>
      );
    }

    // ResourceLibrary ä¸»å®¹å™¨çµ„ä»¶
    function ResourceLibrary() {
      const [resources, setResources] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchQuery, setSearchQuery] = useState("");
      const [selectedCategory, setSelectedCategory] = useState("å…¨éƒ¨");
      const [selectedSource, setSelectedSource] = useState("å…¨éƒ¨");

      // åˆå§‹åŒ–ï¼šå¾ localStorage è®€å–å¿«å–ï¼ŒåŒæ™‚å¾ webhook æ‹‰å–æœ€æ–°
      useEffect(() => {
        // å…ˆå¾å¿«å–è¼‰å…¥
        const cached = localStorage.getItem(RESOURCE_CACHE_KEY);
        if (cached) {
          try {
            setResources(JSON.parse(cached));
          } catch (e) {
            console.error("å¿«å–è§£æå¤±æ•—:", e);
          }
        }

        // å¾ webhook æ‹‰å–æœ€æ–°è³‡æ–™
        const fetchResources = async () => {
          try {
            const res = await fetch(RESOURCE_WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: "fetch_resources" })
            });
            const data = await res.json();
            if (Array.isArray(data)) {
              setResources(data);
              localStorage.setItem(RESOURCE_CACHE_KEY, JSON.stringify(data));
            }
          } catch (err) {
            console.log("âš ï¸ Webhook æœªé€£æ¥ï¼Œä½¿ç”¨ mock/å¿«å–è³‡æ–™");
            // å¦‚æœæ²’æœ‰å¿«å–ä¹Ÿæ²’æœ‰ webhookï¼Œè¼‰å…¥ mock è³‡æ–™
            if (!cached) {
              setResources(MOCK_RESOURCES);
              localStorage.setItem(RESOURCE_CACHE_KEY, JSON.stringify(MOCK_RESOURCES));
            }
          }
          setLoading(false);
        };

        fetchResources();
      }, []);

      // æ–°å¢è³‡æº
      const handleAdd = (newResource) => {
        setResources(prev => {
          const updated = [newResource, ...prev];
          localStorage.setItem(RESOURCE_CACHE_KEY, JSON.stringify(updated));
          return updated;
        });
      };

      // åˆªé™¤è³‡æº
      const handleDelete = (resourceId) => {
        setResources(prev => {
          const updated = prev.filter(r => r.id !== resourceId);
          localStorage.setItem(RESOURCE_CACHE_KEY, JSON.stringify(updated));
          return updated;
        });
      };

      // ç¯©é¸é‚è¼¯
      const filteredResources = useMemo(() => {
        return resources.filter(r => {
          const matchCategory = selectedCategory === "å…¨éƒ¨" ||
            (r.tags || []).some(tag => tag.includes(selectedCategory));
          const matchSource = selectedSource === "å…¨éƒ¨" || r.source_type === selectedSource;
          const query = searchQuery.toLowerCase();
          const matchSearch = !query ||
            (r.title || "").toLowerCase().includes(query) ||
            (r.summary || "").toLowerCase().includes(query) ||
            (r.content || "").toLowerCase().includes(query) ||
            (r.key_takeaway || "").toLowerCase().includes(query);
          return matchCategory && matchSource && matchSearch;
        });
      }, [resources, selectedCategory, selectedSource, searchQuery]);

      return (
        <main className="max-w-6xl mx-auto px-4 py-4">
          {/* QuickCapture */}
          <QuickCapture onAdd={handleAdd} />

          {/* ç¯©é¸åˆ— */}
          <div className="flex flex-col gap-3 mb-6">
            {/* æœå°‹ + ä¾†æºç¯©é¸ */}
            <div className="flex flex-col sm:flex-row gap-3">
              <input
                type="text"
                placeholder="æœå°‹æ‘˜è¦ã€å…§å®¹..."
                value={searchQuery}
                onChange={e => setSearchQuery(e.target.value)}
                className="w-full sm:w-56 px-4 py-2 rounded-lg border border-neutral-800 bg-neutral-900 text-neutral-200 text-sm outline-none focus:border-neutral-600 transition-colors placeholder-neutral-600"
              />

              <div className="flex gap-1 overflow-x-auto pb-2 sm:pb-0">
                <button
                  onClick={() => setSelectedSource("å…¨éƒ¨")}
                  className={`px-3 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${
                    selectedSource === "å…¨éƒ¨"
                      ? "bg-white text-black font-medium"
                      : "text-neutral-400 hover:text-white"
                  }`}
                >
                  å…¨éƒ¨ä¾†æº
                </button>
                {sourceTypes.map(st => (
                  <button
                    key={st.value}
                    onClick={() => setSelectedSource(st.value)}
                    className={`px-3 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${
                      selectedSource === st.value
                        ? "bg-white text-black font-medium"
                        : "text-neutral-400 hover:text-white"
                    }`}
                  >
                    {st.icon} {st.label}
                  </button>
                ))}
              </div>
            </div>

            {/* åˆ†é¡æ¨™ç±¤ç¯©é¸ */}
            <div className="flex flex-wrap gap-1 items-center">
              {resourceCategories.map(cat => (
                <button
                  key={cat.label}
                  onClick={() => setSelectedCategory(cat.label)}
                  className={`px-3 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${
                    selectedCategory === cat.label
                      ? "bg-neutral-800 text-white font-medium"
                      : "text-neutral-400 hover:text-white"
                  }`}
                >
                  {cat.emoji} {cat.label}
                </button>
              ))}

              <div className="hidden sm:block h-4 w-px bg-neutral-800 mx-1"></div>
              <span className="text-sm text-neutral-500">
                å…± <span className="text-white font-medium">{filteredResources.length}</span> ç­†
              </span>

              {(selectedCategory !== "å…¨éƒ¨" || selectedSource !== "å…¨éƒ¨" || searchQuery) && (
                <button
                  onClick={() => { setSelectedCategory("å…¨éƒ¨"); setSelectedSource("å…¨éƒ¨"); setSearchQuery(""); }}
                  className="px-3 py-1.5 rounded-md text-sm text-red-400 hover:bg-red-500/10 transition-colors"
                >
                  âœ• æ¸…é™¤ç¯©é¸
                </button>
              )}
            </div>
          </div>

          {/* è³‡æºå¡ç‰‡ Grid */}
          {loading ? (
            <div className="text-center py-16">
              <div className="animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
              <p className="text-neutral-500">è¼‰å…¥è³‡æºä¸­...</p>
            </div>
          ) : filteredResources.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {filteredResources.map(resource => (
                <ResourceCard key={resource.id} resource={resource} onDelete={handleDelete} />
              ))}
            </div>
          ) : (
            <div className="text-center py-16">
              <p className="text-neutral-500 mb-2">
                {resources.length === 0 ? "é‚„æ²’æœ‰æ”¶é›†ä»»ä½•è³‡æº" : "æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æº"}
              </p>
              <p className="text-neutral-600 text-sm">
                {resources.length === 0 ? "é»ã€Œå¿«é€Ÿæ”¶é›†ã€é–‹å§‹æ–°å¢" : "è©¦è©¦èª¿æ•´ç¯©é¸æ¢ä»¶"}
              </p>
            </div>
          )}
        </main>
      );
    }

    function App() {
      const [videos, setVideos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [selectedCategory, setSelectedCategory] = useState("å…¨éƒ¨");
      const [selectedStatus, setSelectedStatus] = useState("å¾…çœ‹");
      const [searchQuery, setSearchQuery] = useState("");
      const [selectedVideo, setSelectedVideo] = useState(null);
      const [showSavedThumbnailsOnly, setShowSavedThumbnailsOnly] = useState(false);
      const [selectedRatings, setSelectedRatings] = useState([]);
      const [activeTab, setActiveTab] = useState("youtube");

      useEffect(() => {
        fetch(API_URL)
          .then(res => res.json())
          .then(data => {
            const formattedVideos = data.map((item, index) => {
              const props = item.properties;
              // è™•ç†åˆ†é¡ï¼ˆæ”¯æ´ multi_select å’Œ selectï¼‰
              let category = '';
              if (props['åˆ†é¡']?.multi_select) {
                category = props['åˆ†é¡'].multi_select.map(c => c.name).join(', ');
              } else if (props['åˆ†é¡']?.select?.name) {
                category = props['åˆ†é¡'].select.name;
              }
              
              return {
                id: item.id || index,
                title: props['å½±ç‰‡æ¨™é¡Œ']?.title?.[0]?.plain_text || 'ç„¡æ¨™é¡Œ',
                channel: props['é »é“']?.rich_text?.[0]?.plain_text || '',
                duration: props['å½±ç‰‡é•·åº¦']?.rich_text?.[0]?.plain_text || '',
                category: category,
                status: props['ç‹€æ…‹']?.select?.name || 'å¾…çœ‹',
                priority: props['å„ªå…ˆåº¦']?.select?.name || '',
                thumbnail: props['ç¸®åœ–ç¶²å€']?.url || '',
                url: props['ç¶²å€']?.url || '',
                summary: props['AI æ‘˜è¦']?.rich_text?.[0]?.plain_text || '',
                keyTakeaway: props['ä¸€å¥è©±å­¸åˆ°']?.rich_text?.[0]?.plain_text || '',
                highlights: props['ç²¾è¯ç‰‡æ®µ']?.rich_text?.[0]?.plain_text || '',
                rating: props['æˆ‘çš„è©•åˆ†']?.number || 0,
                notes: props['æˆ‘çš„ç­†è¨˜']?.rich_text?.[0]?.plain_text || '',
                thumbnailSaved: props['æ”¶è—ç¸®åœ–']?.checkbox || false,
                createdTime: item.created_time || '',
              };
            });
            
            formattedVideos.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));
            
            setVideos(formattedVideos);
            setLoading(false);
          })
          .catch(err => {
            console.error('Error fetching data:', err);
            setError('ç„¡æ³•è¼‰å…¥è³‡æ–™');
            setLoading(false);
          });
      }, []);

      const handleVideoUpdate = (videoId, updates) => {
        setVideos(prev => prev.map(v => 
          v.id === videoId ? { ...v, ...updates } : v
        ));
      };

      const handleVideoDelete = (videoId) => {
        setVideos(prev => prev.filter(v => v.id !== videoId));
      };

      const filteredVideos = useMemo(() => {
        return videos.filter(video => {
          const matchCategory = selectedCategory === "å…¨éƒ¨" || 
            (video.category && video.category.includes(selectedCategory));
          const matchStatus = selectedStatus === "å…¨éƒ¨" || video.status === selectedStatus;
          const matchSearch = video.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                             video.channel.toLowerCase().includes(searchQuery.toLowerCase());
          const matchThumbnailSaved = !showSavedThumbnailsOnly || video.thumbnailSaved;
          const matchRating = selectedRatings.length === 0 || selectedRatings.includes(video.rating);
          return matchCategory && matchStatus && matchSearch && matchThumbnailSaved && matchRating;
        });
      }, [videos, selectedCategory, selectedStatus, searchQuery, showSavedThumbnailsOnly, selectedRatings]);

      const stats = useMemo(() => {
        return {
          total: videos.length,
          pending: videos.filter(v => v.status === "å¾…çœ‹").length,
          inProgress: videos.filter(v => v.status === "é€²è¡Œä¸­").length,
          completed: videos.filter(v => v.status === "å·²å®Œæˆ").length,
          summarized: videos.filter(v => v.summary).length,
          thumbnailSaved: videos.filter(v => v.thumbnailSaved).length,
        };
      }, [videos]);

      const getThumbnail = (video) => {
        if (video.thumbnail) return video.thumbnail;
        if (video.url) {
          let match = video.url.match(/[?&]v=([^&]+)/);
          if (!match) match = video.url.match(/youtu\.be\/([^?&/]+)/);
          if (!match) match = video.url.match(/youtube\.com\/(?:embed|shorts)\/([^?&/]+)/);
          if (match) return `https://i.ytimg.com/vi/${match[1]}/hqdefault.jpg`;
        }
        return '';
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-neutral-950 text-neutral-200 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin w-8 h-8 border-2 border-white border-t-transparent rounded-full mx-auto mb-4"></div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="min-h-screen bg-neutral-950 text-neutral-200 flex items-center justify-center">
            <div className="text-center">
              <p className="text-red-400 mb-4">{error}</p>
              <button onClick={() => window.location.reload()} className="px-4 py-2 bg-white text-black rounded-lg">
                é‡æ–°è¼‰å…¥
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-neutral-950 text-neutral-200">
          {/* Header */}
          <header className="sticky top-0 z-40 border-b border-neutral-800 bg-neutral-950/90 backdrop-blur-md">
            <div className="max-w-6xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h1 className="text-xl font-semibold text-white">ğŸ“š Ray çš„å­¸ç¿’ç ”ç©¶åº«</h1>
                  <p className="text-neutral-500 text-sm mt-0.5">æŠŠè³‡è¨Šç„¦æ…®è½‰åŒ–ç‚ºç³»çµ±å­¸ç¿’</p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => window.location.reload()}
                    className="bg-neutral-800 text-white font-medium px-4 py-2 rounded-lg text-sm hover:bg-neutral-700 transition-colors"
                  >
                    ğŸ”„ åˆ·æ–°
                  </button>
                  <a
                    href="https://www.notion.so/76fb8600ae9649bcb6c475f75f0ec818"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="bg-white text-black font-medium px-4 py-2 rounded-lg text-sm hover:bg-neutral-200 transition-colors hidden sm:block"
                  >
                    Notion â†’
                  </a>
                </div>
              </div>

              {/* Tab åˆ‡æ› */}
              <div className="flex gap-1 mb-3 bg-neutral-900 rounded-lg p-1 w-fit">
                <button
                  onClick={() => setActiveTab("youtube")}
                  className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                    activeTab === "youtube"
                      ? "bg-neutral-700 text-white"
                      : "text-neutral-400 hover:text-white"
                  }`}
                >
                  ğŸ¬ YouTube Lab
                </button>
                <button
                  onClick={() => setActiveTab("resources")}
                  className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                    activeTab === "resources"
                      ? "bg-neutral-700 text-white"
                      : "text-neutral-400 hover:text-white"
                  }`}
                >
                  ğŸ“¦ Resource Library
                </button>
              </div>

              {/* Stats â€” åªåœ¨ YouTube tab é¡¯ç¤º */}
              {activeTab === "youtube" && <div className="flex gap-4 sm:gap-6 text-sm overflow-x-auto pb-2">
                <span className="text-neutral-400 whitespace-nowrap">ç¸½å…± <span className="text-white font-medium">{stats.total}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">å¾…çœ‹ <span className="text-white font-medium">{stats.pending}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">é€²è¡Œä¸­ <span className="text-white font-medium">{stats.inProgress}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">å·²å®Œæˆ <span className="text-white font-medium">{stats.completed}</span></span>
                <span className="text-neutral-400 whitespace-nowrap">å·²æ•´ç† <span className="text-white font-medium">{stats.summarized}</span></span>
                <button 
                  onClick={() => setShowSavedThumbnailsOnly(!showSavedThumbnailsOnly)}
                  className={`whitespace-nowrap transition-colors ${
                    showSavedThumbnailsOnly 
                      ? 'text-pink-400 font-medium' 
                      : 'text-neutral-400 hover:text-pink-400'
                  }`}
                >
                  â¤ï¸ ç¸®åœ–æ”¶è— <span className={showSavedThumbnailsOnly ? 'text-pink-400' : 'text-white font-medium'}>{stats.thumbnailSaved}</span>
                </button>
              </div>}
            </div>
          </header>

          {/* YouTube Tab å…§å®¹ */}
          {activeTab === "youtube" && (
            <>
              <main className="max-w-6xl mx-auto px-4 py-4">
                {/* Filters */}
                <div className="flex flex-col gap-3 mb-6">
                  {/* ç¬¬ä¸€åˆ—ï¼šæœå°‹ + åˆ†é¡ + ç‹€æ…‹ */}
                  <div className="flex flex-col sm:flex-row gap-3">
                    <input
                      type="text"
                      placeholder="æœå°‹..."
                      value={searchQuery}
                      onChange={e => setSearchQuery(e.target.value)}
                      className="w-full sm:w-48 px-4 py-2 rounded-lg border border-neutral-800 bg-neutral-900 text-neutral-200 text-sm outline-none focus:border-neutral-600 transition-colors placeholder-neutral-600"
                    />

                    <div className="flex gap-1 overflow-x-auto pb-2 sm:pb-0">
                      {categories.map(cat => (
                        <button
                          key={cat}
                          onClick={() => setSelectedCategory(cat)}
                          className={`px-3 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${
                            selectedCategory === cat
                              ? 'bg-white text-black font-medium'
                              : 'text-neutral-400 hover:text-white'
                          }`}
                        >
                          {cat}
                        </button>
                      ))}
                    </div>

                    <div className="hidden sm:block h-4 w-px bg-neutral-800 self-center"></div>

                    <div className="flex gap-1 overflow-x-auto pb-2 sm:pb-0">
                      {statuses.map(status => (
                        <button
                          key={status}
                          onClick={() => setSelectedStatus(status)}
                          className={`px-3 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${
                            selectedStatus === status
                              ? 'bg-neutral-800 text-white font-medium'
                              : 'text-neutral-400 hover:text-white'
                          }`}
                        >
                          {status}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* ç¬¬äºŒåˆ—ï¼šæ˜Ÿè™Ÿç¯©é¸ + ç¯©é¸è¨ˆæ•¸ + æ¸…é™¤ */}
                  <div className="flex flex-wrap items-center gap-3">
                    <span className="text-xs text-neutral-500">è©•åˆ†</span>
                    <div className="flex gap-1">
                      {[1, 2, 3, 4, 5].map(star => (
                        <button
                          key={star}
                          onClick={() => setSelectedRatings(prev =>
                            prev.includes(star) ? prev.filter(s => s !== star) : [...prev, star]
                          )}
                          className={`px-2.5 py-1.5 rounded-md text-sm whitespace-nowrap transition-colors ${
                            selectedRatings.includes(star)
                              ? 'bg-yellow-500/20 text-yellow-400 font-medium border border-yellow-500/40'
                              : 'text-neutral-400 hover:text-yellow-400'
                          }`}
                        >
                          {star}â˜…
                        </button>
                      ))}
                    </div>

                    <div className="hidden sm:block h-4 w-px bg-neutral-800"></div>

                    <span className="text-sm text-neutral-500">
                      å…± <span className="text-white font-medium">{filteredVideos.length}</span> éƒ¨
                    </span>

                    {(selectedCategory !== "å…¨éƒ¨" || selectedStatus !== "å…¨éƒ¨" || searchQuery || showSavedThumbnailsOnly || selectedRatings.length > 0) && (
                      <button
                        onClick={() => {
                          setSelectedCategory("å…¨éƒ¨");
                          setSelectedStatus("å…¨éƒ¨");
                          setSearchQuery("");
                          setShowSavedThumbnailsOnly(false);
                          setSelectedRatings([]);
                        }}
                        className="px-3 py-1.5 rounded-md text-sm text-red-400 hover:bg-red-500/10 transition-colors"
                      >
                        âœ• æ¸…é™¤ç¯©é¸
                      </button>
                    )}
                  </div>
                </div>

                {/* Video Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {filteredVideos.map(video => (
                    <VideoCard
                      key={video.id}
                      video={video}
                      getThumbnail={getThumbnail}
                      onOpenModal={setSelectedVideo}
                    />
                  ))}
                </div>

                {filteredVideos.length === 0 && !loading && (
                  <div className="text-center py-16">
                    <p className="text-neutral-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å½±ç‰‡</p>
                  </div>
                )}
              </main>

              {/* Telegram Hint */}
              <a
                href="https://t.me/YT_video_DB_bot"
                target="_blank"
                rel="noopener noreferrer"
                className="fixed bottom-6 right-6 bg-neutral-800 hover:bg-neutral-700 rounded-full px-4 py-2 flex items-center gap-2 transition-colors border border-neutral-700"
              >
                <span>âœˆï¸</span>
                <span className="text-sm text-neutral-300">æ–°å¢å½±ç‰‡</span>
              </a>
            </>
          )}

          {/* Resource Library Tab å…§å®¹ */}
          {activeTab === "resources" && <ResourceLibrary />}

          {/* Video Modal */}
          {selectedVideo && (
            <VideoModal 
              video={selectedVideo}
              onClose={() => setSelectedVideo(null)}
              onUpdate={handleVideoUpdate}
              onDelete={handleVideoDelete}
              getThumbnail={getThumbnail}
            />
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
